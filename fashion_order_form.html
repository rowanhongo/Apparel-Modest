<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Place Your Order</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
            position: relative;
        }

        /* Prevent horizontal overflow for all elements */
        img, video, iframe, embed, object {
            max-width: 100%;
            height: auto;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
            overflow: hidden;
        }

        .header {
            background: #1B4D3E;
            color: white;
            padding: 40px 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .company-logo {
            margin-bottom: 24px;
            position: relative;
            z-index: 1;
        }

        .company-logo-top {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            font-size: 28px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .company-logo-divider {
            width: 80px;
            height: 1px;
            background: white;
            margin: 8px auto;
        }

        .company-logo-bottom {
            font-family: Georgia, 'Times New Roman', serif;
            font-size: 32px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
        }

        .header h1 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
            position: relative;
            z-index: 1;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
            font-weight: 400;
            position: relative;
            z-index: 1;
            color: white;
        }

        .form-content {
            padding: 50px 40px;
        }

        .form-group {
            margin-bottom: 32px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            letter-spacing: 0.3px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px 18px;
            border: 1.5px solid rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Style select dropdown arrow */
        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234a5568' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 12px;
            padding-right: 40px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #fda085;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 20px rgba(253, 160, 133, 0.15), 0 0 0 3px rgba(253, 160, 133, 0.1);
            transform: translateY(-1px);
        }

        .search-container {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1.5px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            margin-top: 6px;
            max-height: 320px;
            overflow-y: auto;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
            z-index: 1000;
            display: none;
            pointer-events: auto;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            user-select: none;
            -webkit-user-select: none;
            pointer-events: auto;
        }

        .search-result-item:hover {
            background: linear-gradient(90deg, rgba(246, 211, 101, 0.1) 0%, rgba(253, 160, 133, 0.1) 100%);
            transform: translateX(4px);
        }

        .result-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 14px;
            background: rgba(0, 0, 0, 0.02);
        }

        .result-info {
            flex: 1;
        }

        .result-name {
            font-size: 15px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 3px;
        }

        .result-price {
            font-size: 14px;
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .selected-product {
            display: none;
            background: linear-gradient(135deg, rgba(246, 211, 101, 0.15) 0%, rgba(253, 160, 133, 0.15) 100%);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-top: 16px;
            align-items: center;
            border: 1px solid rgba(253, 160, 133, 0.2);
            position: relative;
        }

        .selected-product.active {
            display: flex;
        }

        .selected-product-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: 1.5px solid rgba(0, 0, 0, 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .selected-product-close:hover {
            background: rgba(253, 160, 133, 0.2);
            border-color: #fda085;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(253, 160, 133, 0.3);
        }

        .selected-product-close svg {
            width: 18px;
            height: 18px;
            stroke: #2d3748;
            stroke-width: 2.5;
            stroke-linecap: round;
        }

        .selected-product-close:hover svg {
            stroke: #fda085;
        }

        .selected-product-image {
            width: 90px;
            height: 90px;
            object-fit: cover;
            border-radius: 12px;
            margin-right: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .selected-product-info h3 {
            font-size: 17px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 6px;
        }

        .selected-product-info p {
            font-size: 16px;
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .selected-product-description {
            font-size: 14px !important;
            color: rgba(45, 55, 72, 0.75) !important;
            font-weight: 400 !important;
            line-height: 1.6 !important;
            margin-top: 10px !important;
            padding-top: 10px !important;
            border-top: 1px solid rgba(0, 0, 0, 0.08) !important;
            -webkit-background-clip: unset !important;
            -webkit-text-fill-color: rgba(45, 55, 72, 0.75) !important;
            background-clip: unset !important;
            background: none !important;
        }

        .selected-product-description:empty {
            display: none;
        }

        .color-options {
            display: none;
            margin-top: 16px;
        }

        .color-options.active {
            display: block;
        }

        .selected-color-display {
            margin-bottom: 16px;
            padding: 12px 18px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1.5px solid rgba(0, 0, 0, 0.08);
            font-size: 15px;
            font-weight: 600;
            color: #2d3748;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .selected-color-display:empty::before {
            content: "Select a color";
            color: #718096;
            font-weight: 400;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 12px;
            margin-top: 10px;
            justify-items: center;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid rgba(0, 0, 0, 0.1);
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .color-option:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .color-option.selected {
            border-color: #fda085;
            border-width: 4px;
            box-shadow: 0 4px 20px rgba(253, 160, 133, 0.5);
            transform: scale(1.1);
        }

        /* Tooltip */
        .color-option[data-tooltip] {
            position: relative;
        }

        .color-option[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 12px;
            font-weight: 500;
            border-radius: 6px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .color-option[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 2px;
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.85);
            pointer-events: none;
            z-index: 1000;
        }

        .custom-size-input {
            margin-top: 12px;
        }

        .custom-size-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 12px;
        }

        .custom-size-field {
            display: flex;
            flex-direction: column;
        }

        .custom-size-field label {
            font-size: 13px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .custom-size-field input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .custom-size-field input:focus {
            outline: none;
            border-color: #fda085;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 20px rgba(253, 160, 133, 0.15), 0 0 0 3px rgba(253, 160, 133, 0.1);
        }

        .custom-size-field input:invalid {
            border-color: #fc8181;
        }

        .clothing-type-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .clothing-option {
            padding: 14px;
            border: 1.5px solid rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 15px;
            font-weight: 500;
            color: #4a5568;
        }

        .clothing-option:hover {
            border-color: #fda085;
            background: rgba(253, 160, 133, 0.1);
            transform: translateY(-2px);
        }

        .clothing-option.selected {
            border-color: #fda085;
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(253, 160, 133, 0.4);
        }

        .measurement-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .measurement-fields {
            display: none;
        }

        .measurement-fields.active {
            display: contents;
        }

        textarea {
            min-height: 110px;
            resize: vertical;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            background: #1B4D3E;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 16px;
            box-shadow: 0 6px 20px rgba(27, 77, 62, 0.3);
            letter-spacing: 0.5px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            background: #1a5a47;
            box-shadow: 0 10px 30px rgba(27, 77, 62, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .no-results {
            padding: 24px;
            text-align: center;
            color: #718096;
            font-size: 14px;
        }

        .required {
            color: #fc8181;
            margin-left: 2px;
        }

        .size-chart {
            margin: 20px 0;
            background: #ffffff;
            border-radius: 12px;
            padding: 24px;
            border: 1.5px solid rgba(0, 0, 0, 0.08);
        }

        .size-chart-title {
            font-size: 24px;
            font-weight: 700;
            font-style: italic;
            color: #000000;
            margin-bottom: 16px;
            text-align: center;
        }

        .size-chart-divider {
            width: 100%;
            height: 1px;
            background: #000;
            margin-bottom: 12px;
        }

        .size-chart-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .size-chart-table th {
            padding: 12px 8px;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
            color: #000000;
            border-bottom: 2px solid rgba(0, 0, 0, 0.1);
        }

        .size-chart-table td {
            padding: 12px 8px;
            font-size: 14px;
            color: #000000;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .size-chart-table tr:last-child td {
            border-bottom: none;
        }

        .size-chart-table tr:hover {
            background: rgba(253, 160, 133, 0.05);
        }

            @media (max-width: 640px) {
            .measurement-grid {
                grid-template-columns: 1fr;
            }

            .custom-size-grid {
                grid-template-columns: 1fr;
            }

            .form-content {
                padding: 40px 30px;
            }

            .header {
                padding: 30px 20px 20px;
            }

            .company-logo-top {
                font-size: 22px;
                letter-spacing: 1.5px;
            }

            .company-logo-bottom {
                font-size: 26px;
                letter-spacing: 0.5px;
            }

            .company-logo-divider {
                width: 60px;
            }

            .header h1 {
                font-size: 28px;
            }

            .header p {
                font-size: 14px;
            }

            .clothing-type-selector {
                grid-template-columns: 1fr;
            }

            .color-grid {
                grid-template-columns: repeat(auto-fill, minmax(38px, 1fr));
                gap: 10px;
            }

            .color-option {
                width: 38px;
                height: 38px;
            }

            /* Make select boxes smaller and more compact on mobile */
            .form-group select {
                padding: 10px 12px;
                padding-right: 36px;
                font-size: 14px;
                border-radius: 8px;
                background-size: 10px;
                background-position: right 12px center;
                min-height: 42px;
                line-height: 1.4;
            }

            /* Make inputs smaller on mobile too for consistency */
            .form-group input,
            .form-group textarea {
                padding: 10px 12px;
                font-size: 14px;
                border-radius: 8px;
                min-height: 42px;
            }

            /* Style select options on mobile - make them more compact */
            .form-group select option {
                padding: 10px 12px;
                font-size: 14px;
                line-height: 1.5;
            }

            /* Fix body padding on mobile to prevent overflow */
            body {
                padding: 10px !important;
            }

            /* Ensure container doesn't overflow */
            .container {
                margin: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 16px;
            }

            /* Prevent horizontal overflow */
            body, html {
                overflow-x: hidden !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            /* Ensure all form elements fit */
            .form-content {
                padding: 30px 20px !important;
            }

            .header {
                padding: 30px 20px !important;
            }

            /* Ensure all inputs and elements respect viewport */
            input, textarea, select, button, .container, .form-group {
                max-width: 100% !important;
                box-sizing: border-box;
            }

            /* Fix search results positioning */
            .search-results {
                max-width: calc(100vw - 20px) !important;
            }

            /* Map container mobile */
            #mapContainer {
                height: 300px !important;
            }

            #locationSuggestions {
                max-width: calc(100vw - 20px) !important;
            }
        }

        /* Map and location picker styles */
        #mapContainer {
            position: relative;
            width: 100%;
            height: 400px;
        }

        #map {
            width: 100% !important;
            height: 100% !important;
            z-index: 1;
        }

        /* Ensure Leaflet map tiles render properly */
        .leaflet-container {
            width: 100% !important;
            height: 100% !important;
            background: #f0f0f0 !important;
            font-family: inherit !important;
        }

        .leaflet-tile-container {
            visibility: visible !important;
            opacity: 1 !important;
        }

        .leaflet-tile {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        .leaflet-pane {
            z-index: 400 !important;
        }

        .leaflet-map-pane {
            z-index: 400 !important;
        }

        .leaflet-tile-pane {
            z-index: 200 !important;
        }

        .leaflet-overlay-pane {
            z-index: 400 !important;
        }

        .leaflet-marker-pane {
            z-index: 600 !important;
        }

        .leaflet-popup-pane {
            z-index: 700 !important;
        }

        /* Fix for Leaflet controls */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        }

        .leaflet-control-zoom a {
            background-color: white !important;
            color: #2d3748 !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
        }

        .leaflet-control-zoom a:hover {
            background-color: #f7f7f7 !important;
        }

        .location-suggestion:hover {
            background: rgba(246, 211, 101, 0.15) !important;
        }

        #locationSuggestions {
            max-height: 250px;
        }

        #locationSuggestions::-webkit-scrollbar {
            width: 6px;
        }

        #locationSuggestions::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        #locationSuggestions::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        #locationSuggestions::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="company-logo">
                <div class="company-logo-top">APPAREL</div>
                <div class="company-logo-divider"></div>
                <div class="company-logo-bottom">MODEST</div>
            </div>
            <h1>Place Your Order</h1>
            <p>Find your perfect piece and let us create it for you</p>
        </div>

        <form class="form-content" id="orderForm">
            <div class="form-group">
                <label for="name">Full Name <span class="required">*</span></label>
                <input type="text" id="name" required placeholder="Enter your full name">
            </div>

            <div class="form-group">
                <label for="email">Email Address <span class="required">*</span></label>
                <input type="email" id="email" required placeholder="Enter your email address">
            </div>

            <div class="form-group">
                <label>WhatsApp Number <span class="required">*</span></label>
                <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">
                    <div>
                        <input type="tel" id="countryCode" required placeholder="+254" maxlength="4" style="text-align: center;">
                        <small style="display: block; margin-top: 4px; font-size: 12px; color: #718096; text-align: center;">Country Code</small>
                    </div>
                    <div>
                        <input type="tel" id="phoneNumber" required placeholder="0712345678" maxlength="15">
                        <small style="display: block; margin-top: 4px; font-size: 12px; color: #718096;">Phone Number</small>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="productSearch">Search Item <span class="required">*</span></label>
                <div class="search-container">
                    <input type="text" id="productSearch" placeholder="Type to search items..." autocomplete="off">
                    <div class="search-results" id="searchResults"></div>
                </div>
                
                <div class="selected-product" id="selectedProduct">
                    <button type="button" class="selected-product-close" id="clearProductBtn" aria-label="Clear selection">
                        <svg viewBox="0 0 24 24" fill="none">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                    <img src="" alt="" class="selected-product-image" id="selectedImage">
                    <div class="selected-product-info">
                        <h3 id="selectedName"></h3>
                        <p id="selectedPrice"></p>
                    </div>
                </div>
            </div>

            <div class="form-group color-options" id="colorOptions">
                <label>Select Color <span class="required">*</span></label>
                <div class="selected-color-display" id="selectedColorDisplay"></div>
                <div class="color-grid" id="colorGrid"></div>
            </div>

            <div class="form-group">
                <label for="bodyMeasurements">Body Measurements <span class="required">*</span></label>
                <div class="size-chart">
                    <div class="size-chart-title">Size Chart</div>
                    <div class="size-chart-divider"></div>
                    <table class="size-chart-table">
                        <thead>
                            <tr>
                                <th>A/M</th>
                                <th>SIZE</th>
                                <th>BUST</th>
                                <th>WAIST</th>
                                <th>HIPS</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>SS</td>
                                <td>6</td>
                                <td>32</td>
                                <td>25</td>
                                <td>36</td>
                            </tr>
                            <tr>
                                <td>S</td>
                                <td>8</td>
                                <td>34</td>
                                <td>27</td>
                                <td>39</td>
                            </tr>
                            <tr>
                                <td>SM</td>
                                <td>10</td>
                                <td>36</td>
                                <td>30</td>
                                <td>41</td>
                            </tr>
                            <tr>
                                <td>M</td>
                                <td>12</td>
                                <td>38</td>
                                <td>32</td>
                                <td>43</td>
                            </tr>
                            <tr>
                                <td>SL</td>
                                <td>14</td>
                                <td>40</td>
                                <td>34</td>
                                <td>45</td>
                            </tr>
                            <tr>
                                <td>L</td>
                                <td>16</td>
                                <td>44</td>
                                <td>36</td>
                                <td>48</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <select id="bodyMeasurements" required>
                    <option value="">Select your size</option>
                    <option value="SS">SS 6, 32, 25, 36</option>
                    <option value="S">S 8, 34, 27, 39</option>
                    <option value="SM">SM 10, 36, 30, 41</option>
                    <option value="M">M 12, 38, 32, 43</option>
                    <option value="SL">SL 14, 40, 34, 45</option>
                    <option value="L">L 16, 44, 36, 48</option>
                    <option value="custom">Custom Size (Enter your own measurements)</option>
                </select>
                <div class="custom-size-input" id="customSizeInput" style="display: none;">
                    <div class="custom-size-grid">
                        <div class="custom-size-field">
                            <label for="customSize">Size <span class="required">*</span></label>
                            <input type="number" id="customSize" min="0" step="1" placeholder="e.g., 14" required>
                        </div>
                        <div class="custom-size-field">
                            <label for="customBust">Bust <span class="required">*</span></label>
                            <input type="number" id="customBust" min="0" step="1" placeholder="e.g., 42" required>
                        </div>
                        <div class="custom-size-field">
                            <label for="customWaist">Waist <span class="required">*</span></label>
                            <input type="number" id="customWaist" min="0" step="1" placeholder="e.g., 34" required>
                        </div>
                        <div class="custom-size-field">
                            <label for="customHips">Hips <span class="required">*</span></label>
                            <input type="number" id="customHips" min="0" step="1" placeholder="e.g., 46" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="deliveryOption">Preferred Choice of Delivery <span class="required">*</span></label>
                <select id="deliveryOption" required>
                    <option value="">Select delivery option</option>
                    <option value="uber">Uber</option>
                    <option value="pickup-mtaani">Pick Up Mtaani</option>
                    <option value="courier">Courier</option>
                    <option value="in-store-pickup">In Store Pick Up</option>
                </select>
                <div class="custom-size-input" id="deliveryLocationInput" style="display: none;">
                    <div style="margin-bottom: 12px;">
                        <label for="locationSearch" style="display: block; font-size: 14px; font-weight: 600; color: #2d3748; margin-bottom: 8px;">
                            Search for Location in Kenya
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="locationSearch" placeholder="Type a place name (e.g., Nairobi, Mombasa, Westlands...)" 
                                   style="width: 100%; padding: 12px 16px; border: 1.5px solid rgba(0, 0, 0, 0.08); background: rgba(255, 255, 255, 0.9); border-radius: 10px; font-size: 14px;">
                            <div id="locationSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1.5px solid rgba(0, 0, 0, 0.08); border-radius: 10px; margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);"></div>
                        </div>
                    </div>
                    <div id="mapContainer" style="width: 100%; height: 400px; border-radius: 12px; border: 1.5px solid rgba(0, 0, 0, 0.08); margin-top: 12px; position: relative; overflow: hidden; background: #f0f0f0;">
                        <div id="map" style="width: 100% !important; height: 100% !important; min-height: 400px;"></div>
                        <div id="mapLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.95); padding: 12px 20px; border-radius: 8px; font-size: 14px; color: #2d3748; z-index: 1000; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                            Loading map...
                        </div>
                    </div>
                    <div id="selectedLocationInfo" style="margin-top: 12px; padding: 12px; background: rgba(27, 77, 62, 0.1); border-radius: 10px; border: 1px solid rgba(27, 77, 62, 0.2); display: none;">
                        <div style="font-size: 13px; color: #2d3748; font-weight: 400; margin-bottom: 4px;">Selected Location:</div>
                        <div id="selectedLocationText" style="font-size: 13px; color: #4a5568; font-weight: 400;"></div>
                    </div>
                    <!-- Hidden inputs to store location data -->
                    <input type="hidden" id="deliveryLatitude">
                    <input type="hidden" id="deliveryLongitude">
                    <input type="hidden" id="deliveryDisplayName">
                </div>
                <div class="custom-size-input" id="storeLocationMessage" style="display: none;">
                    <p style="margin-top: 12px; padding: 14px 18px; background: rgba(27, 77, 62, 0.1); border-radius: 12px; border: 1px solid rgba(27, 77, 62, 0.2); color: #2d3748; font-size: 14px; font-weight: 400;">The store is opposite Jevanjee, Muindi Mbingu street, next to delight college.</p>
                </div>
            </div>

            <div class="form-group">
                <label>Payment Method</label>
                <div style="padding: 14px 18px; background: rgba(27, 77, 62, 0.1); border-radius: 12px; border: 1px solid rgba(27, 77, 62, 0.2);">
                    <p style="margin: 0; font-size: 15px; font-weight: 400; color: #2d3748; margin-bottom: 8px;">
                        üí≥ Payment Facilitated by Paystack
                    </p>
                    <p style="margin: 0; font-size: 13px; color: #718096; line-height: 1.6; font-weight: 400;">
                        Available payment methods: M-Pesa, Airtel Money, Visa/Mastercard, Bank Transfer, Apple Pay, and more.<br>
                        You'll see all available options when you click "Submit Order".
                    </p>
                </div>
            </div>

            <div class="form-group">
                <label for="comments">Additional Comments</label>
                <textarea id="comments" placeholder="Any special requests or preferences..."></textarea>
            </div>

            <button type="submit" class="submit-btn">Submit Order</button>
        </form>
    </div>

    <!-- Leaflet.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet.js JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Paystack Inline JS -->
    <script src="https://js.paystack.co/v1/inline.js"></script>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Environment Configuration Loader -->
    <script src="config/env-loader.js"></script>
    <script>
        // Load environment variables from Netlify function
        // This must complete before other scripts initialize
        (async function() {
            try {
                await loadEnvConfig();
                console.log('‚úÖ All environment variables loaded');
            } catch (error) {
                console.error('‚ùå Failed to load environment variables:', error);
                alert('‚ö†Ô∏è Configuration error. Please check your Netlify environment variables.');
            }
        })();
    </script>
    <script src="config/supabase.js"></script>

    <script>
        // Products will be loaded from Supabase
        let products = [];
        let supabaseClient = null;
        
        // Paystack configuration
        const PAYSTACK_PUBLIC_KEY = 'pk_test_115cbba775975d9fe966d516d1dea9ea0bfa91be';
        
        // Payment state
        let paymentCompleted = false;
        let paymentReference = null;

        // Wait for Supabase library and environment variables to be available
        async function waitForSupabase(callback, maxAttempts = 50) {
            // First, wait for environment config to be loaded
            try {
                if (typeof window.waitForEnvConfig === 'function') {
                    await window.waitForEnvConfig();
                    console.log('‚úÖ Environment config loaded, checking Supabase...');
                } else if (typeof window.loadEnvConfig === 'function') {
                    await window.loadEnvConfig();
                    console.log('‚úÖ Environment config loaded via loadEnvConfig, checking Supabase...');
                } else {
                    // Fallback: wait for env config to be available
                    let envAttempts = 0;
                    while (!window.ENV_CONFIG_LOADED && envAttempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        envAttempts++;
                    }
                    if (window.ENV_CONFIG_LOADED) {
                        console.log('‚úÖ Environment config loaded (via flag), checking Supabase...');
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error loading environment config:', error);
                // Continue anyway, might still work if env vars are set
            }
            
            // Now wait for Supabase library to be available
            let attempts = 0;
            const checkSupabase = () => {
                attempts++;
                if (typeof supabase !== 'undefined' && typeof getSupabaseClient === 'function') {
                    // Also verify environment variables are set
                    if (window.SUPABASE_URL && window.SUPABASE_ANON_KEY) {
                        callback();
                    } else if (attempts < maxAttempts) {
                        setTimeout(checkSupabase, 100);
                    } else {
                        console.error('‚ùå Supabase credentials not available after environment config loaded');
                        console.error('   SUPABASE_URL:', window.SUPABASE_URL ? 'Set ‚úì' : 'Missing ‚ùå');
                        console.error('   SUPABASE_ANON_KEY:', window.SUPABASE_ANON_KEY ? 'Set ‚úì' : 'Missing ‚ùå');
                    }
                } else if (attempts < maxAttempts) {
                    setTimeout(checkSupabase, 100);
                } else {
                    console.error('‚ùå Supabase library failed to load after multiple attempts');
                }
            };
            checkSupabase();
        }

        let selectedProduct = null;
        let selectedColor = null;

        const searchInput = document.getElementById('productSearch');
        const searchResults = document.getElementById('searchResults');
        const selectedProductDiv = document.getElementById('selectedProduct');
        const colorOptionsDiv = document.getElementById('colorOptions');
        const colorGrid = document.getElementById('colorGrid');

        // Initialize Supabase and load products
        async function initializeSupabase() {
            try {
                // Get Supabase client (Supabase library is guaranteed to be loaded by now)
                supabaseClient = getSupabaseClient();
                if (!supabaseClient) {
                    console.error('‚ùå Failed to initialize Supabase client');
                    return;
                }

                // Verify client has the .from method
                if (typeof supabaseClient.from !== 'function') {
                    console.error('‚ùå Supabase client is not valid. Client:', supabaseClient);
                    return;
                }

                console.log('‚úÖ Supabase initialized');
                await loadProductsFromDatabase();
            } catch (error) {
                console.error('Error initializing Supabase:', error);
            }
        }

        // Load products from Supabase database
        async function loadProductsFromDatabase() {
            try {
                const { data: productsData, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .order('name', { ascending: true });

                if (error) {
                    console.error('Error loading products:', error);
                    // Fallback to empty array
                    products = [];
                    return;
                }

                // Transform Supabase products to match expected format
                products = (productsData || []).map(product => {
                    // Parse colors if stored as JSON or comma-separated string
                    let colors = [];
                    if (product.colors) {
                        if (typeof product.colors === 'string') {
                            try {
                                colors = JSON.parse(product.colors);
                            } catch (e) {
                                // If not JSON, try splitting by comma
                                colors = product.colors.split(',').map(c => c.trim()).filter(c => c);
                            }
                        } else if (Array.isArray(product.colors)) {
                            colors = product.colors;
                        }
                    }

                    // Default colors if none specified
                    if (colors.length === 0) {
                        colors = ['Black', 'White', 'Red', 'Blue'];
                    }

                    // Keep ID as string (UUID) - don't convert to number
                    const productId = String(product.id);

                    return {
                        id: productId,
                        name: product.name || 'Unknown Product',
                        price: product.price || 0,
                        image: product.image_url || 'https://via.placeholder.com/400',
                        description: product.description || '',
                        colors: colors
                    };
                });
                
                // Log products with their IDs for debugging
                console.log('Products loaded with IDs:', products.map(p => ({ id: p.id, name: p.name, idType: typeof p.id })));

                console.log(`‚úÖ Loaded ${products.length} products from database`);
            } catch (error) {
                console.error('Error loading products:', error);
                products = [];
            }
        }

        // Use event delegation on searchResults container (set up once)
        searchResults.addEventListener('click', (e) => {
            const item = e.target.closest('.search-result-item');
            if (item) {
                e.preventDefault();
                e.stopPropagation();
                const productId = String(item.dataset.id); // Keep as string (UUID)
                console.log('Product clicked:', productId, 'Type:', typeof productId);
                selectProduct(productId);
            }
        });

        // Function to clear selected product
        function clearSelectedProduct() {
            selectedProduct = null;
            selectedColor = null;
            searchInput.value = '';
            selectedProductDiv.classList.remove('active');
            colorOptionsDiv.classList.remove('active');
            document.getElementById('selectedColorDisplay').textContent = '';
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Set up clear button event listener
            const clearBtn = document.getElementById('clearProductBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    clearSelectedProduct();
                });
            }

            // Wait for Supabase library and environment variables to be fully loaded
            await waitForSupabase(() => {
                initializeSupabase();
            });
        });

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            if (query.length === 0) {
                searchResults.classList.remove('active');
                return;
            }
            const filtered = products.filter(p => p.name.toLowerCase().includes(query));
            displaySearchResults(filtered);
        });

        function displaySearchResults(results) {
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="no-results">No items found</div>';
                searchResults.classList.add('active');
                return;
            }
            searchResults.innerHTML = results.map(product => `
                <div class="search-result-item" data-id="${product.id}">
                    <img src="${product.image}" alt="${product.name}" class="result-image">
                    <div class="result-info">
                        <div class="result-name">${product.name}</div>
                        <div class="result-price">KES ${product.price.toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
            searchResults.classList.add('active');
        }

        function selectProduct(productId) {
            console.log('selectProduct called with ID:', productId, 'Type:', typeof productId);
            console.log('Available products:', products.map(p => ({ id: p.id, name: p.name, idType: typeof p.id })));
            
            // Keep productId as string (UUID) - don't convert to number
            const idString = String(productId);
            
            // Find product by string comparison
            selectedProduct = products.find(p => String(p.id) === idString);
            
            if (!selectedProduct) {
                console.error('Product not found with ID:', idString);
                console.error('Available product IDs:', products.map(p => p.id));
                alert('Product not found. Please try searching again.');
                return;
            }
            
            console.log('Selected product:', selectedProduct);
            
            searchInput.value = selectedProduct.name;
            searchResults.classList.remove('active');
            document.getElementById('selectedImage').src = selectedProduct.image;
            document.getElementById('selectedName').textContent = selectedProduct.name;
            document.getElementById('selectedPrice').textContent = `KES ${selectedProduct.price.toLocaleString()}`;
            
            selectedProductDiv.classList.add('active');
            
            // Always show all color options when a product is selected
            displayColorOptions();
        }

        // Color mapping with hex values
        const colorMap = {
            'Red': '#DC2626',
            'Bright orange': '#FF8C00',
            'Burnt orange': '#CC5500',
            'Emerald green': '#50C878',
            'Lilac': '#C8A2C8',
            'Black': '#000000',
            'White': '#FFFFFF',
            'Fuschia': '#FF1493',
            'Sage green': '#87AE73',
            'Maroon': '#800000',
            'Burgundy': '#800020',
            'Hot pink': '#FF69B4',
            'Baby pink': '#FFB6C1',
            'Chocolate brown': '#7B3F00',
            'Beige': '#F5F5DC',
            'Mustard yellow': '#FFDB58',
            'Royal blue': '#4169E1',
            'Navy blue': '#000080',
            'Blackcurrant': '#2E1837',
            'Royal purple': '#7851A9',
            'Teal Blue': '#008080'
        };

        function displayColorOptions(colors) {
            // Clear previous selection
            selectedColor = null;
            document.getElementById('selectedColorDisplay').textContent = '';
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
            
            // Display ALL colors from colorMap, not just product colors
            const allColors = Object.keys(colorMap);
            
            colorGrid.innerHTML = allColors.map(colorName => {
                const hexColor = colorMap[colorName];
                
                // For white, add a border to make it visible
                const borderStyle = colorName.toLowerCase() === 'white' 
                    ? 'border: 3px solid rgba(0, 0, 0, 0.2);' 
                    : '';
                
                return `
                    <div class="color-option" 
                         data-color="${colorName}" 
                         data-tooltip="${colorName}"
                         style="background-color: ${hexColor}; ${borderStyle}">
                    </div>
                `;
            }).join('');
            
            colorOptionsDiv.classList.add('active');
            
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedColor = option.dataset.color;
                    
                    // Update selected color display
                    const selectedColorDisplay = document.getElementById('selectedColorDisplay');
                    selectedColorDisplay.textContent = `Colour: ${selectedColor}`;
                });
            });
        }

        // Body measurements dropdown - show custom input if custom is selected
        document.getElementById('bodyMeasurements').addEventListener('change', function() {
            const customInput = document.getElementById('customSizeInput');
            const customSize = document.getElementById('customSize');
            const customBust = document.getElementById('customBust');
            const customWaist = document.getElementById('customWaist');
            const customHips = document.getElementById('customHips');
            
            if (this.value === 'custom') {
                customInput.style.display = 'block';
                customSize.required = true;
                customBust.required = true;
                customWaist.required = true;
                customHips.required = true;
            } else {
                customInput.style.display = 'none';
                customSize.required = false;
                customBust.required = false;
                customWaist.required = false;
                customHips.required = false;
                customSize.value = '';
                customBust.value = '';
                customWaist.value = '';
                customHips.value = '';
            }
        });

        // Ensure only numbers can be entered in custom size fields
        ['customSize', 'customBust', 'customWaist', 'customHips'].forEach(id => {
            const field = document.getElementById(id);
            field.addEventListener('input', function(e) {
                // Remove any non-numeric characters
                this.value = this.value.replace(/[^0-9]/g, '');
            });
            
            field.addEventListener('keypress', function(e) {
                // Prevent non-numeric characters from being typed
                if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                }
            });
        });

        // Ensure only text (letters, spaces, hyphens, apostrophes) can be entered in name field
        const nameField = document.getElementById('name');
        nameField.addEventListener('input', function(e) {
            // Remove any non-text characters (keep only letters, spaces, hyphens, apostrophes, and periods)
            this.value = this.value.replace(/[^a-zA-Z\s\-'\.]/g, '');
        });
        
        nameField.addEventListener('keypress', function(e) {
            // Prevent non-text characters from being typed
            const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
            if (!/[a-zA-Z\s\-'\.]/.test(e.key) && !allowedKeys.includes(e.key)) {
                e.preventDefault();
            }
        });

        // Country code field - only digits, auto-add + prefix
        const countryCodeField = document.getElementById('countryCode');
        countryCodeField.addEventListener('input', function(e) {
            // Remove any non-numeric characters
            let value = this.value.replace(/[^0-9]/g, '');
            // Auto-add + prefix if not present
            if (value && !this.value.startsWith('+')) {
                this.value = '+' + value;
            } else if (!value) {
                this.value = '+';
            } else {
                this.value = '+' + value;
            }
        });
        
        countryCodeField.addEventListener('keypress', function(e) {
            // Allow + only at the start, then only digits
            const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
            if (this.value === '+' && e.key === '+') {
                e.preventDefault();
                return;
            }
            if (!/[0-9]/.test(e.key) && !allowedKeys.includes(e.key)) {
                e.preventDefault();
            }
        });

        // Phone number field - only digits
        const phoneNumberField = document.getElementById('phoneNumber');
        phoneNumberField.addEventListener('input', function(e) {
            // Remove any non-numeric characters
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        
        phoneNumberField.addEventListener('keypress', function(e) {
            // Prevent non-numeric characters from being typed
            const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
            if (!/[0-9]/.test(e.key) && !allowedKeys.includes(e.key)) {
                e.preventDefault();
            }
        });

        // Initialize country code with + on focus
        countryCodeField.addEventListener('focus', function() {
            if (!this.value) {
                this.value = '+';
            }
        });

        // Map and location picker variables
        let map = null;
        let marker = null;
        let locationSearchTimeout = null;
        let mapInitialized = false;
        let selectedLocation = {
            lat: null,
            lng: null,
            displayName: null
        };

        // Pre-initialize map on page load (hidden) for faster loading
        function preInitializeMap() {
            if (mapInitialized || typeof L === 'undefined') {
                return;
            }

            try {
                const mapElement = document.getElementById('map');
                if (!mapElement) return;

                // Initialize map in background (container is hidden)
                map = L.map('map', {
                    zoomControl: false, // Disable controls initially for faster load
                    attributionControl: false,
                    preferCanvas: false,
                    fadeAnimation: false, // Disable fade for faster rendering
                    zoomAnimation: false // Disable zoom animation for faster response
                }).setView([-1.2921, 36.8219], 6);

                // Use lighter, faster tile set
                const tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19,
                    minZoom: 3,
                    errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',
                    tileSize: 256,
                    zoomOffset: 0
                });

                tileLayer.addTo(map);
                mapInitialized = true;
                
                // Add click handler
                map.on('click', function(e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;
                    
                    // Reverse geocode to get address
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
                        .then(response => response.json())
                        .then(data => {
                            const displayName = data.display_name || `${lat}, ${lng}`;
                            setLocationMarker(lat, lng, displayName);
                        })
                        .catch(error => {
                            console.error('Reverse geocoding error:', error);
                            setLocationMarker(lat, lng, `${lat}, ${lng}`);
                        });
                });

                console.log('‚úÖ Map pre-initialized in background');
            } catch (error) {
                console.error('Error pre-initializing map:', error);
            }
        }

        // Initialize map when delivery location input is shown
        function initializeMap() {
            const mapContainer = document.getElementById('mapContainer');
            const mapElement = document.getElementById('map');
            
            if (!mapContainer || !mapElement) {
                console.error('Map container or element not found');
                return;
            }

            // Ensure container is visible
            if (mapContainer.style.display === 'none') {
                mapContainer.style.display = 'block';
            }

            // Remove loading message quickly
            const mapLoading = document.getElementById('mapLoading');
            if (mapLoading) {
                mapLoading.style.display = 'none';
            }

            if (map && mapInitialized) {
                // Map already initialized, just show it and invalidate size
                setTimeout(() => {
                    try {
                        // Enable controls now that map is visible
                        if (!map.hasControl(L.control.zoom())) {
                            L.control.zoom().addTo(map);
                        }
                        if (!map.hasControl(L.control.attribution())) {
                            L.control.attribution({
                                position: 'bottomright'
                            }).addTo(map);
                        }
                        
                        map.invalidateSize();
                        // Re-center on Kenya if needed
                        if (!marker) {
                            map.setView([-1.2921, 36.8219], 6);
                        }
                    } catch (error) {
                        console.error('Error invalidating map size:', error);
                    }
                }, 50); // Reduced delay for faster response
                return;
            }

            // If map not pre-initialized, initialize it now (shouldn't happen, but fallback)
            if (!mapInitialized) {
                preInitializeMap();
            }
            
            // Show map quickly
            setTimeout(() => {
                try {
                    if (map) {
                        // Enable controls
                        if (!map.hasControl(L.control.zoom())) {
                            L.control.zoom().addTo(map);
                        }
                        if (!map.hasControl(L.control.attribution())) {
                            L.control.attribution({
                                position: 'bottomright'
                            }).addTo(map);
                        }
                        
                        map.invalidateSize();
                        if (!marker) {
                            map.setView([-1.2921, 36.8219], 6);
                        }
                    }
                } catch (error) {
                    console.error('Error showing map:', error);
                }
            }, 50);
        }

        // Set location marker on map
        function setLocationMarker(lat, lng, displayName) {
            // Remove existing marker
            if (marker) {
                map.removeLayer(marker);
            }

            // Add new marker
            marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(displayName).openPopup();

            // Center map on marker
            map.setView([lat, lng], 15);

            // Update selected location
            selectedLocation = {
                lat: lat,
                lng: lng,
                displayName: displayName
            };

            // Update hidden inputs
            document.getElementById('deliveryLatitude').value = lat;
            document.getElementById('deliveryLongitude').value = lng;
            document.getElementById('deliveryDisplayName').value = displayName;

            // Show selected location info
            const selectedLocationInfo = document.getElementById('selectedLocationInfo');
            const selectedLocationText = document.getElementById('selectedLocationText');
            selectedLocationInfo.style.display = 'block';
            selectedLocationText.textContent = displayName;
        }

        // Search for locations using Photon API (better POI coverage) with Nominatim fallback
        function searchLocation(query) {
            if (!query || query.length < 2) {
                document.getElementById('locationSuggestions').style.display = 'none';
                return;
            }

            // Clear previous timeout
            if (locationSearchTimeout) {
                clearTimeout(locationSearchTimeout);
            }

            // Debounce search
            locationSearchTimeout = setTimeout(() => {
                const encodedQuery = encodeURIComponent(query);
                
                // Use Photon API - better for POIs like apartments, buildings, etc.
                // Photon is free, no API key needed, and has better indexing than Nominatim
                const photonUrl = `https://photon.komoot.io/api/?q=${encodedQuery}&limit=15&lang=en`;
                
                // Also try with Nairobi context for better results
                const photonNairobiUrl = `https://photon.komoot.io/api/?q=${encodedQuery}+Nairobi&limit=10&lang=en`;
                
                // Run both Photon searches in parallel
                Promise.all([
                    fetch(photonUrl).then(r => r.json()),
                    fetch(photonNairobiUrl).then(r => r.json())
                ])
                .then(([photonResults1, photonResults2]) => {
                    // Combine Photon results
                    const allPhotonResults = [...(photonResults1.features || []), ...(photonResults2.features || [])];
                    
                    // Filter for Kenya (bounding box: lat 5.5 to -4.5, lon 33.5 to 42.0)
                    const kenyaResults = allPhotonResults.filter(feature => {
                        const coords = feature.geometry.coordinates;
                        const lng = coords[0];
                        const lat = coords[1];
                        // Kenya bounding box
                        return lat >= -4.5 && lat <= 5.5 && lng >= 33.5 && lng <= 42.0;
                    });
                    
                    // Deduplicate by coordinates (within 100m)
                    const uniqueResults = [];
                    const seenCoords = new Set();
                    
                    kenyaResults.forEach(feature => {
                        const coords = feature.geometry.coordinates;
                        const lat = coords[1].toFixed(4);
                        const lng = coords[0].toFixed(4);
                        const coordKey = `${lat},${lng}`;
                        
                        if (!seenCoords.has(coordKey)) {
                            seenCoords.add(coordKey);
                            uniqueResults.push(feature);
                        }
                    });
                    
                    // Sort by relevance
                    uniqueResults.sort((a, b) => {
                        const queryLower = query.toLowerCase();
                        const nameA = (a.properties.name || '').toLowerCase();
                        const nameB = (b.properties.name || '').toLowerCase();
                        
                        // Exact name match gets highest priority
                        const exactMatchA = nameA === queryLower ? 2 : (nameA.includes(queryLower) ? 1 : 0);
                        const exactMatchB = nameB === queryLower ? 2 : (nameB.includes(queryLower) ? 1 : 0);
                        
                        // Prioritize buildings, places, amenities
                        const typeA = (a.properties.osm_value || '').toLowerCase();
                        const typeB = (b.properties.osm_value || '').toLowerCase();
                        const isPOIA = ['building', 'place', 'amenity', 'shop', 'leisure', 'residential'].some(t => typeA.includes(t));
                        const isPOIB = ['building', 'place', 'amenity', 'shop', 'leisure', 'residential'].some(t => typeB.includes(t));
                        const poiBoostA = isPOIA ? 1 : 0;
                        const poiBoostB = isPOIB ? 1 : 0;
                        
                        return (exactMatchB + poiBoostB) - (exactMatchA + poiBoostA);
                    });
                    
                    // Convert Photon format to display format
                    const formattedResults = uniqueResults.slice(0, 10).map(feature => {
                        const props = feature.properties;
                        const coords = feature.geometry.coordinates;
                        
                        return {
                            lat: coords[1],
                            lon: coords[0],
                            name: props.name || 'Unnamed Location',
                            display_name: props.name || props.street || props.city || 'Location',
                            type: props.osm_value || props.osm_key || '',
                            address: {
                                road: props.street,
                                suburb: props.district,
                                neighbourhood: props.locality,
                                city: props.city || props.county,
                                town: props.town
                            },
                            importance: props.importance || 0.5
                        };
                    });
                    
                    if (formattedResults.length > 0) {
                        displayLocationSuggestions(formattedResults);
                    } else {
                        // Fallback to Nominatim if Photon returns no results
                        fallbackToNominatim(query, encodedQuery);
                    }
                })
                .catch(error => {
                    console.error('Photon geocoding error:', error);
                    // Fallback to Nominatim
                    fallbackToNominatim(query, encodedQuery);
                });
            }, 250);
        }
        
        // Fallback to Nominatim if Photon fails
        function fallbackToNominatim(query, encodedQuery) {
            const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedQuery}&countrycodes=ke&limit=8&addressdetails=1&extratags=1&namedetails=1`;
            
            fetch(nominatimUrl)
                .then(response => response.json())
                .then(data => {
                    displayLocationSuggestions(data);
                })
                .catch(err => {
                    console.error('Nominatim fallback error:', err);
                    document.getElementById('locationSuggestions').innerHTML = 
                        '<div style="padding: 12px; color: #718096; font-size: 13px;">Unable to search locations. Please try again.</div>';
                    document.getElementById('locationSuggestions').style.display = 'block';
                });
        }

        // Display location suggestions with better formatting
        function displayLocationSuggestions(results) {
            const suggestionsDiv = document.getElementById('locationSuggestions');
            
            if (!results || results.length === 0) {
                suggestionsDiv.innerHTML = '<div style="padding: 12px; color: #718096; font-size: 13px;">No locations found. Try searching for a street name, landmark, or area.</div>';
                suggestionsDiv.style.display = 'block';
                return;
            }

            suggestionsDiv.innerHTML = results.map(result => {
                const displayName = result.display_name;
                const primaryName = result.name || result.display_name.split(',')[0];
                
                // Extract address components for better display
                const address = result.address || {};
                const addressParts = [];
                if (address.road) addressParts.push(address.road);
                if (address.suburb || address.neighbourhood) addressParts.push(address.suburb || address.neighbourhood);
                if (address.city || address.town) addressParts.push(address.city || address.town);
                
                const addressLine = addressParts.length > 0 ? addressParts.join(', ') : displayName;
                
                // Show type/class if available (building, place, etc.)
                const type = result.type || result.class || '';
                const typeLabel = type ? `<span style="font-size: 11px; color: #718096; background: rgba(27, 77, 62, 0.1); padding: 2px 6px; border-radius: 4px; margin-left: 6px;">${type}</span>` : '';
                
                return `
                    <div class="location-suggestion" 
                         data-lat="${result.lat}" 
                         data-lng="${result.lon}" 
                         data-name="${displayName.replace(/"/g, '&quot;')}"
                         style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(0, 0, 0, 0.05); transition: background 0.2s;"
                         onmouseover="this.style.background='rgba(246, 211, 101, 0.1)'"
                         onmouseout="this.style.background='white'">
                        <div style="font-size: 14px; font-weight: 600; color: #2d3748; margin-bottom: 4px; display: flex; align-items: center;">
                            ${primaryName}${typeLabel}
                        </div>
                        <div style="font-size: 12px; color: #718096; line-height: 1.4;">${addressLine}</div>
                    </div>
                `;
            }).join('');

            // Add click handlers
            suggestionsDiv.querySelectorAll('.location-suggestion').forEach(item => {
                item.addEventListener('click', function() {
                    const lat = parseFloat(this.dataset.lat);
                    const lng = parseFloat(this.dataset.lng);
                    const name = this.dataset.name;
                    
                    setLocationMarker(lat, lng, name);
                    // Show primary name in search box, not full address
                    const primaryName = name.split(',')[0];
                    document.getElementById('locationSearch').value = primaryName;
                    suggestionsDiv.style.display = 'none';
                });
            });

            suggestionsDiv.style.display = 'block';
        }

        // Location search input handler
        document.addEventListener('DOMContentLoaded', function() {
            const locationSearch = document.getElementById('locationSearch');
            if (locationSearch) {
                locationSearch.addEventListener('input', function(e) {
                    searchLocation(e.target.value);
                });

                // Hide suggestions when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('#locationSearch') && !e.target.closest('#locationSuggestions')) {
                        document.getElementById('locationSuggestions').style.display = 'none';
                    }
                });
            }
            
            // Pre-initialize map in background for faster loading
            // Wait for Leaflet to load
            let leafletCheckAttempts = 0;
            const checkLeaflet = setInterval(() => {
                leafletCheckAttempts++;
                if (typeof L !== 'undefined') {
                    clearInterval(checkLeaflet);
                    // Pre-initialize map (hidden) for faster loading when user selects delivery option
                    setTimeout(() => {
                        preInitializeMap();
                    }, 500); // Wait a bit after page load
                } else if (leafletCheckAttempts > 50) {
                    clearInterval(checkLeaflet);
                    console.warn('Leaflet.js not loaded after 5 seconds');
                }
            }, 100);
        });

        // Delivery option - show location input for delivery options that need it
        document.getElementById('deliveryOption').addEventListener('change', function() {
            const deliveryLocationInput = document.getElementById('deliveryLocationInput');
            const storeLocationMessage = document.getElementById('storeLocationMessage');
            
            if (this.value === 'uber' || this.value === 'pickup-mtaani' || this.value === 'courier') {
                deliveryLocationInput.style.display = 'block';
                storeLocationMessage.style.display = 'none';
                
                // Ensure map container is visible and has dimensions
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer) {
                    mapContainer.style.display = 'block';
                    mapContainer.style.width = '100%';
                    mapContainer.style.height = '400px';
                }
                
                // Show map immediately (it's already pre-initialized)
                setTimeout(() => {
                    initializeMap();
                }, 50); // Much faster since map is pre-loaded
            } else if (this.value === 'in-store-pickup') {
                deliveryLocationInput.style.display = 'none';
                storeLocationMessage.style.display = 'block';
                
                // Reset location data
                selectedLocation = { lat: null, lng: null, displayName: null };
                document.getElementById('deliveryLatitude').value = '';
                document.getElementById('deliveryLongitude').value = '';
                document.getElementById('deliveryDisplayName').value = '';
                document.getElementById('selectedLocationInfo').style.display = 'none';
            } else {
                deliveryLocationInput.style.display = 'none';
                storeLocationMessage.style.display = 'none';
                
                // Reset location data
                selectedLocation = { lat: null, lng: null, displayName: null };
                document.getElementById('deliveryLatitude').value = '';
                document.getElementById('deliveryLongitude').value = '';
                document.getElementById('deliveryDisplayName').value = '';
                document.getElementById('selectedLocationInfo').style.display = 'none';
            }
        });

        document.addEventListener('click', (e) => {
            // Don't close if clicking on search input, search results, or any search result item
            const isSearchInput = searchInput.contains(e.target);
            const isSearchResults = searchResults.contains(e.target);
            const isSearchResultItem = e.target.closest('.search-result-item');
            
            if (!isSearchInput && !isSearchResults && !isSearchResultItem) {
                searchResults.classList.remove('active');
            }
        });

        // Function to launch Paystack payment
        function launchPaystackPayment(email, name, phone, amount) {
            return new Promise((resolve, reject) => {
                // Format phone number for Paystack (remove + and ensure it's in the right format)
                // Paystack expects phone number in format: 254712345678 (country code + number, no +)
                let formattedPhone = phone.replace(/^\+/, ''); // Remove leading +
                
                const handler = PaystackPop.setup({
                    key: PAYSTACK_PUBLIC_KEY,
                    email: email,
                    amount: amount, // Amount in cents (KES * 100)
                    currency: 'KES', // Kenyan Shilling
                    ref: 'APPAREL_' + Math.floor((Math.random() * 1000000000) + 1), // Generate a unique reference
                    // Phone number for M-Pesa and other mobile money payments
                    phone: formattedPhone,
                    metadata: {
                        custom_fields: [
                            {
                                display_name: "Customer Name",
                                variable_name: "customer_name",
                                value: name
                            },
                            {
                                display_name: "Phone Number",
                                variable_name: "phone_number",
                                value: phone
                            }
                        ]
                    },
                    // Enable all payment channels (M-Pesa, Airtel Money, Cards, Bank Transfer, etc.)
                    channels: ['card', 'bank', 'ussd', 'qr', 'mobile_money', 'bank_transfer'],
                    callback: function(response) {
                        // Payment successful
                        console.log('‚úÖ Payment successful:', response);
                        paymentReference = response.reference;
                        paymentCompleted = true;
                        resolve(response);
                    },
                    onClose: function() {
                        // User closed the payment window
                        console.log('‚ùå Payment window closed by user');
                        paymentCompleted = false;
                        paymentReference = null;
                        reject(new Error('Payment window closed. Payment not completed.'));
                    }
                });
                
                handler.openIframe();
            });
        }

        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!supabaseClient) {
                alert('‚ùå Database connection not available. Please refresh the page.');
                return;
            }

            if (!selectedProduct) {
                alert('Please select an item');
                return;
            }
            if (!selectedColor) {
                alert('Please select a color');
                return;
            }

            const bodyMeasurements = document.getElementById('bodyMeasurements').value;
            if (!bodyMeasurements) {
                alert('Please select body measurements');
                return;
            }
            
            // Get email
            const customerEmail = document.getElementById('email').value.trim();
            if (!customerEmail) {
                alert('Please enter your email address');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(customerEmail)) {
                alert('Please enter a valid email address');
                return;
            }

            // Parse measurements into object
            let measurements = {};
            if (bodyMeasurements === 'custom') {
                const customSize = document.getElementById('customSize').value.trim();
                const customBust = document.getElementById('customBust').value.trim();
                const customWaist = document.getElementById('customWaist').value.trim();
                const customHips = document.getElementById('customHips').value.trim();
                
                if (!customSize || !customBust || !customWaist || !customHips) {
                    alert('Please fill in all custom measurement fields (Size, Bust, Waist, Hips)');
                    return;
                }
                
                measurements = {
                    size: customSize,
                    bust: customBust,
                    waist: customWaist,
                    hips: customHips
                };
            } else {
                // Map standard size codes to their measurements from the size chart
                // These match the dropdown options: SS 6, 32, 25, 36 etc.
                const sizeChart = {
                    'SS': { size: 'SS 6', bust: '32', waist: '25', hips: '36' },
                    'S': { size: 'S 8', bust: '34', waist: '27', hips: '39' },
                    'SM': { size: 'SM 10', bust: '36', waist: '30', hips: '41' },
                    'M': { size: 'M 12', bust: '38', waist: '32', hips: '43' },
                    'SL': { size: 'SL 14', bust: '40', waist: '34', hips: '45' },
                    'L': { size: 'L 16', bust: '44', waist: '36', hips: '48' }
                };
                
                // Get measurements from size chart
                if (sizeChart[bodyMeasurements]) {
                    measurements = sizeChart[bodyMeasurements];
                } else {
                    // Fallback: try to parse if format is different
                    const parts = bodyMeasurements.split(',');
                    if (parts.length >= 4) {
                        measurements = {
                            size: parts[0].trim(),
                            bust: parts[1].trim(),
                            waist: parts[2].trim(),
                            hips: parts[3].trim()
                        };
                    } else {
                        measurements = { size: bodyMeasurements };
                    }
                }
            }

            const deliveryOption = document.getElementById('deliveryOption').value;
            
            // Validate delivery location if required
            if (deliveryOption === 'uber' || deliveryOption === 'pickup-mtaani' || deliveryOption === 'courier') {
                const deliveryLatitude = document.getElementById('deliveryLatitude').value;
                const deliveryLongitude = document.getElementById('deliveryLongitude').value;
                const deliveryDisplayName = document.getElementById('deliveryDisplayName').value;
                
                if (!deliveryLatitude || !deliveryLongitude) {
                    alert('Please select a delivery location on the map. You can search for a place or click on the map to set the location.');
                    return;
                }
            }
            
            // Payment is always facilitated by Paystack
            const paymentOption = 'paystack';

            // Disable submit button and show loading
            const submitBtn = document.querySelector('.submit-btn');
            const originalBtnText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing Payment...';

            try {
                const customerName = document.getElementById('name').value.trim();
                
                // Reset payment state
                paymentCompleted = false;
                paymentReference = null;
                
                // Calculate amount in kobo (Paystack uses smallest currency unit)
                // Since we're using KES, we'll convert to kobo equivalent
                // 1 KES = 100 kobo (similar to NGN)
                const amountInKobo = Math.round(selectedProduct.price * 100);
                
                // Get phone number for payment
                let countryCode = document.getElementById('countryCode').value.trim();
                let phoneNumber = document.getElementById('phoneNumber').value.trim();
                
                // Remove + from country code if present
                countryCode = countryCode.replace(/^\+/, '');
                
                // Remove leading 0 from phone number if present
                if (phoneNumber.startsWith('0')) {
                    phoneNumber = phoneNumber.substring(1);
                }
                
                // Combine for full phone number
                const fullPhoneNumber = '+' + countryCode + phoneNumber;
                
                // Launch Paystack payment
                try {
                    await launchPaystackPayment(customerEmail, customerName, fullPhoneNumber, amountInKobo);
                } catch (paymentError) {
                    // Payment failed or was cancelled
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                    alert('‚ùå Payment not completed. Please complete payment to submit your order.');
                    return;
                }
                
                // Check if payment was successful
                if (!paymentCompleted || !paymentReference) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                    alert('‚ùå Payment not completed. Please complete payment to submit your order.');
                    return;
                }
                
                // Payment successful, proceed with order creation
                submitBtn.textContent = 'Creating Order...';
                
                // Use the phone number we already formatted for payment
                const customerPhone = fullPhoneNumber;
                
                const comments = document.getElementById('comments').value.trim();

                // Step 1: Find or create customer
                let customerId;
                const { data: existingCustomer } = await supabaseClient
                    .from('customers')
                    .select('id')
                    .eq('phone', customerPhone)
                    .single();

                if (existingCustomer) {
                    customerId = existingCustomer.id;
                    // Update customer name if it changed
                    await supabaseClient
                        .from('customers')
                        .update({ name: customerName })
                        .eq('id', customerId);
                } else {
                    // Create new customer
                    const { data: newCustomer, error: customerError } = await supabaseClient
                        .from('customers')
                        .insert({
                            name: customerName,
                            phone: customerPhone
                        })
                        .select()
                        .single();

                    if (customerError) {
                        throw new Error(`Failed to create customer: ${customerError.message}`);
                    }
                    customerId = newCustomer.id;
                }

                // Step 2: Create order
                // Store measurements in comments since measurements column doesn't exist in schema
                let finalComments = comments || '';
                if (measurements && Object.keys(measurements).length > 0) {
                    const measurementsText = `Measurements: Size=${measurements.size || 'N/A'}, Bust=${measurements.bust || 'N/A'}, Waist=${measurements.waist || 'N/A'}, Hips=${measurements.hips || 'N/A'}`;
                    finalComments = finalComments ? `${finalComments}\n${measurementsText}` : measurementsText;
                    console.log('üìù Saving measurements:', measurements);
                    console.log('üìù Final comments with measurements:', finalComments);
                }

                // Get delivery location data if applicable
                let deliveryLocation = null;
                let deliveryLatitude = null;
                let deliveryLongitude = null;
                let deliveryDisplayName = null;
                
                if (deliveryOption === 'uber' || deliveryOption === 'pickup-mtaani' || deliveryOption === 'courier') {
                    deliveryLatitude = document.getElementById('deliveryLatitude').value;
                    deliveryLongitude = document.getElementById('deliveryLongitude').value;
                    deliveryDisplayName = document.getElementById('deliveryDisplayName').value;
                    deliveryLocation = deliveryDisplayName; // Keep for backward compatibility
                }

                // Save order with payment reference in dedicated column
                const { data: newOrder, error: orderError } = await supabaseClient
                    .from('orders')
                    .insert({
                        customer_id: customerId,
                        customer_phone: customerPhone, // Required field
                        product_id: selectedProduct.id,
                        status: 'pending',
                        color: selectedColor,
                        price: selectedProduct.price,
                        delivery_option: deliveryOption,
                        delivery_location: deliveryLocation || null, // Keep for backward compatibility
                        delivery_latitude: deliveryLatitude ? parseFloat(deliveryLatitude) : null,
                        delivery_longitude: deliveryLongitude ? parseFloat(deliveryLongitude) : null,
                        delivery_display_name: deliveryDisplayName || null,
                        payment_option: paymentOption, // 'paystack' - now allowed in database constraint
                        payment_reference: paymentReference, // Store payment reference in dedicated column
                        payment_status: 'completed', // Payment status
                        comments: finalComments || null
                    })
                    .select()
                    .single();

                if (orderError) {
                    throw new Error(`Failed to create order: ${orderError.message}`);
                }

                console.log('‚úÖ Order submitted successfully:', newOrder);
                console.log('‚úÖ Payment Reference:', paymentReference);
                
                alert(`‚úì Payment successful!\n‚úì Order submitted successfully!\n\nPayment Reference: ${paymentReference}\n\nYou can freely exit.`);
                
                // Reset form
                document.getElementById('orderForm').reset();
                // Reset country code to just +
                document.getElementById('countryCode').value = '+';
                selectedProductDiv.classList.remove('active');
                colorOptionsDiv.classList.remove('active');
                document.getElementById('selectedColorDisplay').textContent = '';
                document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                document.getElementById('customSizeInput').style.display = 'none';
                document.getElementById('customSize').value = '';
                document.getElementById('customBust').value = '';
                document.getElementById('customWaist').value = '';
                document.getElementById('customHips').value = '';
                document.getElementById('deliveryLocationInput').style.display = 'none';
                document.getElementById('storeLocationMessage').style.display = 'none';
                
                // Reset map and location data
                if (marker && map) {
                    map.removeLayer(marker);
                    marker = null;
                }
                selectedLocation = { lat: null, lng: null, displayName: null };
                document.getElementById('deliveryLatitude').value = '';
                document.getElementById('deliveryLongitude').value = '';
                document.getElementById('deliveryDisplayName').value = '';
                document.getElementById('selectedLocationInfo').style.display = 'none';
                document.getElementById('locationSearch').value = '';
                document.getElementById('locationSuggestions').style.display = 'none';
                
                selectedProduct = null;
                selectedColor = null;
                
                // Reset payment state
                paymentCompleted = false;
                paymentReference = null;
            } catch (error) {
                console.error('Error submitting order:', error);
                alert(`‚ùå Failed to submit order: ${error.message}. Please try again.`);
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        });
    </script>
</body>
</html>