<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apparel Modest Dashboard</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Apparel Modest - Fashion Order Management System">
    <meta name="theme-color" content="#1B4D3E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Apparel Modest">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#1B4D3E">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="application-name" content="Apparel Modest">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="128x128" href="/icons/icon-128x128.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: #3C3F3E;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
            position: relative;
        }

        /* Prevent horizontal overflow for all elements */
        img, video, iframe, embed, object {
            max-width: 100%;
            height: auto;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .login-card {
            background: rgba(224, 216, 201, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 100%;
            border: 1px solid rgba(224, 216, 201, 0.2);
            position: relative;
            margin: auto;
            z-index: 1;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #E0D8C9;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 8px;
        }

        .login-header p {
            font-size: 14px;
            color: rgba(224, 216, 201, 0.8);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: rgba(224, 216, 201, 0.9);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(224, 216, 201, 0.3);
            border-radius: 8px;
            background: rgba(224, 216, 201, 0.1);
            color: #E0D8C9;
            font-size: 16px;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(224, 216, 201, 0.6);
            background: rgba(224, 216, 201, 0.15);
        }

        .form-input::placeholder {
            color: rgba(224, 216, 201, 0.6);
        }

        textarea.form-input {
            min-height: 100px;
            font-family: inherit;
        }

        .btn-login {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #E0D8C9 0%, #D4C5B0 100%);
            color: #3C3F3E;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 12px;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-otp {
            width: 100%;
            padding: 10px;
            background: transparent;
            color: rgba(224, 216, 201, 0.9);
            border: 1px solid rgba(224, 216, 201, 0.3);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-otp:hover {
            background: rgba(224, 216, 201, 0.1);
        }

        .hidden {
            display: none !important;
        }

        /* OTP Sent Indicator */
        .otp-sent-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            color: #10b981;
            font-size: 14px;
            margin-top: 12px;
            animation: slideIn 0.3s ease-out;
        }

        .otp-sent-indicator.hidden {
            display: none;
        }

        .otp-sent-indicator svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .otp-sent-indicator .email-text {
            font-weight: 600;
            color: rgba(224, 216, 201, 0.95);
        }

        #add-return-modal:not(.hidden) {
            display: flex !important;
        }

        /* Make return modal smaller and scrollable */
        #add-return-modal .login-card {
            max-width: 450px !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
            padding: 24px 28px !important;
        }

        #add-return-modal .login-header {
            margin-bottom: 20px;
        }

        #add-return-modal .login-header h1 {
            font-size: 22px;
            margin-bottom: 4px;
        }

        #add-return-modal .login-header p {
            font-size: 13px;
        }

        #add-return-modal .form-group {
            margin-bottom: 16px;
        }

        #add-return-modal #return-selected-product-preview {
            margin-top: 10px;
            padding: 10px;
        }

        #add-return-modal #return-selected-product-image {
            width: 50px;
            height: 50px;
        }

        #add-return-modal #return-selected-product-name {
            font-size: 13px;
        }

        #add-return-modal .form-label {
            font-size: 13px;
            margin-bottom: 6px;
        }

        #add-return-modal .form-input {
            padding: 10px 14px;
            font-size: 14px;
        }

        #add-return-modal textarea.form-input {
            min-height: 80px;
            font-size: 14px;
        }

        /* Return Modal Search Results */
        #add-return-modal .search-container {
            position: relative;
        }

        #return-product-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(224, 216, 201, 0.4);
            border-radius: 8px;
            margin-top: 6px;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            display: none;
            pointer-events: auto;
        }

        #return-product-search-results.active {
            display: block !important;
        }

        .return-search-result-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(224, 216, 201, 0.2);
            user-select: none;
            pointer-events: auto;
        }

        .return-search-result-item:hover {
            background: rgba(224, 216, 201, 0.15);
        }

        .return-search-result-item:last-child {
            border-bottom: none;
        }

        .return-search-result-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 12px;
            background: rgba(0, 0, 0, 0.02);
            flex-shrink: 0;
        }

        .return-search-result-name {
            font-size: 14px;
            font-weight: 500;
            color: #41463F;
            flex: 1;
        }

        /* Selected Product Preview in Returns Modal */
        #return-selected-product-preview {
            display: none;
            background: rgba(224, 216, 201, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px;
            margin-top: 12px;
            border: 1px solid rgba(224, 216, 201, 0.3);
            align-items: center;
            gap: 12px;
        }

        #return-selected-product-preview.active {
            display: flex;
        }

        #return-selected-product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.02);
            flex-shrink: 0;
        }

        #return-selected-product-name {
            font-size: 14px;
            font-weight: 600;
            color: #41463F;
        }

        .return-search-no-results {
            padding: 16px;
            text-align: center;
            color: rgba(65, 70, 63, 0.6);
            font-size: 13px;
        }

        .required {
            color: #ef4444;
            margin-left: 2px;
        }

        /* Mobile responsive for return modal */
        @media (max-width: 768px) {
            #add-return-modal {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }

            #add-return-modal .login-card {
                max-width: 100% !important;
                width: 100% !important;
                padding: 20px 16px !important;
                margin: 0 !important;
                max-height: calc(100vh - 20px) !important;
                overflow-y: auto !important;
            }

            #add-return-modal .login-header h1 {
                font-size: 20px !important;
            }

            #add-return-modal .login-header p {
                font-size: 13px !important;
            }

            #add-return-modal .form-group {
                margin-bottom: 20px;
            }

            #add-return-modal .form-input {
                padding: 10px 14px;
                font-size: 14px;
            }

            #add-return-modal .form-label {
                font-size: 13px;
                margin-bottom: 6px;
            }

            #add-return-modal textarea.form-input {
                min-height: 80px;
                font-size: 14px;
            }

            #add-return-modal .btn-login,
            #add-return-modal .btn-otp {
                padding: 10px 14px;
                font-size: 14px;
            }

            #return-product-search-results {
                max-height: 150px;
            }
        }

        .otp-message {
            background: rgba(224, 216, 201, 0.15);
            border: 1px solid rgba(224, 216, 201, 0.4);
            border-radius: 8px;
            padding: 12px;
            color: #E0D8C9;
            font-size: 14px;
            text-align: center;
            margin-top: 10px;
        }

        .error-message {
            background: rgba(224, 216, 201, 0.15);
            border: 1px solid rgba(224, 216, 201, 0.4);
            border-radius: 8px;
            padding: 12px;
            color: #E0D8C9;
            font-size: 14px;
            text-align: center;
            margin-top: 10px;
        }

        .admin-view-btn {
            background: linear-gradient(135deg, #E0D8C9 0%, #D4C5B0 100%);
            color: #3C3F3E;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .admin-view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
        }

        .back-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(224, 216, 201, 0.15);
            backdrop-filter: blur(10px);
            color: #E0D8C9;
            border: 1px solid rgba(224, 216, 201, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1000;
        }

        .back-btn:hover {
            background: rgba(224, 216, 201, 0.2);
        }

        .mobile-menu-btn {
            display: none;
        }

        .sidebar-overlay {
            display: none;
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .dashboard.hidden {
            display: none !important;
        }

        #admin-dashboard-page {
            display: none;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }

        #admin-dashboard-page:not(.hidden) {
            display: block;
        }

        /* Admin Sidebar - Match employee dashboard structure */
        #admin-sidebar {
            width: 260px;
            background: #41463F;
            backdrop-filter: blur(20px);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid rgba(224, 216, 201, 0.2) !important;
            z-index: 10003;
            padding: 30px 0;
            pointer-events: auto;
        }
        
        /* Ensure admin nav links are clickable */
        #admin-sidebar .nav-link {
            pointer-events: auto !important;
            cursor: pointer;
            position: relative;
            z-index: 1;
        }

        /* Admin Main Content - Match employee dashboard structure */
        #admin-dashboard-page main {
            margin-left: 260px;
            padding: 30px;
            background: #FAFAFA;
            min-height: 100vh;
            width: calc(100% - 260px);
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* All admin content pages - match employee dashboard background */
        #admin-overview-content,
        #admin-revenue-content,
        #admin-staff-content,
        #admin-inventory-content,
        #admin-analytics-content {
            background: #FAFAFA !important;
            padding: 30px;
            border-radius: 0;
        }

        /* Glass cards - light theme for all admin pages */
        #admin-overview-content .glass-card,
        #admin-revenue-content .glass-card,
        #admin-staff-content .glass-card,
        #admin-inventory-content .glass-card,
        #admin-analytics-content .glass-card,
        #admin-trash-content .glass-card {
            background: rgba(224, 216, 201, 0.1) !important;
            border: 1px solid rgba(224, 216, 201, 0.2) !important;
        }

        /* Text colors - dark for light background */
        #admin-overview-content .text-white,
        #admin-overview-content h3.text-white,
        #admin-revenue-content .text-white,
        #admin-revenue-content h3.text-white,
        #admin-staff-content .text-white,
        #admin-staff-content h3.text-white,
        #admin-inventory-content .text-white,
        #admin-inventory-content h3.text-white,
        #admin-analytics-content .text-white,
        #admin-analytics-content h3.text-white,
        #admin-trash-content .text-white,
        #admin-trash-content h3.text-white {
            color: #41463F !important;
        }

        #admin-overview-content .text-white\/70,
        #admin-overview-content .text-white\/60,
        #admin-revenue-content .text-white\/70,
        #admin-revenue-content .text-white\/60,
        #admin-staff-content .text-white\/70,
        #admin-staff-content .text-white\/60,
        #admin-inventory-content .text-white\/70,
        #admin-inventory-content .text-white\/60,
        #admin-analytics-content .text-white\/70,
        #admin-analytics-content .text-white\/60,
        #admin-trash-content .text-white\/70,
        #admin-trash-content .text-white\/60 {
            color: rgba(65, 70, 63, 0.7) !important;
        }

        /* Remove black borders/rings - use light colors */
        #admin-overview-content *,
        #admin-revenue-content *,
        #admin-staff-content *,
        #admin-inventory-content *,
        #admin-analytics-content *,
        #admin-trash-content * {
            border-color: rgba(224, 216, 201, 0.2) !important;
        }

        /* Ensure content pages fit properly */
        #admin-dashboard-page .content-page {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Fix grid layouts to prevent overflow */
        #admin-dashboard-page .grid {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Glass card styling for admin */
        .glass-card-strong {
            background: rgba(65, 70, 63, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(224, 216, 201, 0.2) !important;
        }

        .glass-card {
            background: rgba(65, 70, 63, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(224, 216, 201, 0.2) !important;
            border-radius: 12px;
        }

        /* Remove all black/dark borders from admin pages */
        #admin-overview-content,
        #admin-revenue-content,
        #admin-staff-content,
        #admin-inventory-content,
        #admin-analytics-content {
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }

        #admin-overview-content *,
        #admin-revenue-content *,
        #admin-staff-content *,
        #admin-inventory-content *,
        #admin-analytics-content * {
            border-color: rgba(224, 216, 201, 0.2) !important;
            outline-color: rgba(224, 216, 201, 0.2) !important;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #41463F;
            backdrop-filter: blur(20px);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid rgba(224, 216, 201, 0.2) !important;
            z-index: 10003;
            pointer-events: auto;
        }

        .logo {
            padding: 0 25px 30px;
            border-bottom: 1px solid rgba(224, 216, 201, 0.2) !important;
        }

        .logo h2 {
            font-size: 20px;
            font-weight: 700;
            color: #FAFAFA;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .logo p {
            font-size: 13px;
            color: rgba(250, 250, 250, 0.8);
            margin-top: 4px;
        }

        .nav-menu {
            margin-top: 20px;
        }

        .nav-item {
            padding: 12px 25px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 15px;
            color: rgba(250, 250, 250, 0.9);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover {
            background: rgba(250, 250, 250, 0.15);
            color: #FAFAFA;
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(250, 250, 250, 0.2) 0%, transparent 100%);
            color: #FAFAFA;
            border-right: 3px solid rgba(224, 216, 201, 0.3) !important;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
            background: #FAFAFA;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Home Tab */
        .welcome-section {
            background: rgba(65, 70, 63, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            color: #41463F;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(65, 70, 63, 0.2);
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(224,216,201,0.25) 0%, transparent 70%);
            animation: shimmer 10s infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(20px, 20px) rotate(180deg); }
        }

        .welcome-section h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .welcome-section p {
            font-size: 16px;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(224, 216, 201, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(224, 216, 201, 0.2);
        }

        .stat-label {
            font-size: 13px;
            color: rgba(65, 70, 63, 0.8);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #41463F;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: rgba(224, 216, 201, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(224, 216, 201, 0.2);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #41463F;
            margin-bottom: 20px;
        }

        /* Orders Section */
        .section-header {
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: #41463F;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .orders-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            align-items: start;
        }

        .order-bubble {
            background: rgba(224, 216, 201, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(224, 216, 201, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-self: start;
            height: fit-content;
        }

        .order-bubble:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
        }

        .order-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .order-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            background: #f7fafc;
            flex-shrink: 0;
        }

        .order-info {
            flex: 1;
            min-width: 0;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .customer-name {
            font-size: 15px;
            font-weight: 600;
            color: #41463F;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.3;
        }

        .product-name {
            font-size: 13px;
            color: rgba(65, 70, 63, 0.9);
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            line-height: 1.3;
        }

        .product-color {
            font-size: 12px;
            color: rgba(65, 70, 63, 0.8);
            display: inline-block;
            padding: 4px 10px;
            background: rgba(65, 70, 63, 0.15);
            border-radius: 12px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            margin-top: 6px;
        }

        /* Hide color and actions in collapsed state */
        .order-bubble:not(.expanded) .product-color,
        .order-bubble:not(.expanded) .order-actions {
            display: none;
        }

        .order-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-accept {
            background: linear-gradient(135deg, #E0D8C9 0%, #D4C5B0 100%);
            color: #3C3F3E;
            box-shadow: 0 4px 15px rgba(224, 216, 201, 0.3);
        }

        .btn-accept:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(224, 216, 201, 0.4);
        }

        .btn-deny {
            background: rgba(224, 216, 201, 0.15);
            color: rgba(224, 216, 201, 0.8);
            border: 1px solid rgba(224, 216, 201, 0.3);
        }

        .btn-deny:hover {
            background: rgba(224, 216, 201, 0.2);
        }

        .btn-done {
            background: linear-gradient(135deg, #E0D8C9 0%, #D4C5B0 100%);
            color: #3C3F3E;
            box-shadow: 0 4px 15px rgba(224, 216, 201, 0.3);
        }

        .btn-done:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(224, 216, 201, 0.4);
        }

        .btn-delivered {
            background: linear-gradient(135deg, #E0D8C9 0%, #D4C5B0 100%);
            color: #3C3F3E;
            box-shadow: 0 4px 15px rgba(224, 216, 201, 0.3);
        }

        .btn-delivered:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(224, 216, 201, 0.4);
        }

        .return-resolved-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #41463F;
        }

        .return-item.resolved {
            opacity: 0.6;
            background: rgba(65, 70, 63, 0.05);
        }

        /* Kanban Board Styles */
        .kanban-card {
            transition: all 0.2s ease;
        }

        .kanban-card:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .kanban-card:hover .edit-kanban-btn,
        .kanban-card:hover .done-kanban-btn {
            opacity: 1 !important;
        }


        .add-kanban-card-btn:hover {
            background: rgba(60, 63, 62, 1) !important;
            border-color: rgba(60, 63, 62, 1) !important;
            color: #FAFAFA !important;
            transform: translateY(-1px);
        }

        .kanban-cards::-webkit-scrollbar {
            width: 6px;
        }

        .kanban-cards::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .kanban-cards::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .kanban-cards::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .kanban-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .kanban-column {
            min-width: 280px;
            flex: 1;
            max-width: 100%;
        }

        .kanban-card {
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .kanban-card h4 {
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }

        .kanban-card p {
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }

        /* Responsive Kanban Styles */
        @media (max-width: 768px) {
            .kanban-container {
                flex-direction: column;
                gap: 12px;
                overflow-x: visible;
            }

            .kanban-column {
                min-width: 100%;
                max-width: 100%;
                flex: none;
            }

            .kanban-cards {
                min-height: 300px !important;
                max-height: 400px !important;
            }

            .kanban-card {
                padding: 10px !important;
                margin-bottom: 10px !important;
            }

            .kanban-card h4 {
                font-size: 13px !important;
            }

            .kanban-card p {
                font-size: 12px !important;
            }

            .add-kanban-card-btn {
                padding: 10px !important;
                font-size: 14px !important;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .kanban-column {
                min-width: 250px;
            }
        }

        @media (min-width: 1025px) {
            .kanban-column {
                min-width: 280px;
            }
        }

        .return-item.resolved .customer-name,
        .return-item.resolved .product-name,
        .return-item.resolved .product-color {
            text-decoration: line-through;
        }

        .return-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }

        .return-status-label {
            font-size: 14px;
            color: rgba(65, 70, 63, 0.8);
            font-weight: 500;
        }

        .order-details {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(224, 216, 201, 0.2);
        }

        .order-bubble.expanded .order-details {
            display: block;
        }

        /* Show color and actions when expanded */
        .order-bubble.expanded .product-color {
            display: inline-block;
        }

        .order-bubble.expanded .order-actions {
            display: flex !important;
            margin-top: 12px;
        }

        .detail-row {
            display: flex;
            margin-bottom: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .detail-label {
            font-weight: 600;
            color: rgba(65, 70, 63, 0.9);
            width: 120px;
            flex-shrink: 0;
        }

        .detail-value {
            color: rgba(65, 70, 63, 0.8);
            flex: 1;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            min-width: 0;
            max-width: 100%;
        }

        /* Completed Orders Table */
        .table-container {
            background: rgba(224, 216, 201, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid rgba(224, 216, 201, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(224, 216, 201, 0.15);
        }

        th {
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #41463F;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px;
            font-size: 14px;
            color: rgba(65, 70, 63, 0.9);
            border-top: 1px solid rgba(65, 70, 63, 0.2);
        }

        tr:hover {
            background: rgba(224, 216, 201, 0.1);
        }

        .price-cell {
            font-weight: 600;
            color: #41463F;
        }

        /* Expandable Order Details Styles */
        .order-row {
            transition: background-color 0.2s ease;
        }

        .order-row:hover {
            background: rgba(224, 216, 201, 0.15) !important;
        }

        .order-row.expanded {
            background: rgba(224, 216, 201, 0.2);
        }

        .order-details-row {
            background: rgba(224, 216, 201, 0.08);
        }

        .order-details-cell {
            padding: 0 !important;
            border-top: none !important;
        }

        .order-details-content {
            padding: 20px 16px;
            width: 100%;
        }

        .order-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(65, 70, 63, 0.2);
        }

        .order-details-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #41463F;
        }

        .items-count {
            font-size: 13px;
            color: rgba(65, 70, 63, 0.7);
            font-weight: 500;
        }

        .order-items-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .order-item-detail {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(65, 70, 63, 0.1);
        }

        .item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .item-number {
            font-weight: 600;
            color: rgba(65, 70, 63, 0.8);
            font-size: 13px;
        }

        .item-name {
            font-weight: 600;
            color: #41463F;
            font-size: 14px;
            flex: 1;
        }

        .item-color {
            color: rgba(65, 70, 63, 0.7);
            font-size: 13px;
        }

        .item-price {
            font-weight: 600;
            color: #41463F;
            font-size: 13px;
            margin-left: auto;
        }

        .item-measurements {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(65, 70, 63, 0.1);
        }

        .measurements-title {
            font-size: 12px;
            font-weight: 600;
            color: rgba(65, 70, 63, 0.8);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .measurement-item {
            display: flex;
            gap: 8px;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .measurement-label {
            font-weight: 500;
            color: rgba(65, 70, 63, 0.7);
            min-width: 100px;
        }

        .measurement-value {
            color: #41463F;
            font-weight: 500;
        }

        .no-items {
            text-align: center;
            color: rgba(65, 70, 63, 0.5);
            font-style: italic;
            padding: 20px;
        }

        /* Search Bar Styles */
        .search-section {
            width: 100%;
        }

        .search-input-wrapper {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 12px 48px 12px 44px;
            border: 2px solid rgba(65, 70, 63, 0.2);
            border-radius: 12px;
            font-size: 14px;
            color: #41463F;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .search-input:focus {
            border-color: rgba(65, 70, 63, 0.5);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .search-input::placeholder {
            color: rgba(65, 70, 63, 0.5);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(65, 70, 63, 0.5);
            pointer-events: none;
        }

        .clear-search-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(65, 70, 63, 0.1);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: rgba(65, 70, 63, 0.7);
            z-index: 10;
        }

        .clear-search-btn:hover {
            background: rgba(65, 70, 63, 0.2);
            color: #41463F;
        }

        .clear-search-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .clear-search-btn:hover {
            background: rgba(65, 70, 63, 0.2);
            color: #41463F;
        }

        .clear-search-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Calendar and Filter Styles */
        .filters-section {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: rgba(65, 70, 63, 0.9);
        }

        .filter-input {
            padding: 10px 16px;
            border: 1px solid rgba(65, 70, 63, 0.3);
            border-radius: 8px;
            background: rgba(65, 70, 63, 0.1);
            color: #41463F;
            font-size: 14px;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: rgba(65, 70, 63, 0.6);
            background: rgba(65, 70, 63, 0.15);
        }

        .filter-input::placeholder {
            color: rgba(65, 70, 63, 0.6);
        }

        .filter-select {
            padding: 10px 16px;
            border: 1px solid rgba(65, 70, 63, 0.3);
            border-radius: 8px;
            background: rgba(65, 70, 63, 0.1);
            color: #41463F;
            font-size: 14px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: rgba(65, 70, 63, 0.6);
            background: rgba(65, 70, 63, 0.15);
        }

        .filter-select option {
            background: #FAFAFA;
            color: #41463F;
        }

        /* Catalogue form input focus states */
        #add-product-form input:focus,
        #add-product-form select:focus,
        #add-product-form textarea:focus {
            outline: none;
            border-color: rgba(65, 70, 63, 0.6);
            background: rgba(65, 70, 63, 0.15);
            box-shadow: 0 0 0 3px rgba(65, 70, 63, 0.1);
        }

        #image-upload-area:hover {
            border-color: rgba(65, 70, 63, 0.5);
            background: rgba(65, 70, 63, 0.08);
        }

        #remove-image-btn:hover {
            background: rgba(244, 67, 54, 1) !important;
            transform: scale(1.1);
        }

        /* Custom scrollbar for form */
        .form-scroll-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(65, 70, 63, 0.3) rgba(65, 70, 63, 0.1);
        }

        .form-scroll-container::-webkit-scrollbar {
            width: 6px;
        }

        .form-scroll-container::-webkit-scrollbar-track {
            background: rgba(65, 70, 63, 0.1);
            border-radius: 3px;
        }

        .form-scroll-container::-webkit-scrollbar-thumb {
            background: rgba(65, 70, 63, 0.3);
            border-radius: 3px;
        }

        .form-scroll-container::-webkit-scrollbar-thumb:hover {
            background: rgba(65, 70, 63, 0.5);
        }

        .calendar-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(65, 70, 63, 0.6);
            pointer-events: none;
        }

        .date-input-wrapper {
            position: relative;
        }

        /* Profile Styles */
        .profile-section {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .profile-avatar {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .avatar-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E0D8C9 0%, #D4C5B0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 700;
            color: #3C3F3E;
            box-shadow: 0 8px 30px rgba(224, 216, 201, 0.3);
        }

        .profile-details {
            flex: 1;
        }

        .achievements-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(224, 216, 201, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(224, 216, 201, 0.2);
        }

        .achievement-icon {
            font-size: 32px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(224, 216, 201, 0.1);
            border-radius: 50%;
        }

        .achievement-details h4 {
            font-size: 16px;
            font-weight: 600;
            color: #41463F;
            margin-bottom: 4px;
        }

        .achievement-details p {
            font-size: 14px;
            color: rgba(65, 70, 63, 0.8);
        }

        @media (max-width: 768px) {
            /* Sidebar - Hidden by default, show as overlay */
            .sidebar {
                width: 260px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 1000;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            /* Mobile menu button */
            .mobile-menu-btn {
                display: block !important;
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1001;
                background: #41463F;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(224, 216, 201, 0.2) !important;
                padding: 12px;
                border-radius: 8px;
                cursor: pointer;
                color: rgba(250, 250, 250, 0.9);
                transition: all 0.2s ease;
            }

            .mobile-menu-btn:hover {
                background: rgba(250, 250, 250, 0.15);
                color: #FAFAFA;
            }

            .main-content {
                margin-left: 0;
                padding: 20px 15px;
            }

            .logo p, .nav-item span {
                display: block;
            }

            /* Overlay for sidebar */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 10002;
                pointer-events: auto;
            }

            .sidebar-overlay.active {
                display: block;
            }
            
            /* Ensure sidebar is above overlay and clickable */
            .sidebar.mobile-open {
                z-index: 10003 !important;
                pointer-events: auto !important;
            }
            
            /* Ensure nav items are clickable */
            .sidebar .nav-item {
                pointer-events: auto !important;
                z-index: 1;
                position: relative;
            }

            /* Welcome section */
            .welcome-section {
                padding: 24px 20px;
            }

            .welcome-section h1 {
                font-size: 24px;
            }

            .welcome-section p {
                font-size: 14px;
            }

            /* Stats grid */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 24px;
            }

            /* Charts */
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .chart-card {
                padding: 16px;
            }

            .chart-title {
                font-size: 16px;
                margin-bottom: 16px;
            }

            /* Orders - keep horizontal layout for collapsed state */
            .order-bubble {
                padding: 10px;
            }

            .order-header {
                gap: 10px;
            }

            .order-image {
                width: 55px;
                height: 55px;
            }

            /* Search bar responsive */
            .search-section {
                padding: 0 12px !important;
            }

            .search-input {
                padding: 10px 44px 10px 40px !important;
                font-size: 13px !important;
            }

            .search-icon {
                left: 12px !important;
                width: 18px !important;
                height: 18px !important;
            }

            .clear-search-btn {
                right: 10px !important;
                width: 22px !important;
                height: 22px !important;
            }

            /* Table responsive */
            .table-container {
                overflow-x: visible;
                -webkit-overflow-scrolling: touch;
                width: 100%;
            }

            table {
                width: 100%;
                min-width: auto;
                table-layout: fixed;
            }

            th, td {
                padding: 8px 4px;
                font-size: 11px;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            th:nth-child(1), td:nth-child(1) {
                width: 18%;
            }

            th:nth-child(2), td:nth-child(2) {
                width: 18%;
                font-size: 10px;
            }

            th:nth-child(3), td:nth-child(3) {
                width: 20%;
            }

            th:nth-child(4), td:nth-child(4) {
                width: 12%;
            }

            th:nth-child(5), td:nth-child(5) {
                width: 15%;
                font-size: 10px;
            }

            th:nth-child(6), td:nth-child(6) {
                width: 17%;
                font-size: 10px;
            }

            /* Filters */
            .filters-section {
                flex-direction: column;
                gap: 12px;
            }

            .filter-group {
                width: 100%;
            }

            /* Profile */
            .profile-section {
                flex-direction: column;
                gap: 20px;
            }

            /* Catalogue responsive */
            #catalogue > div[style*="grid-template-columns: 1fr 2fr"] {
                display: flex !important;
                flex-direction: column !important;
            }

            #add-product-panel {
                position: relative !important;
                top: 0 !important;
                margin-top: 0;
                margin-bottom: 24px;
                order: -1;
            }

            #catalogue-products-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }

            /* Make Add Product form more compact on mobile */
            #add-product-panel {
                padding: 16px !important;
            }

            #add-product-panel .chart-title {
                font-size: 18px !important;
                padding: 12px 16px !important;
                margin-bottom: 12px !important;
            }

            #add-product-form {
                gap: 12px !important;
            }

            #add-product-form label {
                font-size: 12px !important;
                margin-bottom: 6px !important;
            }

            #add-product-form input,
            #add-product-form select,
            #add-product-form textarea {
                padding: 8px 12px !important;
                font-size: 13px !important;
            }

            #image-upload-area {
                height: 150px !important;
            }

            #product-colors-container {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }

            #add-product-form .btn {
                padding: 10px 14px !important;
                font-size: 13px !important;
            }

            /* Login card */
            .login-card {
                padding: 30px 20px;
                margin: 20px;
            }

            /* Modal */
            #add-return-modal {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }

            #add-return-modal .login-card {
                max-width: 100% !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 20px 16px !important;
                max-height: calc(100vh - 20px);
                overflow-y: auto;
            }

            #add-return-modal .login-header h1 {
                font-size: 20px !important;
            }

            #add-return-modal .login-header p {
                font-size: 13px !important;
            }

            #add-return-modal .form-group {
                margin-bottom: 18px;
            }

            #add-return-modal .form-input {
                padding: 10px 14px;
                font-size: 14px;
            }

            #add-return-modal .form-label {
                font-size: 13px;
                margin-bottom: 6px;
            }

            #add-return-modal textarea.form-input {
                min-height: 80px;
                font-size: 14px;
            }

            #add-return-modal .btn-login,
            #add-return-modal .btn-otp {
                padding: 10px 14px;
                font-size: 14px;
            }

            #return-product-search-results {
                max-height: 150px;
            }

            /* Admin dashboard mobile */
            #admin-dashboard-page {
                overflow-x: hidden;
                width: 100%;
                max-width: 100vw;
            }

            #admin-sidebar {
                transform: translateX(-100%);
                width: 260px !important;
                transition: transform 0.3s ease;
                z-index: 10003 !important;
                pointer-events: auto !important;
            }

            #admin-sidebar.mobile-open {
                transform: translateX(0);
                z-index: 10003 !important;
                pointer-events: auto !important;
            }
            
            /* Ensure admin nav links are clickable on mobile */
            #admin-sidebar.mobile-open .nav-link {
                pointer-events: auto !important;
                z-index: 1;
                position: relative;
            }

            #admin-dashboard-page main {
                margin-left: 0 !important;
                padding: 20px 15px !important;
                width: 100% !important;
                max-width: 100vw !important;
                overflow-x: hidden !important;
                box-sizing: border-box !important;
            }

            #admin-dashboard-page .p-6,
            #admin-dashboard-page .p-8 {
                padding: 12px !important;
            }

            .admin-mobile-menu-btn {
                display: block;
            }

            /* Admin cards */
            .glass-card {
                padding: 12px !important;
                margin: 0;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }

            .glass-card .p-6 {
                padding: 12px !important;
            }

            .text-4xl {
                font-size: 1.5rem !important;
                line-height: 1.75rem !important;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            .text-3xl {
                font-size: 1.25rem !important;
                line-height: 1.5rem !important;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            .text-2xl {
                font-size: 1.125rem !important;
                line-height: 1.375rem !important;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            .text-xl {
                font-size: 1rem !important;
                line-height: 1.25rem !important;
            }

            /* Grid adjustments */
            .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4,
            #admin-dashboard-page .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-4 {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            .grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3,
            #admin-dashboard-page .grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3 {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            #admin-dashboard-page .grid.grid-cols-1.lg\:grid-cols-2 {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* Section headers */
            .section-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start !important;
            }

            .section-header h2 {
                font-size: 18px !important;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            /* Buttons */
            .btn {
                font-size: 12px !important;
                padding: 8px 12px !important;
                white-space: nowrap;
            }

            /* Text overflow fixes */
            #admin-dashboard-page * {
                max-width: 100%;
                box-sizing: border-box;
            }

            #admin-dashboard-page h1,
            #admin-dashboard-page h2,
            #admin-dashboard-page h3,
            #admin-dashboard-page p,
            #admin-dashboard-page span,
            #admin-dashboard-page div {
                word-wrap: break-word;
                overflow-wrap: break-word;
                word-break: break-word;
            }

            /* Chart containers - larger on mobile for better visibility */
            #admin-dashboard-page .chart-container {
                width: 100% !important;
                max-width: 100% !important;
                height: 320px !important;
                min-height: 320px !important;
                overflow-x: auto;
                overflow-y: hidden;
                box-sizing: border-box;
                -webkit-overflow-scrolling: touch;
                position: relative;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            #admin-dashboard-page .chart-container svg {
                max-width: 100% !important;
                width: 100% !important;
                height: auto !important;
                min-width: 0 !important;
                min-height: 200px !important;
                max-height: 300px !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            #admin-dashboard-page canvas {
                max-width: 100% !important;
                width: 100% !important;
                height: auto !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            /* Ensure chart containers are visible on mobile */
            #admin-overview-content .chart-container,
            #admin-revenue-content .chart-container,
            #admin-analytics-content .chart-container {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            /* Chart wrapper cards - prevent overflow */
            #admin-dashboard-page .glass-card {
                overflow: visible !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            /* Chart card padding reduction on mobile */
            #admin-dashboard-page .glass-card .p-6 {
                padding: 12px !important;
            }

            /* Space adjustments */
            #admin-dashboard-page .space-y-6 > * + * {
                margin-top: 16px !important;
            }

            #admin-dashboard-page .space-y-4 > * + * {
                margin-top: 12px !important;
            }

            /* Gap adjustments */
            #admin-dashboard-page .gap-4 {
                gap: 12px !important;
            }

            #admin-dashboard-page .gap-6 {
                gap: 16px !important;
            }

            /* Sidebar text */
            #admin-sidebar h1 {
                font-size: 1.25rem !important;
                word-wrap: break-word;
            }

            #admin-sidebar .text-sm {
                font-size: 0.75rem !important;
            }

            /* Navigation links */
            #admin-sidebar .nav-link {
                font-size: 0.875rem !important;
                padding: 10px 12px !important;
                white-space: nowrap;
            }

            /* Table fixes */
            #admin-dashboard-page table {
                width: 100%;
                max-width: 100%;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            #admin-dashboard-page thead,
            #admin-dashboard-page tbody {
                display: block;
                width: 100%;
            }

            #admin-dashboard-page tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }

            #admin-dashboard-page th,
            #admin-dashboard-page td {
                font-size: 0.75rem !important;
                padding: 8px 4px !important;
                word-wrap: break-word;
                overflow-wrap: break-word;
                word-break: break-word;
            }

            /* Profile button mobile fix */
            #profile-btn-home {
                min-height: 44px;
                min-width: 44px;
                cursor: pointer;
                pointer-events: auto;
                -webkit-tap-highlight-color: rgba(224, 216, 201, 0.3);
            }

            /* Detail rows */
            .detail-row {
                flex-direction: column;
                gap: 4px;
            }

            .detail-label {
                width: 100%;
                flex-shrink: 0;
            }

            .detail-value {
                width: 100%;
                max-width: 100%;
                word-wrap: break-word;
                overflow-wrap: break-word;
                word-break: break-word;
                min-width: 0;
                overflow: hidden;
            }

            /* Returns */
            .return-item .order-info {
                width: 100%;
            }

            /* Charts canvas */
            canvas {
                max-width: 100%;
                height: auto !important;
            }

            .chart-container {
                height: 320px !important;
                min-height: 320px !important;
            }

            @media (max-width: 480px) {
                .chart-container {
                    height: 300px !important;
                    min-height: 300px !important;
                }
            }

            /* Back button */
            .back-btn {
                top: 10px;
                right: 10px;
                padding: 8px 16px;
                font-size: 12px;
            }

            /* Revenue values - prevent overflow */
            #admin-dashboard-page .text-3xl.font-bold {
                font-size: 1.125rem !important;
                line-height: 1.375rem !important;
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: normal;
            }

            /* Yearly total text */
            #yearly-total {
                font-size: 14px !important;
                padding: 0 8px;
                word-wrap: break-word;
            }

            /* Chart SVG responsive */
            #admin-dashboard-page svg[viewBox] {
                max-width: 100% !important;
                height: auto !important;
            }

            /* Flex items wrap */
            #admin-dashboard-page .flex.flex-row {
                flex-wrap: wrap;
                gap: 8px;
            }

            /* Prevent horizontal scroll - comprehensive fix */
            #admin-dashboard-page {
                overflow-x: hidden !important;
                width: 100vw !important;
                max-width: 100vw !important;
                position: relative;
            }

            #admin-dashboard-page * {
                max-width: 100%;
                box-sizing: border-box;
            }

            /* Ensure main content doesn't overflow */
            #admin-dashboard-page main {
                overflow-x: hidden !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            /* Grid containers - prevent overflow */
            #admin-dashboard-page .grid {
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box;
                overflow-x: hidden;
            }

            /* Glass cards - ensure they fit */
            #admin-dashboard-page .glass-card {
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box;
                overflow-x: hidden;
            }

            /* Numbers and metrics - ensure they fit */
            #admin-dashboard-page .text-3xl,
            #admin-dashboard-page .text-4xl,
            #admin-dashboard-page .text-2xl {
                word-wrap: break-word;
                overflow-wrap: break-word;
                max-width: 100%;
                display: block;
                font-size: 1.25rem !important;
                line-height: 1.5rem !important;
            }

            /* Metric cards - ensure proper sizing */
            #admin-dashboard-page .glass-card > div {
                padding: 12px !important;
            }

            /* Metric values in cards */
            #admin-dashboard-page .glass-card .text-3xl,
            #admin-dashboard-page .glass-card .text-4xl {
                font-size: 1.5rem !important;
                line-height: 1.75rem !important;
            }

            /* Metric labels */
            #admin-dashboard-page .glass-card .text-sm,
            #admin-dashboard-page .glass-card .text-xs {
                font-size: 0.7rem !important;
            }

            /* Content page padding */
            #admin-dashboard-page .content-page {
                padding: 0 !important;
                width: 100%;
                max-width: 100%;
            }

            /* Grid gap reduction */
            #admin-dashboard-page .gap-4 {
                gap: 8px !important;
            }

            #admin-dashboard-page .gap-6 {
                gap: 12px !important;
            }

            /* Text sizes for mobile */
            #admin-dashboard-page .text-sm {
                font-size: 0.75rem !important;
            }

            #admin-dashboard-page .text-xs {
                font-size: 0.625rem !important;
            }

            /* Card padding reduction */
            #admin-dashboard-page .glass-card > div {
                padding: 10px !important;
            }

            /* Headings */
            #admin-dashboard-page h1 {
                font-size: 1.5rem !important;
                line-height: 1.75rem !important;
            }

            #admin-dashboard-page h3 {
                font-size: 0.875rem !important;
                line-height: 1.125rem !important;
            }

            /* Sidebar mobile */
            #admin-sidebar {
                width: 260px !important;
                padding: 20px 0 !important;
            }

            #admin-sidebar .p-6 {
                padding: 12px !important;
            }

            #admin-sidebar .p-4 {
                padding: 10px !important;
            }

            /* Sidebar navigation icons - reduce size */
            #admin-sidebar .nav-link svg,
            #admin-sidebar .h-5.w-5 {
                width: 1rem !important;
                height: 1rem !important;
            }

            /* Reduce gap between icon and text in sidebar */
            #admin-sidebar .nav-link.gap-3 {
                gap: 0.5rem !important;
            }

            /* Mobile menu button */
            #admin-mobile-menu-btn {
                padding: 8px !important;
                min-width: 40px;
                min-height: 40px;
            }

            #admin-mobile-menu-btn svg,
            #admin-menu-icon,
            #admin-close-icon {
                width: 1.125rem !important;
                height: 1.125rem !important;
            }

            /* Card/metric icons - reduce size */
            #admin-dashboard-page .glass-card svg,
            #admin-dashboard-page .h-4.w-4,
            #admin-dashboard-page svg.h-4,
            #admin-dashboard-page svg.w-4 {
                width: 0.875rem !important;
                height: 0.875rem !important;
            }

            /* Button icons */
            #admin-dashboard-page .btn svg,
            #admin-dashboard-page button svg {
                width: 0.875rem !important;
                height: 0.875rem !important;
            }

            /* Revenue page specific */
            #admin-revenue-content .text-3xl {
                font-size: 1rem !important;
            }

            /* Staff page */
            #admin-staff-content table {
                font-size: 0.7rem !important;
            }

            /* Inventory/Kanban page */
            #admin-inventory-content {
                overflow-x: hidden;
            }

            /* Analytics page */
            #admin-analytics-content .glass-card {
                min-width: 0;
            }

            /* Override inline styles for mobile */
            #admin-dashboard-page [style*="font-size: 18px"],
            #admin-dashboard-page [style*="font-size: 16px"] {
                font-size: 14px !important;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            /* Ensure all text elements wrap */
            #admin-dashboard-page p,
            #admin-dashboard-page span,
            #admin-dashboard-page div,
            #admin-dashboard-page label {
                word-wrap: break-word;
                overflow-wrap: break-word;
                word-break: break-word;
            }

            /* Long text values */
            #admin-dashboard-page .text-white,
            #admin-dashboard-page .text-accent {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            /* Revenue values that might be long */
            #total-revenue,
            #revenue-total,
            #revenue-avg-order-value {
                font-size: 1rem !important;
                word-wrap: break-word;
                white-space: normal;
            }
        }

        @media (max-width: 480px) {
            /* Admin dashboard extra small screens - additional fixes */
            #admin-dashboard-page [style*="font-size: 18px"] {
                font-size: 12px !important;
            }

            #admin-dashboard-page [style*="font-size: 16px"] {
                font-size: 11px !important;
            }

            #yearly-total {
                font-size: 12px !important;
            }

            #total-revenue,
            #revenue-total,
            #revenue-avg-order-value {
                font-size: 0.875rem !important;
            }
        }

        @media (max-width: 768px) {
            .orders-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .order-bubble {
                padding: 8px;
            }

            .order-header {
                gap: 8px;
            }

            .order-image {
                width: 50px;
                height: 50px;
            }

            .customer-name {
                font-size: 13px;
            }

            .product-name {
                font-size: 11px;
            }

            .product-color {
                font-size: 10px;
                padding: 3px 8px;
            }

            .order-actions {
                flex-direction: column;
                gap: 6px;
                margin-top: 8px;
            }

            .order-actions .btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .order-details {
                margin-top: 8px;
                padding-top: 8px;
            }

            .detail-row {
                margin-bottom: 4px;
                font-size: 11px;
                flex-wrap: wrap;
            }

            .detail-label {
                width: 90px;
                font-size: 11px;
                flex-shrink: 0;
            }

            .detail-value {
                font-size: 11px;
                word-wrap: break-word;
                overflow-wrap: break-word;
                word-break: break-word;
                min-width: 0;
                max-width: 100%;
                overflow: hidden;
            }
        }

        @media (max-width: 480px) {
            /* Search bar extra small screens */
            .search-section {
                padding: 0 8px !important;
                margin-bottom: 16px !important;
            }

            .search-input {
                padding: 10px 40px 10px 36px !important;
                font-size: 12px !important;
                border-radius: 10px !important;
            }

            .search-input::placeholder {
                font-size: 12px !important;
            }

            .search-icon {
                left: 10px !important;
                width: 16px !important;
                height: 16px !important;
            }

            .clear-search-btn {
                right: 8px !important;
                width: 20px !important;
                height: 20px !important;
            }

            .clear-search-btn svg {
                width: 14px !important;
                height: 14px !important;
            }

            /* Admin dashboard extra small screens */
            #admin-dashboard-page main {
                padding: 8px !important;
            }

            #admin-dashboard-page .p-6,
            #admin-dashboard-page .p-8 {
                padding: 8px !important;
            }

            #admin-dashboard-page .glass-card {
                padding: 8px !important;
            }

            #admin-dashboard-page .glass-card .p-6 {
                padding: 8px !important;
            }

            #admin-dashboard-page .text-4xl {
                font-size: 1.25rem !important;
            }

            #admin-dashboard-page .text-3xl {
                font-size: 1rem !important;
            }

            #admin-dashboard-page .text-2xl {
                font-size: 0.875rem !important;
            }

            #admin-dashboard-page h1 {
                font-size: 1.25rem !important;
            }

            #admin-dashboard-page .text-sm {
                font-size: 0.7rem !important;
            }

            #admin-dashboard-page .text-xs {
                font-size: 0.6rem !important;
            }

            #admin-dashboard-page .gap-4 {
                gap: 6px !important;
            }

            #admin-dashboard-page .gap-6 {
                gap: 8px !important;
            }

            #admin-dashboard-page .space-y-6 > * + * {
                margin-top: 12px !important;
            }

            #admin-dashboard-page .space-y-4 > * + * {
                margin-top: 8px !important;
            }

            /* Chart containers - larger on extra small screens (480px and below) */
            #admin-dashboard-page .chart-container {
                height: 300px !important;
                min-height: 300px !important;
                max-width: 100% !important;
                width: 100% !important;
                overflow-x: auto;
                overflow-y: hidden;
                box-sizing: border-box;
                -webkit-overflow-scrolling: touch;
            }

            #admin-dashboard-page .chart-container svg {
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                min-width: 0 !important;
                min-height: 200px !important;
                max-height: 300px !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            #admin-dashboard-page canvas {
                max-width: 100% !important;
                width: 100% !important;
                height: auto !important;
                display: block;
            }

            /* Chart cards - reduce padding on mobile */
            #admin-dashboard-page .glass-card .chart-container {
                padding: 0 !important;
                margin: 0 !important;
            }

            /* Chart titles */
            #admin-dashboard-page .glass-card h3 {
                font-size: 0.875rem !important;
                margin-bottom: 8px !important;
            }

            /* Tables */
            #admin-dashboard-page table {
                font-size: 0.65rem !important;
            }

            #admin-dashboard-page th,
            #admin-dashboard-page td {
                padding: 6px 2px !important;
                font-size: 0.65rem !important;
            }

            .orders-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }

            .order-bubble {
                padding: 6px;
                max-width: 100%;
                overflow: hidden;
            }

            .order-header {
                gap: 6px;
            }

            .order-info {
                min-width: 0;
                flex: 1 1 auto;
            }

            .customer-name,
            .product-name,
            .product-color {
                max-width: 100%;
                overflow-wrap: break-word;
                word-break: break-word;
            }

            .order-image {
                width: 45px;
                height: 45px;
            }

            .customer-name {
                font-size: 12px;
            }

            .product-name {
                font-size: 10px;
            }

            .product-color {
                font-size: 9px;
                padding: 2px 6px;
            }

            .order-actions {
                flex-direction: column;
                gap: 4px;
                margin-top: 6px;
            }

            .order-actions .btn {
                padding: 5px 8px;
                font-size: 10px;
            }

            .detail-row {
                font-size: 10px;
            }

            .detail-label {
                width: 80px;
                font-size: 10px;
            }

            .detail-value {
                font-size: 10px;
            }

            /* Order details should only show when expanded */
            #newRequestsContainer .order-details,
            #inProgressContainer .order-details,
            #toDeliverContainer .order-details {
                display: none;
            }

            #newRequestsContainer .order-bubble.expanded .order-details,
            #inProgressContainer .order-bubble.expanded .order-details,
            #toDeliverContainer .order-bubble.expanded .order-details {
                display: block;
                margin-top: 8px;
                padding-top: 8px;
            }

            .detail-row {
                margin-bottom: 4px;
                font-size: 11px;
                flex-direction: column;
                gap: 2px;
            }

            .detail-label {
                width: 100%;
                font-size: 11px;
                flex-shrink: 0;
            }

            .detail-value {
                font-size: 11px;
                word-wrap: break-word;
                overflow-wrap: break-word;
                word-break: break-word;
                min-width: 0;
                width: 100%;
                max-width: 100%;
                overflow: hidden;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            #catalogue-products-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }

            /* Make Add Product form even more compact on very small screens */
            #add-product-panel {
                padding: 12px !important;
            }

            #add-product-panel .chart-title {
                font-size: 16px !important;
                padding: 10px 12px !important;
                margin-bottom: 10px !important;
            }

            #add-product-form {
                gap: 10px !important;
            }

            #image-upload-area {
                height: 120px !important;
            }

            .welcome-section h1 {
                font-size: 20px;
            }

            .section-header h2 {
                font-size: 18px;
            }

            .main-content {
                padding: 15px 10px;
            }

            .orders-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .order-bubble {
                padding: 8px;
            }

            .stat-card {
                padding: 12px;
            }

            .chart-card {
                padding: 12px;
            }

            /* Table even more compact on very small screens */
            th, td {
                padding: 6px 2px;
                font-size: 10px;
            }

            th:nth-child(2), td:nth-child(2) {
                font-size: 9px;
            }

            th:nth-child(5), td:nth-child(5) {
                font-size: 9px;
            }

            th:nth-child(6), td:nth-child(6) {
                font-size: 9px;
            }
        }

        /* Admin Dashboard Styles - General Fixes */
        /* Make admin dashboard more compact and presentable like employee dashboard */
        #admin-dashboard-page .text-4xl {
            font-size: 1.75rem !important;
            line-height: 1.2 !important;
        }

        #admin-dashboard-page .text-3xl {
            font-size: 1.5rem !important;
            line-height: 1.2 !important;
        }

        #admin-dashboard-page .text-2xl {
            font-size: 1.25rem !important;
            line-height: 1.2 !important;
        }

        #admin-dashboard-page .p-6 {
            padding: 1rem !important;
        }

        #admin-dashboard-page .p-8 {
            padding: 1.25rem !important;
        }

        #admin-dashboard-page main {
            padding: 1rem !important;
        }

        #admin-dashboard-page .glass-card {
            padding: 1rem !important;
        }

        #admin-dashboard-page .gap-4 {
            gap: 0.75rem !important;
        }

        #admin-dashboard-page .gap-6 {
            gap: 1rem !important;
        }

        #admin-dashboard-page .space-y-6 > * + * {
            margin-top: 1rem !important;
        }

        /* Ensure text doesn't overflow */
        #admin-dashboard-page * {
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        /* Revenue values */
        #total-revenue,
        #revenue-total,
        #revenue-avg-order-value,
        #revenue-growth-rate,
        #revenue-gross-income {
            font-size: 1.25rem !important;
            word-wrap: break-word;
            white-space: normal;
        }

        /* Table improvements */
        #admin-dashboard-page table {
            width: 100%;
            table-layout: auto;
        }

        #admin-dashboard-page th,
        #admin-dashboard-page td {
            padding: 0.5rem !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Staff cards */
        #admin-staff-content .glass-card {
            min-width: 0;
            overflow: hidden;
        }

        /* Staff management page - fix card sizes and text overflow */
        #admin-staff-content .staff-card {
            max-width: 100%;
            overflow: hidden;
            word-wrap: break-word;
        }

        #admin-staff-content .staff-card * {
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        /* Delete overlay fix */
        #admin-staff-content .delete-staff-overlay {
            max-width: 100%;
            overflow: hidden;
        }

        /* Staff card mobile fixes */
        @media (max-width: 768px) {
            #admin-staff-content .staff-card {
                padding: 12px !important;
                margin-bottom: 12px !important;
            }

            #admin-staff-content .delete-staff-overlay {
                padding: 8px !important;
                font-size: 0.75rem !important;
            }

            .delete-staff-btn {
                padding: 6px 10px !important;
                font-size: 0.7rem !important;
                min-height: 28px !important;
                width: auto !important;
                max-width: 100% !important;
            }

            .delete-staff-btn svg {
                width: 12px !important;
                height: 12px !important;
            }
        }

        /* Staff table improvements */
        #admin-staff-content table {
            width: 100%;
            table-layout: auto;
        }

        #admin-staff-content th,
        #admin-staff-content td {
            padding: 0.5rem !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 200px;
        }

        /* Chart containers */
        #admin-dashboard-page .chart-container {
            max-width: 100%;
            overflow-x: auto;
        }

        .min-h-screen {
            min-height: 100vh;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .flex-row {
            flex-direction: row;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .justify-center {
            justify-content: center;
        }

        .p-6 {
            padding: 1.5rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .pb-2 {
            padding-bottom: 0.5rem;
        }

        .gap-3 {
            gap: 0.75rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .gap-6 {
            gap: 1.5rem;
        }

        .space-y-1 > * + * {
            margin-top: 0.25rem;
        }

        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }

        .space-y-4 > * + * {
            margin-top: 1rem;
        }

        .space-y-6 > * + * {
            margin-top: 1.5rem;
        }

        .text-xs {
            font-size: 0.75rem;
            line-height: 1rem;
        }

        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }

        .text-2xl {
            font-size: 1.5rem;
            line-height: 2rem;
        }

        .text-3xl {
            font-size: 1.875rem;
            line-height: 2.25rem;
        }

        .text-4xl {
            font-size: 2.25rem;
            line-height: 2.5rem;
        }

        .font-bold {
            font-weight: 700;
        }

        .font-medium {
            font-weight: 500;
        }

        .font-semibold {
            font-weight: 600;
        }

        .text-white {
            color: #E0D8C9;
        }

        .text-white\/70 {
            color: rgba(224, 216, 201, 0.7);
        }

        .text-white\/60 {
            color: rgba(224, 216, 201, 0.6);
        }

        .text-white\/80 {
            color: rgba(224, 216, 201, 0.8);
        }

        .text-accent {
            color: #E0D8C9;
        }

        .text-accent-foreground {
            color: #3C3F3E;
        }

        .text-primary-foreground {
            color: #3C3F3E;
        }

        .text-secondary-foreground {
            color: #3C3F3E;
        }

        .bg-accent {
            background-color: #E0D8C9;
        }

        .bg-primary {
            background-color: #D4C5B0;
        }

        .bg-secondary {
            background-color: #C9B9A2;
        }

        .hover\:bg-white\/15:hover {
            background-color: rgba(224, 216, 201, 0.1);
        }

        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }

        .duration-300 {
            transition-duration: 300ms;
        }

        .duration-200 {
            transition-duration: 200ms;
        }

        .rounded-md {
            border-radius: 0.375rem;
        }

        .rounded-lg {
            border-radius: 0.5rem;
        }

        .w-full {
            width: 100%;
        }

        .w-4 {
            width: 1rem;
        }

        .w-5 {
            width: 1.25rem;
        }

        .h-4 {
            height: 1rem;
        }

        .h-5 {
            height: 1.25rem;
        }

        /* Icon size adjustments for admin dashboard - general */
        /* Sidebar navigation icons - make smaller */
        #admin-sidebar .nav-link svg.h-5.w-5,
        #admin-sidebar .nav-link .h-5,
        #admin-sidebar .nav-link .w-5,
        #admin-sidebar .nav-link svg {
            width: 1rem !important;
            height: 1rem !important;
        }

        /* Reduce gap between icon and text in sidebar */
        #admin-sidebar .nav-link.gap-3 {
            gap: 0.625rem !important;
        }

        /* Card/metric icons in admin dashboard - make smaller */
        #admin-dashboard-page .glass-card svg.h-4.w-4,
        #admin-dashboard-page .glass-card .h-4,
        #admin-dashboard-page .glass-card .w-4 {
            width: 0.875rem !important;
            height: 0.875rem !important;
        }

        /* Button icons in admin dashboard */
        #admin-dashboard-page .btn svg,
        #admin-dashboard-page button svg:not(.chart-bars):not(.chart-labels),
        #admin-sidebar .btn svg,
        #admin-sidebar button svg {
            width: 0.875rem !important;
            height: 0.875rem !important;
        }

        /* Sidebar button gap reduction */
        #admin-sidebar .btn.gap-2 {
            gap: 0.5rem !important;
        }

        /* Mobile menu button icons */
        #admin-mobile-menu-btn svg,
        #admin-menu-icon,
        #admin-close-icon {
            width: 1.125rem !important;
            height: 1.125rem !important;
        }

        /* Icon size adjustments for admin dashboard - mobile */
        @media (max-width: 768px) {
            /* Sidebar icons - even smaller on mobile */
            #admin-sidebar .nav-link svg,
            #admin-sidebar .h-5.w-5 {
                width: 0.875rem !important;
                height: 0.875rem !important;
            }

            /* Card icons in admin dashboard - smaller on mobile */
            #admin-dashboard-page .glass-card svg,
            #admin-dashboard-page .h-4.w-4,
            #admin-dashboard-page svg.h-4,
            #admin-dashboard-page svg.w-4 {
                width: 0.75rem !important;
                height: 0.75rem !important;
            }

            /* All SVG icons in admin dashboard - except charts */
            #admin-dashboard-page svg:not(.chart-bars):not(.chart-labels):not([viewBox*="800"]):not([viewBox*="200"]) {
                max-width: 0.875rem !important;
                max-height: 0.875rem !important;
            }

            /* Mobile menu button icons */
            #admin-mobile-menu-btn svg,
            #admin-menu-icon,
            #admin-close-icon {
                width: 1rem !important;
                height: 1rem !important;
            }
        }

        .w-64 {
            width: 16rem;
        }

        .h-full {
            height: 100%;
        }

        .flex-1 {
            flex: 1 1 0%;
        }

        .fixed {
            position: fixed;
        }

        .inset-y-0 {
            top: 0;
            bottom: 0;
        }

        .inset-0 {
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .left-0 {
            left: 0;
        }

        .right-4 {
            right: 1rem;
        }

        .top-4 {
            top: 1rem;
        }

        .z-30 {
            z-index: 30;
        }

        .z-40 {
            z-index: 40;
        }

        .z-50 {
            z-index: 50;
        }

        .bg-white\/20 {
            background-color: rgba(224, 216, 201, 0.15);
        }

        .bg-white\/10 {
            background-color: rgba(224, 216, 201, 0.08);
        }

        .bg-background\/80 {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .backdrop-blur-sm {
            backdrop-filter: blur(4px);
        }

        .border-r {
            border-right-width: 1px;
        }

        .border-b {
            border-bottom-width: 1px;
        }

        .border-t {
            border-top-width: 1px;
        }

        .border-white\/20 {
            border-color: rgba(224, 216, 201, 0.2) !important;
        }

        .border-white\/30 {
            border-color: rgba(224, 216, 201, 0.3) !important;
        }

        .glass-card-strong .border-white\/20 {
            border-color: rgba(224, 216, 201, 0.2) !important;
        }

        .px-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .py-3 {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }

        .mb-2 {
            margin-bottom: 0.5rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        .mr-2 {
            margin-right: 0.5rem;
        }

        .lg\:pl-64 {
            padding-left: 16rem;
        }

        main.lg\:pl-64 {
            background: #FAFAFA;
            min-height: 100vh;
        }

        main.lg\:pl-64 .text-white {
            color: #41463F;
        }

        main.lg\:pl-64 .text-white\/70 {
            color: rgba(65, 70, 63, 0.7);
        }

        main.lg\:pl-64 .text-white\/60 {
            color: rgba(65, 70, 63, 0.6);
        }

        main.lg\:pl-64 .text-white\/80 {
            color: rgba(65, 70, 63, 0.8);
        }

        main.lg\:pl-64 .text-accent {
            color: #41463F;
        }

        .lg\:p-8 {
            padding: 2rem;
        }

        .lg\:translate-x-0 {
            transform: translateX(0);
        }

        .-translate-x-full {
            transform: translateX(-100%);
        }

        .translate-x-0 {
            transform: translateX(0);
        }

        .grid {
            display: grid;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .grid-cols-4 {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }

        .md\:grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .md\:grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .md\:grid-cols-4 {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }

        .lg\:grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .lg\:grid-cols-4 {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }

        .overflow-y-auto {
            overflow-y: auto;
        }

        .content-page {
            display: block;
        }

        .content-page.hidden {
            display: none;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
            padding: 0.5rem 1rem;
            cursor: pointer;
            text-decoration: none;
        }

        .btn-outline {
            background: transparent;
            border-color: rgba(224, 216, 201, 0.2);
            color: #E0D8C9;
        }

        .btn-outline:hover {
            background: rgba(224, 216, 201, 0.1);
        }

        .glass-card-strong .btn-outline {
            border-color: rgba(224, 216, 201, 0.2) !important;
            color: #FAFAFA;
        }

        .glass-card-strong .btn-outline:hover {
            background: rgba(250, 250, 250, 0.1);
        }

        .delete-staff-btn:hover {
            background: rgba(239, 68, 68, 0.3) !important;
            border-color: rgba(239, 68, 68, 0.6) !important;
            transform: translateY(-1px);
        }

        /* Delete staff button mobile sizing */
        @media (max-width: 768px) {
            .delete-staff-btn {
                padding: 6px 12px !important;
                font-size: 0.75rem !important;
                min-height: 32px !important;
            }

            .delete-staff-btn svg {
                width: 14px !important;
                height: 14px !important;
            }
        }

        .btn-icon {
            padding: 0.5rem;
            width: 2.5rem;
            height: 2.5rem;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            position: relative;
        }

        .glass-card-strong {
            background: #41463F;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(224, 216, 201, 0.2) !important;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
        }

        .glass-card-strong .text-white {
            color: #FAFAFA;
        }

        .glass-card-strong .text-white\/70 {
            color: rgba(250, 250, 250, 0.7);
        }

        .glass-card-strong .text-white\/60 {
            color: rgba(250, 250, 250, 0.6);
        }

        .glass-card-strong .text-white\/80 {
            color: rgba(250, 250, 250, 0.8);
        }

        .glass-card-strong .nav-link {
            color: rgba(250, 250, 250, 0.8);
        }

        .glass-card-strong .nav-link:hover {
            color: #FAFAFA;
        }

        .glass-card-strong .nav-link.active {
            color: #FAFAFA;
        }

        .glass-card {
            background: rgba(224, 216, 201, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(224, 216, 201, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
        }

        @media (min-width: 768px) {
            .md\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .md\:grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
            .md\:grid-cols-4 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }

        @media (min-width: 1024px) {
            .lg\:translate-x-0 {
                transform: translateX(0);
            }
            .lg\:pl-64 {
                padding-left: 16rem;
            }
            .lg\:p-8 {
                padding: 2rem;
            }
            .lg\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .lg\:grid-cols-4 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }

        /* Global mobile overflow prevention */
        @media (max-width: 768px) {
            * {
                max-width: 100vw;
            }

            body, html {
                overflow-x: hidden !important;
                width: 100% !important;
                max-width: 100% !important;
                position: relative;
            }

            /* Ensure all containers respect viewport */
            .container, .main-content, .login-container, .login-card,
            .glass-card, .table-container, .kanban-container,
            section, div[class*="container"], div[class*="wrapper"] {
                max-width: 100% !important;
                width: 100% !important;
                overflow-x: hidden;
            }

            /* Prevent tables from causing horizontal scroll */
            table {
                width: 100% !important;
                max-width: 100% !important;
                table-layout: fixed;
            }

            /* Ensure inputs and form elements don't overflow */
            input, textarea, select, button {
                max-width: 100% !important;
                box-sizing: border-box;
            }

            /* Fix any elements with fixed positioning */
            [style*="position: fixed"], [style*="position:absolute"] {
                max-width: 100vw !important;
            }
        }

        /* PWA Install Prompt Styles */
        .pwa-install-prompt {
            display: none; /* Hidden by default */
            position: relative;
            background: linear-gradient(135deg, #1B4D3E 0%, #1a5a47 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            align-items: center;
            gap: 16px;
            width: 100%;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex-wrap: nowrap;
            box-sizing: border-box;
        }

        /* Show on login page by default (mobile) */
        #login-page .pwa-install-prompt {
            display: flex;
        }

        /* Desktop styles - positioned below login button */
        @media (min-width: 641px) {
            /* Make login-card a flex container to control order */
            #login-page .login-card {
                display: flex;
                flex-direction: column;
            }

            /* Order elements: header first, form second, install prompt third */
            #login-page .login-header {
                order: 1;
            }

            #login-page #login-form {
                order: 2;
            }

            #login-page .pwa-install-prompt {
                order: 3;
                position: relative !important;
                bottom: auto !important;
                top: auto !important;
                left: auto !important;
                right: auto !important;
                transform: none !important;
                width: 100% !important;
                min-width: auto !important;
                max-width: 100% !important;
                margin-top: 24px !important;
                margin-bottom: 0 !important;
                padding: 16px 20px !important;
                gap: 16px !important;
                z-index: 1 !important;
                animation: none !important;
                backdrop-filter: none !important;
                display: flex;
                flex-wrap: nowrap;
                align-items: center;
            }

            #login-page #messages {
                order: 4;
            }

            .pwa-install-prompt.hidden {
                display: none !important;
            }

            .pwa-install-prompt-content {
                gap: 12px;
                margin-right: 0;
                align-items: center;
                flex: 1;
                min-width: 0;
                overflow: visible !important;
            }

            .pwa-install-text {
                min-width: 0;
                overflow: visible;
                flex: 1;
            }

            .pwa-install-text h3 {
                white-space: nowrap;
                overflow: visible;
                font-size: 15px;
                margin: 0 0 2px 0;
            }

            .pwa-install-text p {
                white-space: nowrap;
                overflow: visible;
                font-size: 12px;
                margin: 0;
            }

            .pwa-install-buttons {
                margin-left: 0;
                flex-shrink: 0;
                gap: 8px;
            }
            
            .pwa-install-btn,
            .pwa-dismiss-btn {
                padding: 8px 16px;
                font-size: 13px;
            }
        }

        /* Hide when dismissed or on dashboard pages */
        .pwa-install-prompt.hidden {
            display: none !important;
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .pwa-install-prompt-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
            overflow: hidden;
        }

        .pwa-install-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .pwa-install-text {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .pwa-install-text h3 {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .pwa-install-text p {
            font-size: 13px;
            margin: 0;
            opacity: 0.9;
        }

        .pwa-install-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            align-items: center;
        }

        .pwa-install-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            color: #1B4D3E;
        }

        .pwa-install-btn:hover {
            background: #f0f0f0;
            transform: translateY(-1px);
        }

        .pwa-install-btn:active {
            transform: translateY(0);
        }

        .pwa-dismiss-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .pwa-dismiss-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        @media (max-width: 640px) {
            .pwa-install-prompt {
                flex-direction: column;
                align-items: stretch;
                padding: 14px 16px;
            }

            .pwa-install-prompt-content {
                flex-direction: row;
                margin-bottom: 12px;
            }

            .pwa-install-buttons {
                width: 100%;
                display: flex;
                gap: 8px;
            }

            .pwa-install-btn,
            .pwa-dismiss-btn {
                flex: 1;
                padding: 10px 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-card">
            <!-- PWA Install Prompt -->
            <div id="pwa-install-prompt" class="pwa-install-prompt">
                <div class="pwa-install-prompt-content">
                    <div class="pwa-install-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div class="pwa-install-text">
                        <h3>Install Apparel Modest</h3>
                        <p>Add to your home screen for quick access</p>
                    </div>
                </div>
                <div class="pwa-install-buttons">
                    <button id="pwa-install-btn" class="pwa-install-btn">Install</button>
                    <button id="pwa-dismiss-btn" class="pwa-dismiss-btn">Not Now</button>
                </div>
            </div>
            <div class="login-header">
                <h1>Apparel Modest</h1>
                <p>Enter your email to login</p>
                <p style="font-size: 13px; margin-top: 8px; opacity: 0.9;">Your OTP will be valid for 1 month. After expiration, you must renew it to continue.</p>
            </div>
            
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label" for="email">Email Address</label>
                    <input type="email" id="email" class="form-input" placeholder="your.email@example.com" required>
                </div>
                
                <div id="otp-group" class="form-group hidden">
                    <label class="form-label" for="otp">Enter OTP Code</label>
                    <input type="text" id="otp" class="form-input" placeholder="123456" maxlength="6" pattern="[0-9]{6}">
                    <p style="color: rgba(224, 216, 201, 0.7); font-size: 12px; margin-top: 5px;">Check your email for the 6-digit code</p>
                    <div id="otp-remaining-time" style="color: rgba(16, 185, 129, 0.9); font-size: 12px; margin-top: 5px; font-weight: 500;"></div>
                    <div id="otp-expired-warning" style="color: rgba(239, 68, 68, 0.9); font-size: 12px; margin-top: 5px; font-weight: 500; display: none;"></div>
                    
                    <!-- OTP Sent Indicator -->
                    <div id="otp-sent-indicator" class="otp-sent-indicator hidden">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>OTP sent successfully to <span class="email-text" id="sent-email-text"></span></span>
                    </div>
                </div>
                
                <button type="submit" class="btn-login" id="login-btn">Login</button>
                <button type="button" class="btn-otp" id="send-otp-btn">Send OTP Code</button>
            </form>
            
            <div id="messages"></div>
        </div>
    </div>

    <!-- Dashboard (initially hidden) -->
    <div id="dashboard-page" class="dashboard hidden">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobile-menu-btn" style="display: none;">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo">
                <h2>Apparel Digital</h2>
                <p>Employee Portal</p>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" data-tab="home">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span>Home</span>
                </div>
                <div class="nav-item" data-tab="new-requests">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                    <span>Sales</span>
                </div>
                <div class="nav-item" data-tab="in-progress">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Production</span>
                </div>
                <div class="nav-item" data-tab="to-deliver">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                    </svg>
                    <span>Logistics</span>
                </div>
                <div class="nav-item" data-tab="completed">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>After Sales</span>
                </div>
                <div class="nav-item" data-tab="returns">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    <span>Returns</span>
                </div>
                <div class="nav-item" data-tab="catalogue">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span>Add Catalogue</span>
                </div>
                <div class="nav-item" data-tab="inperson-order">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>In-Person Order</span>
                </div>
                <div class="nav-item" data-tab="deleted-orders">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    <span>Trash</span>
                </div>
            </nav>
            
            <!-- Admin View Button and Logout (in sidebar footer) -->
            <div style="padding: 20px; border-top: 1px solid rgba(224, 216, 201, 0.2); margin-top: auto;">
                <!-- Admin View Button (only for admin user) -->
                <div id="admin-view-section" class="hidden">
                    <button class="admin-view-btn" id="admin-view-btn" style="width: 100%;">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                        </svg>
                        Admin View
                    </button>
                </div>
                
                <!-- Clear Cache Button -->
                <button class="admin-view-btn" id="clear-cache-button" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Clear Cache & Reload
                </button>
                
                <!-- Logout Button -->
                <button class="admin-view-btn" id="logout-button" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #E0D8C9 0%, #D4C5B0 100%);">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                    </svg>
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Home Tab -->
            <div class="tab-content active" id="home">
                <div class="welcome-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; position: relative; z-index: 2;">
                        <div>
                            <h1 id="welcome-heading">Welcome back! </h1>
                            <p id="welcome-date">Loading...</p>
                        </div>
                        <button class="btn btn-accept" id="profile-btn-home" style="display: flex; align-items: center; gap: 8px; position: relative; z-index: 20; touch-action: manipulation; -webkit-tap-highlight-color: transparent; user-select: none;">
                            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="pointer-events: none;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            Profile
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Currently in Sales</div>
                        <div class="stat-value">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Currently in Production</div>
                        <div class="stat-value">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Currently in Logistics</div>
                        <div class="stat-value">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total After Sales</div>
                        <div class="stat-value">0</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">Orders This Week</div>
                        <canvas id="weeklyChart" width="400" height="250"></canvas>
                        <div id="weekly-total" style="text-align: center; margin-top: 12px; font-size: 16px; font-weight: 600; color: #41463F;">
                            Total Orders This Week: <span id="weekly-total-value">0</span>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">Weekly Order Status Distribution</div>
                        <canvas id="statusChart" width="400" height="250"></canvas>
                    </div>
                </div>

                <!-- Customer Form Link Section -->
                <div class="customer-form-link-card" style="background: rgba(224, 216, 201, 0.1); backdrop-filter: blur(20px); border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); border: 1px solid rgba(224, 216, 201, 0.2); margin-top: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div>
                            <h3 style="font-size: 18px; font-weight: 600; color: #41463F; margin: 0 0 8px 0;">Customer Order Form</h3>
                            <p style="font-size: 14px; color: #6B7280; margin: 0;">Share this link with customers to place orders</p>
                        </div>
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #E0D8C9;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                        </svg>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: center; background: rgba(255, 255, 255, 0.5); border-radius: 12px; padding: 12px; border: 1px solid rgba(224, 216, 201, 0.3);">
                        <input 
                            type="text" 
                            id="customer-form-link" 
                            value="" 
                            readonly 
                            style="flex: 1; background: transparent; border: none; outline: none; font-size: 14px; color: #41463F; font-family: inherit;"
                        />
                        <button 
                            id="copy-link-btn" 
                            class="btn btn-accept" 
                            style="padding: 8px 16px; font-size: 14px; white-space: nowrap; display: flex; align-items: center; gap: 6px;"
                        >
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            <span id="copy-link-text">Copy</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sales Tab -->
            <div class="tab-content" id="new-requests">
                <div class="section-header">
                    <h2>Sales</h2>
                </div>
                <div style="margin-bottom: 20px; padding: 0 20px;">
                    <input type="text" id="salesSearchInput" placeholder="Search by customer name..." 
                           style="width: 100%; padding: 12px 16px; border: 2px solid rgba(27, 77, 62, 0.2); border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.3s;"
                           onfocus="this.style.borderColor='#1B4D3E';" 
                           onblur="this.style.borderColor='rgba(27, 77, 62, 0.2)';">
                </div>
                <div class="orders-container" id="newRequestsContainer"></div>
            </div>

            <!-- Production Tab -->
            <div class="tab-content" id="in-progress">
                <div class="section-header">
                    <h2>Production</h2>
                </div>
                <div class="tab-search-wrapper" style="margin-bottom: 20px; padding: 0 20px;">
                    <input type="text" id="productionSearchInput" placeholder="Search by customer name..." 
                           style="width: 100%; padding: 12px 16px; border: 2px solid rgba(27, 77, 62, 0.2); border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.3s;"
                           onfocus="this.style.borderColor='#1B4D3E';" 
                           onblur="this.style.borderColor='rgba(27, 77, 62, 0.2)';">
                </div>
                <div class="orders-container" id="inProgressContainer"></div>
            </div>

            <!-- Logistics Tab (search bar + checkboxes same as Production) -->
            <div class="tab-content" id="to-deliver">
                <div class="section-header">
                    <h2>Logistics</h2>
                </div>
                <div class="tab-search-wrapper" style="margin-bottom: 20px; padding: 0 20px;">
                    <input type="text" id="logisticsSearchInput" placeholder="Search by customer name..." 
                           style="width: 100%; padding: 12px 16px; border: 2px solid rgba(27, 77, 62, 0.2); border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.3s;"
                           onfocus="this.style.borderColor='#1B4D3E';" 
                           onblur="this.style.borderColor='rgba(27, 77, 62, 0.2)';">
                </div>
                <div class="orders-container" id="toDeliverContainer"></div>
            </div>

            <!-- After Sales Tab -->
            <div class="tab-content" id="completed">
                <div class="section-header">
                    <h2>After Sales</h2>
                </div>
                
                <!-- Search Bar -->
                <div class="search-section" style="margin-bottom: 24px; padding: 0 20px;">
                    <div class="search-input-wrapper" style="position: relative; width: 100%; max-width: 600px; margin: 0 auto;">
                        <input 
                            type="text" 
                            id="afterSalesSearchInput" 
                            placeholder="Search by customer name, phone, item, color..." 
                            class="search-input"
                            autocomplete="off"
                        />
                        <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <button 
                            type="button" 
                            id="clearSearchBtn" 
                            class="clear-search-btn"
                            style="display: none;"
                            aria-label="Clear search"
                        >
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Calendar and Filters -->
                <div class="filters-section">
                    <div class="filter-group">
                        <label class="filter-label">Select Date</label>
                        <div class="date-input-wrapper">
                            <input type="date" id="dateFilter" class="filter-input" style="padding-right: 40px;">
                            <svg class="calendar-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Sort By</label>
                        <select id="sortFilter" class="filter-select">
                            <option value="date">Date (Newest First)</option>
                            <option value="date-oldest">Date (Oldest First)</option>
                            <option value="item-popular">Most Ordered Item</option>
                            <option value="color-popular">Most Ordered Color</option>
                            <option value="price-high">Price (High to Low)</option>
                            <option value="price-low">Price (Low to High)</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Filter by Item</label>
                        <select id="itemFilter" class="filter-select">
                            <option value="">All Items</option>
                            <option value="Midnight Blazer">Midnight Blazer</option>
                            <option value="Aurora Evening Gown">Aurora Evening Gown</option>
                            <option value="Luna Cocktail Dress">Luna Cocktail Dress</option>
                            <option value="Sunset Maxi Dress">Sunset Maxi Dress</option>
                            <option value="Ocean Breeze Romper">Ocean Breeze Romper</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Filter by Color</label>
                        <select id="colorFilter" class="filter-select">
                            <option value="">All Colors</option>
                            <option value="Classic Black">Classic Black</option>
                            <option value="Emerald Green">Emerald Green</option>
                            <option value="Pearl White">Pearl White</option>
                            <option value="Sunset Orange">Sunset Orange</option>
                            <option value="Coral Pink">Coral Pink</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Customer Name</th>
                                <th>Phone Number</th>
                                <th>Item Name</th>
                                <th>Color</th>
                                <th>Price</th>
                                <th>Date Completed</th>
                            </tr>
                        </thead>
                        <tbody id="completedTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Returns Tab -->
            <div class="tab-content" id="returns">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Returns</h2>
                    <button class="btn btn-accept" id="add-return-btn" style="margin-bottom: 0;">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-right: 8px; vertical-align: middle;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add New Return
                    </button>
                </div>
                <div class="orders-container" id="returnsContainer"></div>
            </div>

            <!-- Add Return Modal -->
            <div id="add-return-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                <div class="login-card" style="max-width: 450px; width: 100%; margin: 0; max-height: 90vh; overflow-y: auto;">
                    <div class="login-header">
                        <h1 style="font-size: 24px;">Add New Return</h1>
                        <p style="font-size: 14px;">Fill in the details below</p>
                    </div>
                    <form id="add-return-form">
                        <div class="form-group">
                            <label class="form-label" for="return-client-name">Client Name</label>
                            <input type="text" id="return-client-name" class="form-input" placeholder="Enter client name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Client Number <span class="required">*</span></label>
                            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">
                                <div>
                                    <input type="tel" id="return-country-code" class="form-input" placeholder="+254" maxlength="4" required style="text-align: center;">
                                    <small style="display: block; margin-top: 4px; font-size: 11px; color: rgba(224, 216, 201, 0.7); text-align: center;">Country Code</small>
                                </div>
                                <div>
                                    <input type="tel" id="return-phone-number" class="form-input" placeholder="0712345678" maxlength="15" required>
                                    <small style="display: block; margin-top: 4px; font-size: 11px; color: rgba(224, 216, 201, 0.7);">Phone Number</small>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="return-cloth-item">Cloth Item <span class="required">*</span></label>
                            <div class="search-container" style="position: relative;">
                                <input type="text" id="return-cloth-item" class="form-input" placeholder="Search and select cloth item..." autocomplete="off" required>
                                <div id="return-product-search-results"></div>
                            </div>
                            <div id="return-selected-product-preview">
                                <img id="return-selected-product-image" src="" alt="">
                                <div id="return-selected-product-name"></div>
                            </div>
                            <input type="hidden" id="return-selected-product-id">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="return-comment">Comment about the Issue</label>
                            <textarea id="return-comment" class="form-input" placeholder="Describe the issue..." rows="4" required style="resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button type="submit" class="btn-login" style="flex: 1; margin-bottom: 0;">Add Return</button>
                            <button type="button" class="btn-otp" id="cancel-return-btn" style="flex: 1; margin-bottom: 0;">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Catalogue Tab -->
            <div class="tab-content" id="catalogue">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 style="font-size: 24px; font-weight: 600; color: #41463F; margin-bottom: 4px;">Catalogue</h2>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; margin-bottom: 24px;">
                    <!-- Left Panel - Add Product Form -->
                    <div class="chart-card" id="add-product-panel" style="position: sticky; top: 20px; max-height: calc(100vh - 40px); display: flex; flex-direction: column; overflow: hidden;">
                        <div class="chart-title" style="flex-shrink: 0;">Add New Product</div>
                        <div class="form-scroll-container" style="overflow-y: auto; flex: 1; padding-right: 4px;">
                            <form id="add-product-form" style="display: flex; flex-direction: column; gap: 16px;">
                            <!-- Image Upload -->
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 600; color: rgba(65, 70, 63, 0.9); margin-bottom: 8px;">Upload Image</label>
                                <div id="image-upload-area" style="width: 100%; height: 200px; border: 2px dashed rgba(65, 70, 63, 0.3); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: rgba(65, 70, 63, 0.05); transition: all 0.2s ease; position: relative; overflow: hidden;">
                                    <input type="file" id="product-image-input" accept="image/*" style="position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 2;">
                                    <img id="product-image-preview" src="" alt="" style="display: none; width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;">
                                    <button type="button" id="remove-image-btn" style="display: none; position: absolute; top: 8px; right: 8px; z-index: 3; background: rgba(244, 67, 54, 0.9); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; align-items: center; justify-content: center; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);">
                                        <svg width="18" height="18" fill="none" stroke="white" viewBox="0 0 24 24" style="stroke-width: 2.5;">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M18 18L6 6"/>
                                        </svg>
                                    </button>
                                    <svg id="upload-icon" width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: rgba(65, 70, 63, 0.5); margin-bottom: 8px; z-index: 1;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                    </svg>
                                    <span id="upload-text" style="color: rgba(65, 70, 63, 0.7); font-size: 14px; z-index: 1;">Upload Image</span>
                                </div>
                            </div>

                            <!-- Product Name -->
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 600; color: rgba(65, 70, 63, 0.9); margin-bottom: 8px;">Product Name</label>
                                <input type="text" id="product-name" placeholder="Product" required style="width: 100%; padding: 10px 16px; border: 1px solid rgba(65, 70, 63, 0.3); border-radius: 8px; background: rgba(65, 70, 63, 0.1); color: #41463F; font-size: 14px;">
                            </div>

                            <!-- Category -->
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 600; color: rgba(65, 70, 63, 0.9); margin-bottom: 8px;">Category</label>
                                <select id="product-category" required style="width: 100%; padding: 10px 16px; border: 1px solid rgba(65, 70, 63, 0.3); border-radius: 8px; background: rgba(65, 70, 63, 0.1); color: #41463F; font-size: 14px; cursor: pointer;">
                                    <option value="">Category</option>
                                    <option value="jumpsuits">Jumpsuits</option>
                                    <option value="dresses">Dresses</option>
                                    <option value="skirts">Skirts</option>
                                    <option value="coats">Coats</option>
                                    <option value="trousers">Trousers</option>
                                    <option value="tops">Tops</option>
                                    <option value="accessories">Accessories</option>
                                </select>
                            </div>

                            <!-- Tags -->
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 600; color: rgba(65, 70, 63, 0.9); margin-bottom: 8px;">Tags</label>
                                <input type="text" id="product-tags" placeholder="summer, sale..." style="width: 100%; padding: 10px 16px; border: 1px solid rgba(65, 70, 63, 0.3); border-radius: 8px; background: rgba(65, 70, 63, 0.1); color: #41463F; font-size: 14px;">
                            </div>

                            <!-- Stock -->
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 600; color: rgba(65, 70, 63, 0.9); margin-bottom: 8px;">Stock</label>
                                <input type="number" id="product-stock" placeholder="0" min="0" style="width: 100%; padding: 10px 16px; border: 1px solid rgba(65, 70, 63, 0.3); border-radius: 8px; background: rgba(65, 70, 63, 0.1); color: #41463F; font-size: 14px;">
                            </div>

                            <!-- Price -->
                            <div>
                                <label style="display: block; font-size: 14px; font-weight: 600; color: rgba(65, 70, 63, 0.9); margin-bottom: 8px;">Price (KES)</label>
                                <input type="number" id="product-price" placeholder="0" min="0" required style="width: 100%; padding: 10px 16px; border: 1px solid rgba(65, 70, 63, 0.3); border-radius: 8px; background: rgba(65, 70, 63, 0.1); color: #41463F; font-size: 14px;">
                            </div>

                            <!-- Buttons -->
                            <div style="display: flex; gap: 12px; margin-top: 8px; flex-shrink: 0;">
                                <button type="button" class="btn btn-deny" id="cancel-product-btn" style="flex: 1;">Cancel</button>
                                <button type="submit" class="btn btn-accept" style="flex: 1;">Save Product</button>
                            </div>
                        </form>
                        </div>
                    </div>

                    <!-- Right Panel - Product Listing -->
                    <div>
                        <!-- Search and Filters -->
                        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                            <div style="position: relative; flex: 1; min-width: 200px;">
                                <input type="text" id="catalogue-search" placeholder="Search" style="width: 100%; padding: 10px 16px 10px 40px; border: 1px solid rgba(65, 70, 63, 0.3); border-radius: 8px; background: rgba(65, 70, 63, 0.1); color: #41463F; font-size: 14px; backdrop-filter: blur(10px);">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: rgba(65, 70, 63, 0.6); pointer-events: none;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                            <select id="catalogue-category" class="filter-select" style="min-width: 120px;">
                                <option value="">Category</option>
                                <option value="jumpsuits">Jumpsuits</option>
                                <option value="dresses">Dresses</option>
                                <option value="skirts">Skirts</option>
                                <option value="coats">Coats</option>
                                <option value="trousers">Trousers</option>
                                <option value="tops">Tops</option>
                                <option value="accessories">Accessories</option>
                            </select>
                            <select id="catalogue-sort" class="filter-select" style="min-width: 120px;">
                                <option value="">Sort</option>
                                <option value="name-asc">Name A-Z</option>
                                <option value="name-desc">Name Z-A</option>
                                <option value="price-asc">Price Low-High</option>
                                <option value="price-desc">Price High-Low</option>
                            </select>
                        </div>

                        <!-- Product Grid -->
                        <div id="catalogue-products-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px;">
                            <!-- Products will be dynamically rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- In-Person Order Form Tab -->
            <div class="tab-content" id="inperson-order">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 style="font-size: 24px; font-weight: 600; color: #41463F; margin-bottom: 4px;">In-House Order Form</h2>
                        <p style="font-size: 14px; color: rgba(65, 70, 63, 0.7); margin: 0;">Fill out the order form for in-house customers</p>
                    </div>
                    <button class="btn btn-accept" onclick="window.open('inhouse_order_form.html', '_blank')" style="display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                        Open in New Window
                    </button>
                </div>
                <div id="inhouse-order-form-container" style="width: 100%; max-height: calc(100vh - 200px); overflow-y: auto; overflow-x: visible; padding: 20px; background: #f5f5f5; border-radius: 12px; position: relative;">
                    <style>
                        /* In-House Order Form Styles */
                        #inhouse-order-form-container .inhouse-form-wrapper {
                            max-width: 700px;
                            margin: 0 auto;
                            background: rgba(255, 255, 255, 0.95);
                            border-radius: 16px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                            overflow: visible;
                            position: relative;
                        }
                        #inhouse-order-form-container .inhouse-form-content {
                            padding: 30px;
                        }
                        #inhouse-order-form-container .inhouse-form-group {
                            margin-bottom: 24px;
                        }
                        #inhouse-order-form-container .inhouse-form-group label {
                            display: block;
                            font-size: 14px;
                            font-weight: 600;
                            color: #2d3748;
                            margin-bottom: 8px;
                        }
                        #inhouse-order-form-container .inhouse-form-group input,
                        #inhouse-order-form-container .inhouse-form-group textarea,
                        #inhouse-order-form-container .inhouse-form-group select {
                            width: 100%;
                            padding: 12px 16px;
                            border: 1.5px solid rgba(0, 0, 0, 0.1);
                            border-radius: 8px;
                            font-size: 15px;
                            font-family: inherit;
                            background: #fff;
                            transition: all 0.3s ease;
                        }
                        #inhouse-order-form-container .inhouse-form-group input:focus,
                        #inhouse-order-form-container .inhouse-form-group textarea:focus,
                        #inhouse-order-form-container .inhouse-form-group select:focus {
                            outline: none;
                            border-color: #1B4D3E;
                            box-shadow: 0 0 0 3px rgba(27, 77, 62, 0.1);
                        }
                        #inhouse-order-form-container .inhouse-search-container {
                            position: relative;
                            z-index: 10002;
                        }
                        #inhouse-order-form-container .inhouse-search-backdrop {
                            display: none;
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0, 0, 0, 0.5);
                            z-index: 10001;
                            backdrop-filter: blur(2px);
                        }
                        #inhouse-order-form-container .inhouse-search-backdrop.active {
                            display: block;
                        }
                        #inhouse-order-form-container .inhouse-search-results {
                            position: absolute;
                            top: 100%;
                            left: 0;
                            right: 0;
                            background: rgba(255, 255, 255, 0.98);
                            backdrop-filter: blur(20px);
                            border: 1.5px solid rgba(0, 0, 0, 0.08);
                            border-radius: 12px;
                            margin-top: 6px;
                            max-height: 70vh;
                            overflow-y: auto;
                            overflow-x: hidden;
                            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
                            z-index: 10002;
                            display: none;
                            pointer-events: auto;
                            -webkit-overflow-scrolling: touch;
                            touch-action: pan-y;
                            will-change: transform;
                            min-width: 100%;
                        }
                        #inhouse-order-form-container .inhouse-search-results.active {
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        }
                        #inhouse-order-form-container .inhouse-search-result-item {
                            display: flex;
                            align-items: center;
                            padding: 14px 18px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
                            user-select: none;
                            -webkit-user-select: none;
                            pointer-events: auto;
                            touch-action: manipulation;
                            -webkit-tap-highlight-color: transparent;
                            min-height: 44px;
                            position: relative;
                            z-index: 1;
                        }
                        #inhouse-order-form-container .inhouse-search-result-item:hover,
                        #inhouse-order-form-container .inhouse-search-result-item:active {
                            background: linear-gradient(90deg, rgba(246, 211, 101, 0.1) 0%, rgba(253, 160, 133, 0.1) 100%);
                            transform: translateX(4px);
                        }
                        #inhouse-order-form-container .inhouse-result-image {
                            width: 60px;
                            height: 60px;
                            min-width: 60px;
                            min-height: 60px;
                            object-fit: cover;
                            border-radius: 8px;
                            margin-right: 14px;
                            background: rgba(0, 0, 0, 0.02);
                            display: block;
                            flex-shrink: 0;
                            -webkit-user-drag: none;
                            user-select: none;
                            -webkit-tap-highlight-color: transparent;
                            pointer-events: none;
                        }
                        #inhouse-order-form-container .inhouse-result-info {
                            flex: 1;
                        }
                        #inhouse-order-form-container .inhouse-result-name {
                            font-size: 15px;
                            font-weight: 600;
                            color: #2d3748;
                            margin-bottom: 3px;
                        }
                        #inhouse-order-form-container .inhouse-result-price {
                            font-size: 14px;
                            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            background-clip: text;
                            font-weight: 700;
                        }
                        #inhouse-order-form-container .no-results {
                            padding: 16px;
                            text-align: center;
                            color: #718096;
                        }
                        #inhouse-order-form-container .inhouse-selected-product {
                            display: none;
                            background: rgba(27, 77, 62, 0.05);
                            border-radius: 12px;
                            padding: 16px;
                            margin-top: 12px;
                            align-items: center;
                            border: 1px solid rgba(27, 77, 62, 0.2);
                            position: relative;
                        }
                        #inhouse-order-form-container .inhouse-selected-product.active {
                            display: flex;
                        }
                        #inhouse-order-form-container .inhouse-selected-product-image {
                            width: 80px;
                            height: 80px;
                            object-fit: cover;
                            border-radius: 8px;
                            margin-right: 16px;
                        }
                        #inhouse-order-form-container .inhouse-color-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(36px, 1fr));
                            gap: 10px;
                            margin-top: 12px;
                        }
                        #inhouse-order-form-container .inhouse-color-option {
                            width: 36px;
                            height: 36px;
                            border-radius: 50%;
                            cursor: pointer;
                            border: 3px solid rgba(0, 0, 0, 0.1);
                            transition: all 0.2s;
                        }
                        #inhouse-order-form-container .inhouse-color-option:hover {
                            transform: scale(1.1);
                        }
                        #inhouse-order-form-container .inhouse-color-option.selected {
                            border-color: #1B4D3E;
                            border-width: 4px;
                        }
                        #inhouse-order-form-container .inhouse-submit-btn {
                            width: 100%;
                            padding: 14px;
                            background: #1B4D3E;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            margin-top: 20px;
                            transition: all 0.3s;
                        }
                        #inhouse-order-form-container .inhouse-submit-btn:hover {
                            background: #1a5a47;
                            transform: translateY(-2px);
                        }
                        #inhouse-order-form-container .inhouse-required {
                            color: #dc2626;
                            margin-left: 4px;
                        }
                        #inhouse-order-form-container .inhouse-size-chart {
                            background: #fff;
                            border-radius: 8px;
                            padding: 16px;
                            margin: 16px 0;
                            border: 1px solid rgba(0, 0, 0, 0.1);
                        }
                        #inhouse-order-form-container .inhouse-size-chart-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 12px;
                        }
                        #inhouse-order-form-container .inhouse-size-chart-table th,
                        #inhouse-order-form-container .inhouse-size-chart-table td {
                            padding: 8px;
                            text-align: left;
                            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                            font-size: 13px;
                        }
                        #inhouse-order-form-container .inhouse-size-chart-table th {
                            font-weight: 600;
                        }
                        #inhouse-order-form-container #inhouse-dash-mapContainer {
                            width: 100%;
                            height: 300px;
                            border-radius: 8px;
                            border: 1.5px solid rgba(0, 0, 0, 0.1);
                            margin-top: 12px;
                            position: relative;
                            background: #f0f0f0;
                        }
                        #inhouse-order-form-container #inhouse-dash-map {
                            width: 100%;
                            height: 100%;
                        }

                        /* Mobile responsive styles for in-house search - matching customer form */
                        @media (max-width: 640px) {
                            /* Ensure form containers don't clip the popup */
                            #inhouse-order-form-container {
                                overflow: visible !important;
                            }
                            
                            #inhouse-order-form-container .inhouse-form-wrapper,
                            #inhouse-order-form-container .inhouse-form-content {
                                overflow: visible !important;
                            }
                            
                            #inhouse-order-form-container {
                                overflow: visible !important;
                            }
                            
                            #inhouse-order-form-container .inhouse-form-wrapper,
                            #inhouse-order-form-container .inhouse-form-content,
                            #inhouse-order-form-container .inhouse-form-group {
                                overflow: visible !important;
                            }
                            
                            #inhouse-order-form-container .inhouse-search-container {
                                position: relative !important;
                                z-index: 10002 !important;
                            }
                            
                            #inhouse-order-form-container .inhouse-search-results {
                                position: fixed !important;
                                max-width: calc(100vw - 40px) !important;
                                max-height: 70vh !important;
                                z-index: 10002 !important;
                                background: rgba(255, 255, 255, 0.98) !important;
                                backdrop-filter: blur(20px) !important;
                                border: 1.5px solid rgba(0, 0, 0, 0.08) !important;
                                border-radius: 12px !important;
                                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12) !important;
                                left: 20px !important;
                                right: 20px !important;
                                top: auto !important;
                                bottom: auto !important;
                            }
                            
                            /* Calculate position dynamically via JavaScript */
                            #inhouse-order-form-container .inhouse-search-results.positioned {
                                position: fixed !important;
                            }
                            
                            #inhouse-order-form-container .inhouse-search-results:not(.active) {
                                display: none !important;
                            }
                            
                            #inhouse-order-form-container .inhouse-search-results.active {
                                display: block !important;
                                visibility: visible !important;
                                opacity: 1 !important;
                            }

                            /* Backdrop styling for mobile - same as customer form */
                            #inhouse-order-form-container .inhouse-search-backdrop {
                                display: none;
                            }
                            #inhouse-order-form-container .inhouse-search-backdrop.active {
                                display: block;
                            }
                        }
                    </style>
                    <div class="inhouse-form-wrapper">
                        <form class="inhouse-form-content" id="inhouse-dash-orderForm">
                            <div class="inhouse-form-group">
                                <label for="inhouse-dash-name">Full Name <span class="inhouse-required">*</span></label>
                                <input type="text" id="inhouse-dash-name" required placeholder="Enter customer full name">
                            </div>

                            <div class="inhouse-form-group">
                                <label>WhatsApp Number <span class="inhouse-required">*</span></label>
                                <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px;">
                                    <div>
                                        <input type="tel" id="inhouse-dash-countryCode" required placeholder="+254" maxlength="4" style="text-align: center;">
                                        <small style="display: block; margin-top: 4px; font-size: 11px; color: #718096; text-align: center;">Country</small>
                                    </div>
                                    <div>
                                        <input type="tel" id="inhouse-dash-phoneNumber" required placeholder="0712345678" maxlength="15">
                                        <small style="display: block; margin-top: 4px; font-size: 11px; color: #718096;">Phone</small>
                                    </div>
                                </div>
                            </div>

                            <div class="inhouse-form-group">
                                <label for="inhouse-dash-productSearch">Search Item <span class="inhouse-required">*</span></label>
                                <div class="inhouse-search-container">
                                    <input type="text" id="inhouse-dash-productSearch" placeholder="Type to search items..." autocomplete="off">
                                    <div class="inhouse-search-backdrop" id="inhouse-dash-searchBackdrop"></div>
                                    <div class="inhouse-search-results" id="inhouse-dash-searchResults"></div>
                                </div>
                                <div class="inhouse-selected-product" id="inhouse-dash-selectedProduct">
                                    <button type="button" id="inhouse-dash-clearProductBtn" style="position: absolute; top: 8px; right: 8px; background: rgba(255,255,255,0.9); border: 1px solid rgba(0,0,0,0.1); border-radius: 50%; width: 28px; height: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center;"></button>
                                    <img src="" alt="" class="inhouse-selected-product-image" id="inhouse-dash-selectedImage">
                                    <div>
                                        <h3 id="inhouse-dash-selectedName" style="font-size: 16px; font-weight: 600; color: #2d3748; margin-bottom: 4px;"></h3>
                                        <p id="inhouse-dash-selectedPrice" style="font-size: 15px; color: #1B4D3E; font-weight: 600;"></p>
                                    </div>
                                </div>
                            </div>

                            <div class="inhouse-form-group" id="inhouse-dash-colorOptions" style="display: none;">
                                <label>Select Color <span class="inhouse-required">*</span></label>
                                <div id="inhouse-dash-selectedColorDisplay" style="margin-bottom: 12px; padding: 10px; background: rgba(27, 77, 62, 0.05); border-radius: 8px; text-align: center; font-size: 14px; font-weight: 600; color: #2d3748; min-height: 40px; display: flex; align-items: center; justify-content: center;"></div>
                                <div class="inhouse-color-grid" id="inhouse-dash-colorGrid"></div>
                                <button type="button" id="inhouse-dash-addToCartBtn" class="inhouse-add-to-cart-btn" style="display: none; width: 100%; padding: 12px; margin-top: 12px; background: #1B4D3E; color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                    Add to Order
                                </button>
                            </div>

                            <!-- Order Cart -->
                            <div class="inhouse-form-group" id="inhouse-dash-orderCart" style="display: none;">
                                <label>Order Items <span class="inhouse-required">*</span> <span id="inhouse-dash-cartCount" style="font-size: 12px; font-weight: normal; color: #718096;">(0 items)</span></label>
                                <div id="inhouse-dash-cartItems" style="background: rgba(27, 77, 62, 0.03); border-radius: 12px; padding: 16px; margin-top: 8px; min-height: 60px; border: 1px solid rgba(27, 77, 62, 0.1);">
                                    <div style="text-align: center; color: #718096; padding: 20px;">No items added yet. Select a product and color, then click "Add to Order".</div>
                                </div>
                                <div id="inhouse-dash-cartTotal" style="margin-top: 12px; padding: 12px; background: rgba(27, 77, 62, 0.1); border-radius: 8px; text-align: right; font-size: 16px; font-weight: 700; color: #1B4D3E; display: none;">
                                    Total: KES <span id="inhouse-dash-totalAmount">0</span>
                                </div>
                            </div>

                            <div class="inhouse-form-group">
                                <label for="inhouse-dash-bodyMeasurements">Body Measurements <span class="inhouse-required">*</span></label>
                                <div class="inhouse-size-chart">
                                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px; text-align: center;">Size Chart</div>
                                    <table class="inhouse-size-chart-table">
                                        <thead>
                                            <tr>
                                                <th>A/M</th>
                                                <th>SIZE</th>
                                                <th>BUST</th>
                                                <th>WAIST</th>
                                                <th>HIPS</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>SS</td><td>6</td><td>32</td><td>25</td><td>36</td></tr>
                                            <tr><td>S</td><td>8</td><td>34</td><td>27</td><td>39</td></tr>
                                            <tr><td>SM</td><td>10</td><td>36</td><td>30</td><td>41</td></tr>
                                            <tr><td>M</td><td>12</td><td>38</td><td>32</td><td>43</td></tr>
                                            <tr><td>SL</td><td>14</td><td>40</td><td>34</td><td>45</td></tr>
                                            <tr><td>L</td><td>16</td><td>44</td><td>36</td><td>48</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <select id="inhouse-dash-bodyMeasurements" required>
                                    <option value="">Select your size</option>
                                    <option value="SS">SS 6, 32, 25, 36</option>
                                    <option value="S">S 8, 34, 27, 39</option>
                                    <option value="SM">SM 10, 36, 30, 41</option>
                                    <option value="M">M 12, 38, 32, 43</option>
                                    <option value="SL">SL 14, 40, 34, 45</option>
                                    <option value="L">L 16, 44, 36, 48</option>
                                    <option value="custom">Custom Size</option>
                                </select>
                                <div id="inhouse-dash-customSizeInput" style="display: none; margin-top: 12px;">
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                        <div>
                                            <label style="font-size: 12px; font-weight: 600; color: #4a5568; margin-bottom: 6px; display: block;">Height <span class="inhouse-required">*</span></label>
                                            <input type="text" id="inhouse-dash-customHeight" placeholder="e.g., 6'5" style="width: 100%; padding: 10px; border: 1.5px solid rgba(0,0,0,0.1); border-radius: 6px;" maxlength="4" inputmode="numeric">
                                        </div>
                                        <div>
                                            <label style="font-size: 12px; font-weight: 600; color: #4a5568; margin-bottom: 6px; display: block;">Bust (cm) <span class="inhouse-required">*</span></label>
                                            <input type="number" id="inhouse-dash-customBust" min="0" step="0.1" placeholder="e.g., 42" style="width: 100%; padding: 10px; border: 1.5px solid rgba(0,0,0,0.1); border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="font-size: 12px; font-weight: 600; color: #4a5568; margin-bottom: 6px; display: block;">High Waist (cm) <span class="inhouse-required">*</span></label>
                                            <input type="number" id="inhouse-dash-customWaist" min="0" step="0.1" placeholder="e.g., 34" style="width: 100%; padding: 10px; border: 1.5px solid rgba(0,0,0,0.1); border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="font-size: 12px; font-weight: 600; color: #4a5568; margin-bottom: 6px; display: block;">Hips (cm) <span class="inhouse-required">*</span></label>
                                            <input type="number" id="inhouse-dash-customHips" min="0" step="0.1" placeholder="e.g., 46" style="width: 100%; padding: 10px; border: 1.5px solid rgba(0,0,0,0.1); border-radius: 6px;">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="inhouse-form-group">
                                <label for="inhouse-dash-deliveryOption">Preferred Choice of Delivery <span class="inhouse-required">*</span></label>
                                <select id="inhouse-dash-deliveryOption" required>
                                    <option value="">Select delivery option</option>
                                    <option value="uber">Uber</option>
                                    <option value="pickup-mtaani">Pick Up Mtaani</option>
                                    <option value="courier">Courier</option>
                                    <option value="in-store-pickup">In Store Pick Up</option>
                                </select>
                                <div id="inhouse-dash-deliveryLocationInput" style="display: none; margin-top: 12px;">
                                    <div style="margin-bottom: 12px;">
                                        <label style="display: block; font-size: 14px; font-weight: 600; color: #2d3748; margin-bottom: 8px;">Search for Location in Kenya</label>
                                        <div style="position: relative;">
                                            <input type="text" id="inhouse-dash-locationSearch" placeholder="Type a place name (e.g., Nairobi, Mombasa, Westlands...)" 
                                                   style="width: 100%; padding: 12px 40px 12px 16px; border: 1.5px solid rgba(0, 0, 0, 0.08); background: rgba(255, 255, 255, 0.9); border-radius: 10px; font-size: 14px;">
                                            <button type="button" id="inhouse-dash-clearLocationSearch" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #718096; cursor: pointer; padding: 0; display: none; align-items: center; justify-content: center; font-size: 20px; line-height: 1; width: 24px; height: 24px; border-radius: 50%; transition: all 0.2s;" 
                                                    onmouseover="this.style.background='rgba(0,0,0,0.05)'; this.style.color='#2d3748';" 
                                                    onmouseout="this.style.background='transparent'; this.style.color='#718096';"
                                                    aria-label="Clear search">
                                                
                                            </button>
                                            <div id="inhouse-dash-locationSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1.5px solid rgba(0, 0, 0, 0.08); border-radius: 10px; margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);"></div>
                                        </div>
                                    </div>
                                    <!-- Manual entry option - moved above map -->
                                    <div style="margin-bottom: 12px; padding: 12px; background: rgba(255, 255, 255, 0.9); border-radius: 10px; border: 1px solid rgba(0, 0, 0, 0.08);">
                                        <button type="button" id="inhouse-dash-toggleManualEntry" style="width: 100%; padding: 10px; background: transparent; border: 1px dashed rgba(27, 77, 62, 0.3); border-radius: 8px; color: #1B4D3E; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                                             Can't find your location? Enter manually
                                        </button>
                                        <div id="inhouse-dash-manualEntryFields" style="display: none; margin-top: 12px;">
                                            <div style="margin-bottom: 10px;">
                                                <label style="display: block; font-size: 13px; font-weight: 600; color: #2d3748; margin-bottom: 6px;">Address/Description</label>
                                                <input type="text" id="inhouse-dash-manualAddress" placeholder="e.g., Averina Apartments, Block A, Room 5" style="width: 100%; padding: 10px 12px; border: 1.5px solid rgba(0, 0, 0, 0.08); background: rgba(255, 255, 255, 0.9); border-radius: 8px; font-size: 14px;">
                                            </div>
                                            <div style="display: flex; gap: 10px;">
                                                <button type="button" id="inhouse-dash-saveManualLocation" style="flex: 1; padding: 10px; background: #1B4D3E; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;">
                                                    Save Location
                                                </button>
                                                <button type="button" id="inhouse-dash-cancelManualEntry" style="flex: 1; padding: 10px; background: #c53030; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                                        onmouseover="this.style.background='#b91c1c';" 
                                                        onmouseout="this.style.background='#c53030';">
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="inhouse-dash-mapContainer" style="width: 100%; height: 300px; border-radius: 12px; border: 1.5px solid rgba(0, 0, 0, 0.08); margin-top: 12px; position: relative; overflow: hidden; background: #f0f0f0;">
                                        <div id="inhouse-dash-map" style="width: 100% !important; height: 100% !important; min-height: 300px;"></div>
                                        <div id="inhouse-dash-mapLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.95); padding: 12px 20px; border-radius: 8px; font-size: 14px; color: #2d3748; z-index: 1000; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                                            Loading map...
                                        </div>
                                    </div>
                                    <div id="inhouse-dash-selectedLocationInfo" style="margin-top: 12px; padding: 12px; background: rgba(27, 77, 62, 0.1); border-radius: 10px; border: 1px solid rgba(27, 77, 62, 0.2); display: none;">
                                        <div style="font-size: 13px; color: #2d3748; font-weight: 400; margin-bottom: 4px;">Selected Location:</div>
                                        <div id="inhouse-dash-selectedLocationText" style="font-size: 13px; color: #4a5568; font-weight: 400;"></div>
                                    </div>
                                    <!-- Hidden inputs to store location data -->
                                    <input type="hidden" id="inhouse-dash-deliveryLatitude">
                                    <input type="hidden" id="inhouse-dash-deliveryLongitude">
                                    <input type="hidden" id="inhouse-dash-deliveryDisplayName">
                                </div>
                                <div id="inhouse-dash-storeLocationMessage" style="display: none; margin-top: 12px; padding: 12px; background: rgba(27, 77, 62, 0.1); border-radius: 8px; color: #2d3748; font-size: 14px;">
                                    The store is opposite Jevanjee, Muindi Mbingu street, next to delight college.
                                </div>
                            </div>

                            <div class="inhouse-form-group">
                                <label for="inhouse-dash-mpesaCode">M-Pesa Code <span class="inhouse-required">*</span></label>
                                <input type="text" id="inhouse-dash-mpesaCode" required placeholder="Enter M-Pesa transaction code" maxlength="20">
                                <small style="display: block; margin-top: 4px; font-size: 12px; color: #718096;">Enter the M-Pesa transaction code received after payment</small>
                            </div>

                            <div class="inhouse-form-group">
                                <label for="inhouse-dash-comments">Additional Comments</label>
                                <textarea id="inhouse-dash-comments" rows="3" placeholder="Any special requests or preferences..."></textarea>
                            </div>

                            <button type="submit" class="inhouse-submit-btn">Submit Order</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div class="tab-content" id="deleted-orders">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 style="font-size: 24px; font-weight: 600; color: #41463F; margin-bottom: 4px;">Deleted Orders</h2>
                        <p style="font-size: 14px; color: rgba(65, 70, 63, 0.7); margin: 0;">View and restore deleted orders</p>
                    </div>
                </div>
                <div id="employee-deleted-orders-container" style="max-height: calc(100vh - 200px); overflow-y: auto; padding: 8px 0;">
                    <!-- Deleted orders will be rendered here -->
                </div>
            </div>

            <div class="tab-content" id="profile">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>My Profile</h2>
                    <button class="btn btn-accept" id="back-to-home-btn" style="display: flex; align-items: center; gap: 8px;">
                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Back to Home
                    </button>
                </div>
                
                <div class="chart-card">
                    <div class="chart-title">Personal Information</div>
                    <div class="profile-section">
                        <div class="profile-avatar">
                            <div class="avatar-circle" id="profile-avatar-initials">-</div>
                            <button class="btn btn-primary" style="margin-top: 16px;">Change Photo</button>
                        </div>
                        <div class="profile-details">
                            <div class="detail-row">
                                <div class="detail-label">Full Name:</div>
                                <div class="detail-value" id="profile-name">-</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Email:</div>
                                <div class="detail-value" id="profile-email">-</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Phone:</div>
                                <div class="detail-value" id="profile-phone">-</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Role:</div>
                                <div class="detail-value" id="profile-role">-</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Join Date:</div>
                                <div class="detail-value" id="profile-join-date">-</div>
                            </div>
                            <div class="detail-row">
                                <div class="detail-label">Status:</div>
                                <div class="detail-value" id="profile-status">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">Performance Statistics</div>
                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Orders Completed</div>
                            <div class="stat-value" id="profile-orders-completed">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Average Response Time</div>
                            <div class="stat-value" id="profile-avg-response">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">This Month</div>
                            <div class="stat-value" id="profile-this-month">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Status</div>
                            <div class="stat-value" id="profile-performance-status">-</div>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">Recent Achievements</div>
                    <div class="achievements-list" id="profile-achievements">
                        <div class="achievement-item" style="text-align: center; padding: 20px; color: rgba(65, 70, 63, 0.6);">
                            No achievements available
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard (initially hidden) -->
    <div id="admin-dashboard-page" class="hidden">
        <!-- Back button will be dynamically added -->
        
        <div class="min-h-screen">
            <!-- Mobile menu button -->
            <div class="lg:hidden fixed top-4 left-4 z-50">
                <button id="admin-mobile-menu-btn" class="btn btn-outline btn-icon glass-card-strong">
                    <svg id="admin-menu-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                    <svg id="admin-close-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Sidebar -->
            <aside id="admin-sidebar" class="transform transition-transform duration-200 ease-in-out lg:translate-x-0 -translate-x-full">
                <div class="flex flex-col h-full">
                    <div class="p-6 border-b" style="border-color: rgba(224, 216, 201, 0.2) !important;">
                        <h1 class="text-2xl font-bold text-white">Apparel Modest Admin</h1>
                        <p class="text-sm text-white/70" id="admin-name">Admin User</p>
                    </div>

                    <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                        <a href="#" class="nav-link active flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 bg-white/20 text-white backdrop-blur-sm" data-page="overview">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v2H8V5z"></path>
                            </svg>
                            Overview
                        </a>
                        <a href="#" class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 hover:bg-white/10 text-white/80 hover:text-white" data-page="revenue">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                            Revenue
                        </a>
                        <a href="#" class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 hover:bg-white/10 text-white/80 hover:text-white" data-page="staff">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                            </svg>
                            Staff
                        </a>
                        <a href="#" class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 hover:bg-white/10 text-white/80 hover:text-white" data-page="inventory">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            Kanban
                        </a>
                        <a href="#" class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 hover:bg-white/10 text-white/80 hover:text-white" data-page="analytics">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Analytics
                        </a>
                        <a href="#" class="nav-link flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 hover:bg-white/10 text-white/80 hover:text-white" data-page="trash">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Trash
                        </a>
                    </nav>

                    <div class="p-4 border-t space-y-2" style="border-color: rgba(224, 216, 201, 0.2) !important;">
                        <!-- Back to Employee View Button -->
                        <button id="back-to-employee-btn" class="btn btn-outline w-full flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Back to Employee View
                        </button>
                        <button id="admin-logout-btn" class="btn btn-outline w-full flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            Logout
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Mobile overlay -->
            <div id="admin-mobile-overlay" class="fixed inset-0 bg-background/80 backdrop-blur-sm hidden" style="z-index: 10002;"></div>

            <!-- Main content -->
            <main>
                <div class="p-6 lg:p-8">
                    <!-- Overview Dashboard Content -->
                    <div id="admin-overview-content" class="content-page">
                        <div class="space-y-6">
                            <div>
                                <h1 class="text-4xl font-bold text-white">Overview Dashboard</h1>
                                <p class="text-white/70">Welcome back! Here's your business summary.</p>
                            </div>

                            <!-- Key Metrics -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Total Orders</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                            </svg>
                                        </div>
                                        <div class="text-3xl font-bold text-white" id="total-orders">0</div>
                                        <p class="text-xs text-white/60">All time</p>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Total Revenue</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                        </div>
                                        <div class="text-3xl font-bold text-accent" id="total-revenue">KES 0</div>
                                        <p class="text-xs text-white/60">All time</p>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Most Ordered</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                            </svg>
                                        </div>
                                        <div class="text-2xl font-bold text-white" id="most-ordered">N/A</div>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Popular Color</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                            </svg>
                                        </div>
                                        <div class="text-2xl font-bold text-white" id="popular-color">N/A</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Charts -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <h3 class="mb-4" style="color: #41463F;">Monthly Orders</h3>
                                        <div id="monthly-orders-list" style="display: flex; flex-direction: column; gap: 8px; padding: 8px 0; width: 100%; min-height: 200px;">
                                            <!-- Monthly orders will be rendered here -->
                                        </div>
                                        <div id="yearly-total" style="text-align: center; margin-top: 16px; font-size: clamp(14px, 4vw, 16px); font-weight: 600; color: #41463F; word-wrap: break-word; overflow-wrap: break-word; padding: 0 8px;">
                                            Total Orders (All Time): <span id="yearly-total-value">0</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <h3 class="mb-4" style="color: #41463F;">Delivery Methods</h3>
                                        <div id="delivery-methods-list" style="display: flex; flex-direction: column; gap: 8px; padding: 8px 0; width: 100%; min-height: 200px;">
                                            <!-- Delivery methods will be rendered here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Info -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Preferred Delivery</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                            </svg>
                                        </div>
                                        <div class="text-2xl font-bold text-white capitalize" id="preferred-delivery">N/A</div>
                                        <p class="text-xs text-white/60" id="preferred-delivery-count">0 orders</p>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Avg. Processing Time</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <div class="text-2xl font-bold text-white" id="avg-processing-time">N/A</div>
                                        <p class="text-xs text-white/60">Per stage</p>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Orders Today</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                            </svg>
                                        </div>
                                        <div class="text-2xl font-bold text-accent" id="orders-today">0</div>
                                        <p class="text-xs text-white/60" id="orders-today-change">No change</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Page -->
                    <div id="admin-revenue-content" class="content-page hidden" style="background: #FAFAFA;">
                        <div class="space-y-6">
                            <div>
                                <h1 class="text-4xl font-bold" style="color: #41463F;">Revenue Dashboard</h1>
                                <p style="color: rgba(65, 70, 63, 0.7);">Financial insights and revenue analytics</p>
                            </div>

                            <!-- Revenue Metrics -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Total Revenue</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                            </svg>
                                        </div>
                                        <div class="text-3xl font-bold text-accent" id="revenue-total">KES 0</div>
                                        <p class="text-xs text-white/60">This month</p>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Average Order Value</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                            </svg>
                                        </div>
                                        <div class="text-3xl font-bold text-white" id="revenue-avg-order-value">KES 0</div>
                                        <p class="text-xs text-white/60">Per order</p>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Growth Rate</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                            </svg>
                                        </div>
                                        <div class="text-3xl font-bold text-accent" id="revenue-growth-rate">0%</div>
                                        <p class="text-xs text-white/60">vs last month</p>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Gross Income This Month</h3>
                                            <button id="add-cost-btn" style="display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: linear-gradient(135deg, #E0D8C9 0%, #D4C5B0 100%); color: #3C3F3E; border: none; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(224, 216, 201, 0.3);" title="Add Cost" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(224, 216, 201, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(224, 216, 201, 0.3)'">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                </svg>
                                                <span style="white-space: nowrap;">Add Cost</span>
                                            </button>
                                        </div>
                                        <div class="text-3xl font-bold text-white" id="revenue-gross-income">KES 0</div>
                                        <p class="text-xs text-white/60">Revenue - Costs</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Revenue Chart -->
                            <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                <div class="p-6">
                                    <h3 class="text-white mb-4">Monthly Revenue Trend</h3>
                                    <div class="chart-container" style="position: relative;">
                                        <div id="revenue-tooltip" style="position: absolute; display: none; background: rgba(65, 70, 63, 0.95); color: #FAFAFA; padding: 8px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; pointer-events: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); white-space: nowrap;"></div>
                                        <svg width="100%" height="100%" viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet" style="display: block; visibility: visible; opacity: 1; max-width: 100%; max-height: 300px; height: auto; min-height: 200px;">
                                            <defs>
                                                <pattern id="admin-revenue-grid" width="60" height="30" patternUnits="userSpaceOnUse">
                                                    <path d="M 60 0 L 0 0 0 30" fill="none" stroke="rgba(224,216,201,0.1)" stroke-width="1"/>
                                                </pattern>
                                                <linearGradient id="admin-lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                                    <stop offset="0%" style="stop-color:#41463F;stop-opacity:1" />
                                                    <stop offset="100%" style="stop-color:#353C35;stop-opacity:1" />
                                                </linearGradient>
                                            </defs>
                                            <rect width="100%" height="100%" fill="url(#admin-revenue-grid)"/>
                                            <g class="revenue-chart-line"></g>
                                            <g class="revenue-chart-labels" fill="#2D332D" font-size="12" font-weight="700"></g>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <!-- Costs Table -->
                            <div class="glass-card hover:bg-white/15 transition-all duration-300" style="background: rgba(224, 216, 201, 0.1); border: 1px solid rgba(224, 216, 201, 0.2);">
                                <div class="p-6">
                                    <div class="flex justify-between items-center mb-4" style="flex-direction: row;">
                                        <h3 style="color: #41463F; writing-mode: horizontal-tb; text-orientation: mixed; white-space: nowrap; display: inline-block;">Costs This Month</h3>
                                        <div class="flex gap-2 items-center">
                                            <input type="text" id="cost-search" placeholder="Search by name..." class="px-3 py-1.5 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:border-accent text-sm" style="min-width: 200px; background: rgba(65, 70, 63, 0.1); border: 1px solid rgba(65, 70, 63, 0.2); color: #41463F;">
                                            <input type="date" id="cost-date-filter" class="px-3 py-1.5 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-accent text-sm" style="background: rgba(65, 70, 63, 0.1); border: 1px solid rgba(65, 70, 63, 0.2); color: #41463F;">
                                            <input type="number" id="cost-amount-filter" placeholder="Amount" class="px-3 py-1.5 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:border-accent text-sm" style="min-width: 120px; background: rgba(65, 70, 63, 0.1); border: 1px solid rgba(65, 70, 63, 0.2); color: #41463F;">
                                            <select id="cost-sort" class="px-3 py-1.5 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-accent text-sm" style="background: rgba(65, 70, 63, 0.1); border: 1px solid rgba(65, 70, 63, 0.2); color: #41463F;">
                                                <option value="created_at-desc">Latest First</option>
                                                <option value="created_at-asc">Oldest First</option>
                                                <option value="amount-desc">Highest Amount</option>
                                                <option value="amount-asc">Lowest Amount</option>
                                                <option value="name-asc">Name A-Z</option>
                                                <option value="name-desc">Name Z-A</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="table-container" style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse; background: rgba(224, 216, 201, 0.1);">
                                            <thead>
                                                <tr style="background: rgba(224, 216, 201, 0.15);">
                                                    <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #41463F; text-transform: uppercase;">Name</th>
                                                    <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #41463F; text-transform: uppercase;">Date</th>
                                                    <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #41463F; text-transform: uppercase;">Amount</th>
                                                    <th style="padding: 12px; text-align: left; font-size: 12px; font-weight: 600; color: #41463F; text-transform: uppercase;">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="costs-table-body" style="background: rgba(255, 255, 255, 0.2);">
                                                <tr style="background: rgba(255, 255, 255, 0.2);">
                                                    <td colspan="4" style="padding: 20px; text-align: center; color: #000000;">Loading costs...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Staff Page -->
                    <div id="admin-staff-content" class="content-page hidden">
                        <div class="space-y-6">
                            <div class="flex justify-between items-center">
                            <div>
                                <h1 class="text-4xl font-bold" style="color: #41463F;">Staff Management</h1>
                                <p class="text-white/70">Manage team members and performance</p>
                                </div>
                                <button id="add-staff-btn" class="btn flex items-center gap-2" style="background: linear-gradient(135deg, #E0D8C9 0%, #D4C5B0 100%); color: #3C3F3E; border: none; font-weight: 600;">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Add Staff
                                </button>
                            </div>

                            <!-- Add Staff Form (initially hidden) -->
                            <div id="add-staff-form-container" class="glass-card hidden">
                                    <div class="p-6">
                                    <h2 class="text-2xl font-bold text-white mb-4">Add New Staff Member</h2>
                                    <form id="add-staff-form">
                                        <div class="space-y-4">
                                            <div>
                                                <label class="text-sm font-medium text-white/90 mb-2 block">Full Name *</label>
                                                <input type="text" id="staff-name" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:border-accent" placeholder="John Doe" required>
                                            </div>
                                            <div>
                                                <label class="text-sm font-medium text-white/90 mb-2 block">Email Address *</label>
                                                <input type="email" id="staff-email" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:border-accent" placeholder="john@example.com" required>
                                            </div>
                                            <div>
                                                <label class="text-sm font-medium text-white/90 mb-2 block">Role *</label>
                                                <select id="staff-role" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:border-accent" required>
                                                    <option value="">Select role</option>
                                                    <option value="sales">Sales</option>
                                                    <option value="production">Production</option>
                                                    <option value="logistics">Logistics</option>
                                                    <option value="instore">In-Store</option>
                                                    <option value="admin">Admin</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="text-sm font-medium text-white/90 mb-2 block">Phone Number (Optional)</label>
                                                <input type="tel" id="staff-phone" class="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/50 focus:outline-none focus:border-accent" placeholder="+254 700 000 000">
                                            </div>
                                            <div id="add-staff-message" class="hidden"></div>
                                            <div class="flex gap-3">
                                                <button type="submit" id="submit-staff-btn" class="btn flex-1" style="background: linear-gradient(135deg, #E0D8C9 0%, #D4C5B0 100%); color: #3C3F3E; border: none; font-weight: 600;">Add Staff Member</button>
                                                <button type="button" id="cancel-add-staff-btn" class="btn btn-outline flex-1">Cancel</button>
                                        </div>
                                            </div>
                                    </form>
                                    </div>
                                </div>

                            <!-- Staff List -->
                                            <div>
                                <h2 class="text-2xl font-bold text-white mb-4">All Staff Members</h2>
                                <div id="admin-staff-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <!-- Staff cards will be loaded here dynamically -->
                                    <div class="glass-card p-6 text-center text-white/60">
                                        <p>Loading staff members...</p>
                                            </div>
                                        </div>
                                            </div>
                        </div>
                    </div>

                    <!-- Kanban Page -->
                    <div id="admin-inventory-content" class="content-page hidden">
                        <div class="space-y-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-4xl font-bold" style="color: #41463F;">Kanban Board</h1>
                                    <p class="text-white/70">Write anything you want to remember or deal with - tasks, notes, reminders, ideas</p>
                                </div>
                            </div>

                            <!-- Kanban Board -->
                            <div class="kanban-container">
                                <!-- To Do Column -->
                                <div class="kanban-column" data-status="todo">
                                    <div class="glass-card" style="height: 100%;">
                                        <div class="p-4" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div class="flex items-center justify-between">
                                                <h3 class="text-white font-semibold text-lg">To Do</h3>
                                                <span class="kanban-count" style="background: rgba(245, 158, 11, 0.2); color: #F59E0B; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="kanban-count-todo">0</span>
                                            </div>
                                        </div>
                                        <div class="p-4 kanban-cards" data-status="todo" style="min-height: 400px; max-height: calc(100vh - 250px); overflow-y: auto; width: 100%; box-sizing: border-box;">
                                            <button class="add-kanban-card-btn" onclick="openAddKanbanCardModal('todo')" style="width: 100%; padding: 12px; background: rgba(60, 63, 62, 0.8); border: 2px solid rgba(60, 63, 62, 0.9); border-radius: 8px; color: #FAFAFA; cursor: pointer; transition: all 0.2s; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600;">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                </svg>
                                                <span>Add Card</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- In Progress Column -->
                                <div class="kanban-column" data-status="in_progress">
                                    <div class="glass-card" style="height: 100%;">
                                        <div class="p-4" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div class="flex items-center justify-between">
                                                <h3 class="text-white font-semibold text-lg">In Progress</h3>
                                                <span class="kanban-count" style="background: rgba(59, 130, 246, 0.2); color: #3B82F6; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="kanban-count-in_progress">0</span>
                                            </div>
                                        </div>
                                        <div class="p-4 kanban-cards" data-status="in_progress" style="min-height: 400px; max-height: calc(100vh - 250px); overflow-y: auto; width: 100%; box-sizing: border-box;">
                                            <button class="add-kanban-card-btn" onclick="openAddKanbanCardModal('in_progress')" style="width: 100%; padding: 12px; background: rgba(60, 63, 62, 0.8); border: 2px solid rgba(60, 63, 62, 0.9); border-radius: 8px; color: #FAFAFA; cursor: pointer; transition: all 0.2s; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600;">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                </svg>
                                                <span>Add Card</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Review Column -->
                                <div class="kanban-column" data-status="review">
                                    <div class="glass-card" style="height: 100%;">
                                        <div class="p-4" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div class="flex items-center justify-between">
                                                <h3 class="text-white font-semibold text-lg">Review</h3>
                                                <span class="kanban-count" style="background: rgba(139, 92, 246, 0.2); color: #8B5CF6; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="kanban-count-review">0</span>
                                            </div>
                                        </div>
                                        <div class="p-4 kanban-cards" data-status="review" style="min-height: 400px; max-height: calc(100vh - 250px); overflow-y: auto; width: 100%; box-sizing: border-box;">
                                            <button class="add-kanban-card-btn" onclick="openAddKanbanCardModal('review')" style="width: 100%; padding: 12px; background: rgba(60, 63, 62, 0.8); border: 2px solid rgba(60, 63, 62, 0.9); border-radius: 8px; color: #FAFAFA; cursor: pointer; transition: all 0.2s; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600;">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                </svg>
                                                <span>Add Card</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Completed Column -->
                                <div class="kanban-column" data-status="completed">
                                    <div class="glass-card" style="height: 100%;">
                                        <div class="p-4" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                            <div class="flex items-center justify-between">
                                                <h3 class="text-white font-semibold text-lg">Completed</h3>
                                                <span class="kanban-count" style="background: rgba(16, 185, 129, 0.2); color: #10B981; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="kanban-count-completed">0</span>
                                            </div>
                                        </div>
                                        <div class="p-4 kanban-cards" data-status="completed" style="min-height: 400px; max-height: calc(100vh - 250px); overflow-y: auto; width: 100%; box-sizing: border-box;">
                                            <button class="add-kanban-card-btn" onclick="openAddKanbanCardModal('completed')" style="width: 100%; padding: 12px; background: rgba(60, 63, 62, 0.8); border: 2px solid rgba(60, 63, 62, 0.9); border-radius: 8px; color: #FAFAFA; cursor: pointer; transition: all 0.2s; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600;">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                                </svg>
                                                <span>Add Card</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Page -->
                    <div id="admin-analytics-content" class="content-page hidden">
                        <div class="space-y-6">
                            <div>
                                <h1 class="text-4xl font-bold" style="color: #41463F;">Analytics Dashboard</h1>
                                <p style="color: rgba(65, 70, 63, 0.7);">Deep insights into order performance, customer behavior, and operational efficiency</p>
                            </div>

                            <!-- Customer Metrics -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Total Customers</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                            </svg>
                                        </div>
                                        <div class="text-3xl font-bold text-white" id="analytics-total-customers">0</div>
                                        <p class="text-xs text-white/60">All time</p>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Active Customers</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <div class="text-3xl font-bold text-accent" id="analytics-active-customers">0</div>
                                        <p class="text-xs text-white/60">Last 30 days</p>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Repeat Customer Rate</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                            </svg>
                                        </div>
                                        <div class="text-3xl font-bold text-white" id="analytics-repeat-rate">0%</div>
                                        <p class="text-xs text-white/60">Customers with 2+ orders</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Order Performance Metrics -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Completion Rate</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <div class="text-3xl font-bold text-accent" id="analytics-completion-rate">0%</div>
                                        <p class="text-xs text-white/60">Orders completed</p>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Cancellation Rate</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </div>
                                        <div class="text-3xl font-bold text-white" id="analytics-cancellation-rate">0%</div>
                                        <p class="text-xs text-white/60">Orders cancelled</p>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">Pending Orders</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                            </svg>
                                        </div>
                                        <div class="text-3xl font-bold text-white" id="analytics-pending-count">0</div>
                                        <p class="text-xs text-white/60">Awaiting processing</p>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <div class="flex flex-row items-center justify-between pb-2">
                                            <h3 class="text-sm font-medium text-white">In Progress</h3>
                                            <svg class="h-4 w-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                            </svg>
                                        </div>
                                        <div class="text-3xl font-bold text-accent" id="analytics-in-progress-count">0</div>
                                        <p class="text-xs text-white/60">Currently processing</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Analytics Charts -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <h3 class="mb-4" style="color: #41463F;">Order Status Breakdown</h3>
                                        <div id="analytics-status-chart" class="chart-container flex items-center justify-center" style="min-height: 240px; display: block !important; visibility: visible !important;">
                                            <div class="text-center py-8" style="color: rgba(65, 70, 63, 0.6);">Loading chart...</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                    <div class="p-6">
                                        <h3 class="mb-4" style="color: #41463F;">Stage Performance</h3>
                                        <div class="space-y-4">
                                            <div class="flex justify-between items-center">
                                                <span style="color: rgba(65, 70, 63, 0.7);">Sales Stage</span>
                                                <span class="font-semibold" style="color: #41463F;" id="analytics-sales-time">N/A</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span style="color: rgba(65, 70, 63, 0.7);">Production Stage</span>
                                                <span class="font-semibold" style="color: #41463F;" id="analytics-production-time">N/A</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span style="color: rgba(65, 70, 63, 0.7);">In-Store Stage</span>
                                                <span class="font-semibold" style="color: #41463F;" id="analytics-instore-time">N/A</span>
                                            </div>
                                            <div class="flex justify-between items-center">
                                                <span style="color: rgba(65, 70, 63, 0.7);">Logistics Stage</span>
                                                <span class="font-semibold" style="color: #41463F;" id="analytics-logistics-time">N/A</span>
                                            </div>
                                            <div class="pt-2" style="border-top: 1px solid rgba(224, 216, 201, 0.2);">
                                                <div class="flex justify-between items-center">
                                                    <span class="font-semibold" style="color: #41463F;">Total Average</span>
                                                    <span class="font-bold" style="color: #41463F;" id="analytics-total-time">N/A</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Admin Trash Content -->
                    <div id="admin-trash-content" class="content-page hidden">
                        <div class="space-y-6">
                            <div>
                                <h1 class="text-4xl font-bold" style="color: #41463F;">Deleted Orders</h1>
                                <p style="color: rgba(65, 70, 63, 0.7);">View and restore deleted orders</p>
                            </div>

                            <div class="glass-card hover:bg-white/15 transition-all duration-300">
                                <div class="p-6">
                                    <div id="admin-deleted-orders-container" style="max-height: calc(100vh - 250px); overflow-y: auto; padding: 8px 0;">
                                        <!-- Deleted orders will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Kanban Card Modal -->
    <div id="kanban-card-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px;">
        <div class="login-card" style="max-width: 500px; width: 100%; margin: 0; max-height: 90vh; overflow-y: auto;">
            <div class="login-header">
                <h1 style="font-size: 24px;" id="kanban-modal-title">Add New Card</h1>
                <p style="font-size: 14px;">Write anything you want to remember or deal with</p>
            </div>
            <form id="kanban-card-form">
                <div class="form-group">
                    <label class="form-label" for="kanban-card-title">Title <span class="required">*</span></label>
                    <input type="text" id="kanban-card-title" class="form-input" placeholder="e.g., Review Q4 reports, Call supplier, etc." required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="kanban-card-description">Description</label>
                    <textarea id="kanban-card-description" class="form-input" rows="3" placeholder="Add any additional details or notes..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="kanban-card-priority">Priority</label>
                    <select id="kanban-card-priority" class="form-input">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="kanban-card-status">Status</label>
                    <select id="kanban-card-status" class="form-input">
                        <option value="todo">To Do</option>
                        <option value="in_progress">In Progress</option>
                        <option value="review">Review</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <input type="hidden" id="kanban-card-id">
                <div id="kanban-card-message" class="hidden"></div>
                <div style="display: flex; gap: 12px;">
                    <button type="submit" class="btn-login" style="flex: 1; margin-bottom: 0;">Save Card</button>
                    <button type="button" class="btn-otp" id="cancel-kanban-card-btn" style="flex: 1; margin-bottom: 0;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Cost Modal -->
    <div id="add-cost-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px;">
        <div class="login-card" style="max-width: 450px; width: 100%; margin: 0; max-height: 90vh; overflow-y: auto;">
            <div class="login-header">
                <h1 style="font-size: 24px;">Add New Cost</h1>
                <p style="font-size: 14px;">Fill in the cost details below</p>
            </div>
            <form id="add-cost-form">
                <div class="form-group">
                    <label class="form-label" for="cost-name">Cost Name <span class="required">*</span></label>
                    <input type="text" id="cost-name" class="form-input" placeholder="e.g., Rent, Utilities, Supplies..." required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="cost-date">Date of Cost <span class="required">*</span></label>
                    <input type="date" id="cost-date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="cost-amount">Amount (KES) <span class="required">*</span></label>
                    <input type="number" id="cost-amount" class="form-input" placeholder="0.00" min="0" step="0.01" required>
                </div>
                <div id="add-cost-message" class="hidden"></div>
                <div style="display: flex; gap: 12px;">
                    <button type="submit" class="btn-login" style="flex: 1; margin-bottom: 0;">Add Cost</button>
                    <button type="button" class="btn-otp" id="cancel-cost-btn" style="flex: 1; margin-bottom: 0;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Required Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Environment Configuration Loader -->
    <script src="config/env-loader.js"></script>
    <script>
        // Load environment variables from Netlify function
        // This must complete before other scripts initialize
        (async function() {
            try {
                await loadEnvConfig();
                
                // Load all dependent scripts after config is ready
                const scripts = [
                    'config/supabase.js',
                    'config/cloudinary.js',
                    'services/cloudinaryService.js',
                    'auth services/otpService.js',
                    'auth services/authService.js',
                    'auth services/welcomeEmailService.js'
                ];
                
                // Load scripts sequentially
                for (const src of scripts) {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = src;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }
                
                // Continue with rest of initialization
                initializeApp();
            } catch (error) {
                console.error(' Failed to load environment variables:', error);
                alert(' Configuration error. Please check your Netlify environment variables.');
            }
        })();
        
        // Function to initialize app after scripts load
        function initializeApp() {
            // This will be called after all scripts are loaded
            if (window.dispatchEvent) {
                window.dispatchEvent(new CustomEvent('appScriptsLoaded'));
            }
        }
    </script>
    
    <!-- Admin Services -->
    <script src="admin services/overviewService.js"></script>
    <script src="admin services/costsService.js"></script>
    <script src="admin services/revenueService.js"></script>
    <script src="admin services/analyticsService.js"></script>
    <script src="admin services/kanbanService.js"></script>
    <script src="admin services/staffManagementService.js"></script>
    
    <!-- Employee Services -->
    <script src="employee services/homeService.js"></script>
    <script src="employee services/catalogueService.js"></script>
    <script src="employee services/salesService.js"></script>
    <script src="employee services/productionService.js"></script>
    <script src="employee services/deletedOrdersService.js"></script>
    <script src="employee services/logisticsService.js"></script>
    <script src="employee services/afterSalesService.js"></script>
    <script src="employee services/returnsService.js"></script>

    <script>
        let currentUser = null;
        let isAdminView = false;
        let otpSent = false; // Track if OTP has been sent

        // Initialize auth services when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for environment config to be loaded
            try {
                // Use window.waitForEnvConfig to ensure it's available
                if (typeof window.waitForEnvConfig === 'function') {
                    await window.waitForEnvConfig();
                } else {
                    // Fallback: wait for env-loader to be available
                    let attempts = 0;
                    while (typeof window.waitForEnvConfig !== 'function' && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    if (typeof window.waitForEnvConfig === 'function') {
                        await window.waitForEnvConfig();
                    } else {
                        console.warn(' waitForEnvConfig not available, trying loadEnvConfig');
                        if (typeof window.loadEnvConfig === 'function') {
                            await window.loadEnvConfig();
                        }
                    }
                }
            } catch (error) {
                console.error(' Config not loaded, services may fail:', error);
            }
            
            // Wait for all scripts to be loaded before initializing services
            const initializeServices = () => {
                // Initialize OTP service first (needed by authService)
                if (typeof otpService !== 'undefined') {
                    otpService.init();
                }
                
                // Now initialize services
                if (typeof authService !== 'undefined') {
                    authService.init();
                }
                if (typeof staffManagementService !== 'undefined') {
                    staffManagementService.init();
                }
                if (typeof cloudinaryService !== 'undefined') {
                    cloudinaryService.init();
                }
                
                // Check if user is already logged in
                if (typeof checkExistingSession === 'function') {
                    checkExistingSession();
                }
            };
            
            // Check if scripts are already loaded
            if (typeof authService !== 'undefined' && typeof checkExistingSession === 'function') {
                // Scripts are already loaded, initialize immediately
                initializeServices();
            } else {
                // Wait for appScriptsLoaded event
                window.addEventListener('appScriptsLoaded', () => {
                    initializeServices();
                }, { once: true });
                
                // Fallback: check periodically if scripts are loaded
                let checkAttempts = 0;
                const checkInterval = setInterval(() => {
                    checkAttempts++;
                    if (typeof authService !== 'undefined' && typeof checkExistingSession === 'function') {
                        clearInterval(checkInterval);
                        initializeServices();
                    } else if (checkAttempts > 100) {
                        clearInterval(checkInterval);
                        console.warn(' Some services may not be available');
                        initializeServices(); // Try anyway
                    }
                }, 100);
            }
        });

        // Login functionality
        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            const messageClass = type === 'success' ? 'otp-message' : 'error-message';
            messagesDiv.innerHTML = `<div class="${messageClass}" style="padding: 12px; margin-top: 10px; border-radius: 8px; ${type === 'success' ? 'background: rgba(16, 185, 129, 0.2); color: #10b981;' : 'background: rgba(239, 68, 68, 0.2); color: #ef4444;'}">${message}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Check for existing valid OTP when email is entered
        let emailCheckTimeout;
        async function checkOTPStatus(email) {
                    if (!email) {
                        document.getElementById('otp-remaining-time').textContent = '';
                        document.getElementById('otp-expired-warning').style.display = 'none';
                // Reset login button
                const loginBtn = document.getElementById('login-btn');
                loginBtn.textContent = 'Login';
                loginBtn.style.background = '';
                loginBtn.style.borderColor = '';
                        return;
                    }

                    // Validate email format
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        return;
                    }

                    try {
                // Check for existing valid OTP that has been verified before (can auto-login)
                const verifiedOTP = await otpService.getValidOTP(email, 'login', true);
                        const remainingTimeDiv = document.getElementById('otp-remaining-time');
                        const warningDiv = document.getElementById('otp-expired-warning');
                        
                if (verifiedOTP) {
                    // Valid OTP exists and has been verified before - user can login directly
                    const remainingTime = otpService.formatRemainingTime(verifiedOTP);
                    remainingTimeDiv.textContent = ` Valid OTP found! Time remaining: ${remainingTime}. Click "Login" to continue.`;
                            remainingTimeDiv.style.display = 'block';
                            remainingTimeDiv.style.color = 'rgba(16, 185, 129, 0.9)';
                            warningDiv.style.display = 'none';
                            
                    // Update login button to show OTP is ready
                    const loginBtn = document.getElementById('login-btn');
                    loginBtn.textContent = 'Login (OTP Ready)';
                    loginBtn.style.background = 'rgba(16, 185, 129, 0.2)';
                    loginBtn.style.borderColor = 'rgba(16, 185, 129, 0.5)';
                    
                    // OTP field is optional - user can login without it if valid OTP exists
                    // Keep it hidden to make it clear they don't need it
                    const otpGroupEl = document.getElementById('otp-group');
                    otpGroupEl.classList.add('hidden');
                    // Remove required attribute when hidden
                    document.getElementById('otp').removeAttribute('required');
                        } else {
                            remainingTimeDiv.textContent = '';
                            warningDiv.textContent = ' No valid OTP found. Please click "Send OTP Code" to get a new one.';
                            warningDiv.style.display = 'block';
                    
                    // Reset login button to default
                    const loginBtn = document.getElementById('login-btn');
                    loginBtn.textContent = 'Login';
                    loginBtn.style.background = '';
                    loginBtn.style.borderColor = '';
                        }
                    } catch (error) {
                        console.error('Error checking for valid OTP:', error);
                    }
        }

        function setupEmailCheck() {
            const emailInput = document.getElementById('email');
            if (!emailInput) return;
            
            // Check on input (with debounce)
            emailInput.addEventListener('input', async (e) => {
                const email = e.target.value.trim();
                
                // Clear previous timeout
                clearTimeout(emailCheckTimeout);
                
                // Wait for user to stop typing (500ms delay)
                emailCheckTimeout = setTimeout(() => {
                    checkOTPStatus(email);
                }, 500);
            });
            
            // Also check when user leaves the email field (on blur)
            emailInput.addEventListener('blur', async (e) => {
                const email = e.target.value.trim();
                // Clear any pending timeout and check immediately
                clearTimeout(emailCheckTimeout);
                checkOTPStatus(email);
            });
        }

        // Send OTP code
        async function sendOTP() {
            const email = document.getElementById('email').value.trim();
            
            if (!email) {
                showMessage('Please enter your email address', 'error');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('Please enter a valid email address', 'error');
                return;
            }

            // Disable button and show loading
            const btn = document.getElementById('send-otp-btn');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                // Request OTP via auth service
                const result = await authService.requestOTP(email);

                if (result.success) {
                    otpSent = true;
                    
                    // Show visual indicator
                    const indicator = document.getElementById('otp-sent-indicator');
                    const emailText = document.getElementById('sent-email-text');
                    emailText.textContent = email;
                    indicator.classList.remove('hidden');
                    
                    // Show remaining time if OTP already exists
                    const remainingTimeDiv = document.getElementById('otp-remaining-time');
                    const warningDiv = document.getElementById('otp-expired-warning');
                    warningDiv.style.display = 'none';
                    
                    // Check if OTP has been verified before (can auto-login)
                    const verifiedOTP = await otpService.getValidOTP(email, 'login', true);
                    
                    if (result.hasValidOTP && result.remainingTime && verifiedOTP) {
                        // Valid OTP exists and has been verified before - user can login directly
                        remainingTimeDiv.textContent = ` Valid OTP found! Time remaining: ${result.remainingTime}. Click "Login" to continue.`;
                        remainingTimeDiv.style.display = 'block';
                        remainingTimeDiv.style.color = 'rgba(16, 185, 129, 0.9)';
                        // Keep OTP field hidden since they don't need it
                        const otpGroup = document.getElementById('otp-group');
                        otpGroup.classList.add('hidden');
                        // Remove required attribute when hidden
                        document.getElementById('otp').removeAttribute('required');
                        
                        // Update login button to show OTP is ready
                        const loginBtn = document.getElementById('login-btn');
                        loginBtn.textContent = 'Login (OTP Ready)';
                        loginBtn.style.background = 'rgba(16, 185, 129, 0.2)';
                        loginBtn.style.borderColor = 'rgba(16, 185, 129, 0.5)';
                    } else {
                        // New OTP was sent - show OTP input field and require entry
                        const otpGroup = document.getElementById('otp-group');
                        otpGroup.classList.remove('hidden');
                        // Add required attribute when visible
                        document.getElementById('otp').setAttribute('required', 'required');
                        remainingTimeDiv.textContent = ' OTP sent! Please check your email and enter the 6-digit code below.';
                        remainingTimeDiv.style.display = 'block';
                        remainingTimeDiv.style.color = 'rgba(16, 185, 129, 0.9)';
                        
                        // Reset login button - user must enter OTP first
                        const loginBtn = document.getElementById('login-btn');
                        loginBtn.textContent = 'Login';
                        loginBtn.style.background = '';
                        loginBtn.style.borderColor = '';
                        
                        // Focus on OTP input field
                        document.getElementById('otp').focus();
                    }
                    
                    // Show success message
                    showMessage(result.message, 'success');
                } else {
                    // Hide indicator on error
                    document.getElementById('otp-sent-indicator').classList.add('hidden');
                    document.getElementById('otp-remaining-time').textContent = '';
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error sending OTP:', error);
                // Hide indicator on error
                document.getElementById('otp-sent-indicator').classList.add('hidden');
                document.getElementById('otp-remaining-time').textContent = '';
                showMessage('An error occurred. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send OTP Code';
            }
        }

        // Handle login form submission
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const otp = document.getElementById('otp').value.trim();
            const otpGroup = document.getElementById('otp-group');
            const otpInput = document.getElementById('otp');

            if (!email) {
                showMessage('Please enter your email address', 'error');
                return;
            }

            // Ensure OTP field is not required if it's hidden
            if (otpGroup.classList.contains('hidden')) {
                otpInput.removeAttribute('required');
            }

            // Disable button and show loading
            const btn = document.getElementById('login-btn');
            btn.disabled = true;
            btn.textContent = 'Logging in...';

            try {
                // Verify authService is available and has the method
                if (!authService) {
                    showMessage('Authentication service not loaded. Please refresh the page.', 'error');
                return;
            }

                if (typeof authService.loginWithValidOTP !== 'function') {
                    console.error(' loginWithValidOTP method not found!');
                    console.error('Available methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(authService)));
                    console.error('authService object:', authService);
                    showMessage('Please do a hard refresh (Ctrl+Shift+R or Cmd+Shift+R) to load the latest version.', 'error');
                return;
            }

                // First, check if there's a valid OTP in the database
                const validOTPCheck = await otpService.getValidOTP(email, 'login');
                
                // If OTP field is hidden or OTP is empty, try to login with existing verified OTP
                if (otpGroup.classList.contains('hidden') || !otp) {
                    // Check for verified OTP (has been used at least once)
                    const verifiedOTPCheck = await otpService.getValidOTP(email, 'login', true);
                    
                    if (verifiedOTPCheck) {
                        // Verified OTP exists, login immediately
                        const result = await authService.loginWithValidOTP(email);
                        
                        if (result.success) {
                            // Login successful with existing verified OTP
                            currentUser = result.user;
                            loginUser(result.user);
                            showMessage(result.message, 'success');
                            return;
                        } else {
                            if (result.needsOTPEntry) {
                                // New OTP was sent, must enter it first time
                                showMessage('Please enter the OTP code sent to your email.', 'error');
                                document.getElementById('otp-group').classList.remove('hidden');
                                document.getElementById('otp').setAttribute('required', 'required');
                                document.getElementById('otp').focus();
                            } else {
                                showMessage(result.message, 'error');
                            }
                            return;
                        }
                    } else {
                        // No valid OTP found, user needs to request one
                        showMessage('No valid OTP found. Please click "Send OTP Code" to get a new one.', 'error');
                        const warningDiv = document.getElementById('otp-expired-warning');
                        warningDiv.textContent = ' No valid OTP found. Please click "Send OTP Code" to get a new one.';
                        warningDiv.style.display = 'block';
                        // Show OTP field so they can request OTP (but don't require it yet)
                        const otpGroup = document.getElementById('otp-group');
                        otpGroup.classList.remove('hidden');
                        // Don't add required yet - wait until OTP is sent
                        document.getElementById('otp').removeAttribute('required');
                        return;
                    }
                }

                // OTP was provided, validate format
            if (!/^\d{6}$/.test(otp)) {
                showMessage('OTP must be 6 digits', 'error');
                return;
            }

                // Verify OTP and login
                btn.textContent = 'Verifying...';
                const result = await authService.verifyOTPAndLogin(email, otp);

                if (result.success) {
                    // Login successful
                    currentUser = result.user;
                    loginUser(result.user);
                    
                    // Show remaining time
                    if (result.remainingTime) {
                        showMessage(result.message, 'success');
                    } else {
                        showMessage(result.message, 'success');
                    }
                } else {
                    showMessage(result.message, 'error');
                    
                    // If OTP needs renewal, show warning
                    if (result.needsRenewal) {
                        const warningDiv = document.getElementById('otp-expired-warning');
                        warningDiv.textContent = ' Your OTP has expired. Please click "Send OTP Code" to renew it.';
                        warningDiv.style.display = 'block';
                        document.getElementById('otp-remaining-time').textContent = '';
                    } else {
                        // Update remaining time display
                        const remainingTimeDiv = document.getElementById('otp-remaining-time');
                        if (result.remainingTime) {
                            remainingTimeDiv.textContent = ` OTP remaining: ${result.remainingTime}`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error during login:', error);
                showMessage('An error occurred during login. Please try again.', 'error');
            } finally {
                btn.disabled = false;
                // Check if we should show "OTP Ready" status
                const email = document.getElementById('email').value.trim();
                if (email) {
                    try {
                        const validOTP = await otpService.getValidOTP(email, 'login');
                        if (validOTP) {
                            btn.textContent = 'Login (OTP Ready)';
                            btn.style.background = 'rgba(16, 185, 129, 0.2)';
                            btn.style.borderColor = 'rgba(16, 185, 129, 0.5)';
                        } else {
                btn.textContent = 'Login';
                            btn.style.background = '';
                            btn.style.borderColor = '';
                        }
                    } catch (error) {
                        btn.textContent = 'Login';
                        btn.style.background = '';
                        btn.style.borderColor = '';
                    }
                } else {
                    btn.textContent = 'Login';
                    btn.style.background = '';
                    btn.style.borderColor = '';
                }
            }
        }

        // Login user and show dashboard
        function loginUser(user) {
            // Start periodic OTP validation check
            startOTPValidationCheck();
            currentUser = user;
            
            // Hide login page, show employee dashboard
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('dashboard-page').classList.remove('hidden');

            // Show admin button if user is admin (for accessing admin dashboard)
            if (user.role === 'admin') {
                const adminSection = document.getElementById('admin-view-section');
                if (adminSection) {
                    adminSection.classList.remove('hidden');
                }
            }

            // Initialize home service and load dashboard data
            if (homeService) {
                homeService.init();
            }

            // Initialize customer form link copy functionality
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const customerFormLink = document.getElementById('customer-form-link');
            const copyLinkText = document.getElementById('copy-link-text');
            
            // Set customer form URL
            if (customerFormLink) {
                customerFormLink.value = 'https://apparelmodest.com/customerform';
            }
            
            if (copyLinkBtn && customerFormLink) {
                // Make input field selectable on click
                customerFormLink.addEventListener('click', function() {
                    this.select();
                    this.setSelectionRange(0, 99999);
                });
                
                // Copy button functionality
                copyLinkBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(customerFormLink.value);
                        const originalText = copyLinkText.textContent;
                        copyLinkText.textContent = 'Copied!';
                        copyLinkBtn.style.background = '#10B981';
                        
                        setTimeout(() => {
                            copyLinkText.textContent = originalText;
                            copyLinkBtn.style.background = '';
                        }, 2000);
                    } catch (err) {
                        // Fallback for older browsers
                        customerFormLink.select();
                        customerFormLink.setSelectionRange(0, 99999);
                        document.execCommand('copy');
                        const originalText = copyLinkText.textContent;
                        copyLinkText.textContent = 'Copied!';
                        copyLinkBtn.style.background = '#10B981';
                        
                        setTimeout(() => {
                            copyLinkText.textContent = originalText;
                            copyLinkBtn.style.background = '';
                        }, 2000);
                    }
                });
            }

            // Update date in welcome section
            updateWelcomeDate();

            showMessage(`Welcome ${user.name}!`, 'success');
        }

        // Update welcome section date (now handled by homeService)
        function updateWelcomeDate() {
            // Date is now updated by homeService.updateWelcomeSection()
            if (homeService) {
                homeService.updateWelcomeSection();
            }
        }

        // Check if user is already logged in
        async function checkExistingSession() {
            const loggedIn = await authService.isLoggedIn();
            if (loggedIn) {
                const user = authService.getCurrentUser();
                if (user) {
                    currentUser = user;
                    document.getElementById('login-page').classList.add('hidden');
                    document.getElementById('dashboard-page').classList.remove('hidden');
                    
                    // Show admin button if admin
                    if (user.role === 'admin') {
                        const adminSection = document.getElementById('admin-view-section');
                        if (adminSection) {
                            adminSection.classList.remove('hidden');
                        }
                    }

                    // Initialize home service and load dashboard data
                    if (homeService) {
                        homeService.init();
                    }

                    // Update date in welcome section
                    updateWelcomeDate();

                    // Start periodic OTP validation check (check every 5 minutes)
                    startOTPValidationCheck();
                }
            }
        }

        // Periodic OTP validation check
        let otpCheckInterval = null;
        async function startOTPValidationCheck() {
            // Clear any existing interval
            if (otpCheckInterval) {
                clearInterval(otpCheckInterval);
            }

            // Check immediately
            await checkOTPAndLogoutIfExpired();

            // Then check every 5 minutes
            otpCheckInterval = setInterval(async () => {
                await checkOTPAndLogoutIfExpired();
            }, 5 * 60 * 1000); // 5 minutes
        }

        async function checkOTPAndLogoutIfExpired() {
            try {
                const otpCheck = await authService.checkOTPValidity();
                if (!otpCheck.valid && otpCheck.needsRenewal) {
                    // OTP expired, log out user
                    authService.logout();
                    currentUser = null;
                    document.getElementById('login-page').classList.remove('hidden');
                    document.getElementById('dashboard-page').classList.add('hidden');
                    document.getElementById('admin-dashboard-page').classList.add('hidden');
                    
                    // Clear form
                    document.getElementById('email').value = '';
                    document.getElementById('otp').value = '';
                    const otpGroupEl2 = document.getElementById('otp-group');
                    otpGroupEl2.classList.add('hidden');
                    // Remove required attribute when hidden
                    document.getElementById('otp').removeAttribute('required');
                    document.getElementById('otp-sent-indicator').classList.add('hidden');
                    
                    showMessage('Your OTP has expired. Please click "Send OTP Code" to renew it and login again.', 'error');
                }
            } catch (error) {
                console.error('Error checking OTP validity:', error);
            }
        }

        // Logout function
        function logout() {
            // Clear OTP check interval
            if (otpCheckInterval) {
                clearInterval(otpCheckInterval);
                otpCheckInterval = null;
            }
            authService.logout();
            currentUser = null;
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('dashboard-page').classList.add('hidden');
            const otpGroupEl3 = document.getElementById('otp-group');
            otpGroupEl3.classList.add('hidden');
            // Remove required attribute when hidden
            document.getElementById('otp').removeAttribute('required');
            document.getElementById('otp-sent-indicator').classList.add('hidden');
            document.getElementById('email').value = '';
            document.getElementById('otp').value = '';
            otpSent = false;
        }

        // Admin view functions (for accessing admin dashboard)
        function showAdminView() {
            if (currentUser && currentUser.role === 'admin') {
                isAdminView = true;
                loadAdminDashboard();
            } else {
                alert('Admin access required');
            }
        }

        function loadAdminDashboard() {
            // Hide employee dashboard, show admin dashboard
            document.getElementById('dashboard-page').classList.add('hidden');
            document.getElementById('admin-dashboard-page').classList.remove('hidden');
            isAdminView = true;
            
            // Initialize overview service if on overview page
            if (overviewService) {
                overviewService.init();
            }
        }

        function goBackToEmployeeView() {
            // Hide admin dashboard, show employee dashboard
            document.getElementById('admin-dashboard-page').classList.add('hidden');
            document.getElementById('dashboard-page').classList.remove('hidden');
            isAdminView = false;
        }

        // Event listeners
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('send-otp-btn').addEventListener('click', sendOTP);
        
        // Setup email check for existing valid OTP
        setupEmailCheck();

        // Check if user is already logged in on page load
        // (This is handled in DOMContentLoaded above)

        // Logout functionality (connected to logout buttons)
        function handleLogout() {
            logout(); // Use the logout function we defined above (uses authService.logout())
        }

        // Clear Cache Handler
        async function handleClearCache() {
            try {
                // Show loading state
                const button = document.getElementById('clear-cache-button');
                const originalText = button.innerHTML;
                button.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" class="animate-spin"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Clearing...';
                button.disabled = true;

                // Unregister all service workers
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const reg of registrations) {
                    await reg.unregister();
                    console.log(' Unregistered service worker:', reg.scope);
                }

                // Delete all caches
                const cacheNames = await caches.keys();
                for (const name of cacheNames) {
                    await caches.delete(name);
                    console.log(' Deleted cache:', name);
                }

                // Clear localStorage version
                localStorage.removeItem('sw_version');

                // Show success message
                button.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Cleared! Reloading...';
                
                // Reload after a short delay
                setTimeout(() => {
                    window.location.reload(true);
                }, 1000);
            } catch (error) {
                console.error(' Clear cache failed:', error);
                alert('Failed to clear cache. Please try again.');
                const button = document.getElementById('clear-cache-button');
                button.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg> Clear Cache & Reload';
                button.disabled = false;
            }
        }

        // Add click handlers
        document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'admin-view-btn') {
                showAdminView();
            }
            if (e.target && e.target.id === 'clear-cache-button' || e.target.closest('#clear-cache-button')) {
                handleClearCache();
            }
            if (e.target && e.target.id === 'logout-button' || e.target && e.target.id === 'admin-logout-btn') {
                handleLogout();
            }
            if (e.target && e.target.id === 'back-to-employee-btn') {
                goBackToEmployeeView();
            }
        });

        // All services now use Supabase - no mock data needed

        // Mobile menu functionality
        function initMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            if (window.innerWidth <= 768) {
                if (mobileMenuBtn) mobileMenuBtn.style.display = 'block';
            } else {
                if (mobileMenuBtn) mobileMenuBtn.style.display = 'none';
                if (sidebar) sidebar.classList.remove('mobile-open');
                if (sidebarOverlay) sidebarOverlay.classList.remove('active');
            }
        }

        // Toggle mobile sidebar
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            // Close search popup when sidebar opens
            const searchResults = document.getElementById('inhouse-dash-searchResults');
            const searchBackdrop = document.getElementById('inhouse-dash-searchBackdrop');
            if (searchResults) {
                searchResults.classList.remove('active');
                searchResults.style.display = 'none';
            }
            if (searchBackdrop) {
                searchBackdrop.classList.remove('active');
                searchBackdrop.style.display = 'none';
            }
            
            if (sidebar && sidebarOverlay) {
                sidebar.classList.toggle('mobile-open');
                sidebarOverlay.classList.toggle('active');
            }
        }

        // Close mobile sidebar
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            if (sidebar && sidebarOverlay) {
                sidebar.classList.remove('mobile-open');
                sidebarOverlay.classList.remove('active');
            }
        }

        // Initialize mobile menu on load and resize
        initMobileMenu();
        window.addEventListener('resize', initMobileMenu);

        // Mobile menu button click
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', toggleMobileSidebar);
        }

        // Close sidebar when clicking overlay
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', closeMobileSidebar);
        }

        // Navigation - use event delegation to ensure clicks work
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.addEventListener('click', (e) => {
                const navItem = e.target.closest('.nav-item');
                if (navItem) {
                    e.stopPropagation();
                    const tabId = navItem.dataset.tab;
                
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                navItem.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                
                // Reload home data when home tab is clicked
                if (tabId === 'home' && homeService) {
                    homeService.loadDashboardData();
                }
                
                // Initialize catalogue when catalogue tab is clicked
                if (tabId === 'catalogue' && catalogueService) {
                    if (!window.catalogueInitialized) {
                        window.catalogueInitialized = true;
                        catalogueService.init('catalogue-products-grid', 'add-product-form');
                    } else {
                        // Reload products if already initialized
                        catalogueService.loadProductsFromDatabase();
                    }
                }
                
                // Initialize sales service when sales tab is clicked
                if (tabId === 'new-requests') {
                    if (!window.salesService) {
                        window.salesService = new SalesService();
                    }
                    if (!window.salesInitialized) {
                        window.salesInitialized = true;
                        window.salesService.init('newRequestsContainer');
                    } else {
                        // Reload orders if already initialized
                        window.salesService.loadOrdersFromDatabase();
                    }
                }
                
                // Initialize deleted orders service when deleted-orders tab is clicked
                if (tabId === 'deleted-orders') {
                    if (deletedOrdersService) {
                        deletedOrdersService.init('employee-deleted-orders-container');
                    }
                }
                
                // Initialize production service when production tab is clicked
                if (tabId === 'in-progress') {
                    if (!window.productionService) {
                        window.productionService = new ProductionService();
                    }
                    if (!window.productionInitialized) {
                        window.productionInitialized = true;
                        window.productionService.init('inProgressContainer');
                    } else {
                        // Reload orders if already initialized
                        window.productionService.loadOrdersFromDatabase();
                    }
                }
                
                // Initialize logistics service when logistics tab is clicked
                if (tabId === 'to-deliver') {
                    if (!window.logisticsService) {
                        window.logisticsService = new LogisticsService();
                    }
                    if (!window.logisticsInitialized) {
                        window.logisticsInitialized = true;
                        window.logisticsService.init('toDeliverContainer');
                    } else {
                        // Reload orders if already initialized
                        window.logisticsService.loadOrdersFromDatabase();
                    }
                }
                
                // Initialize after sales service when completed tab is clicked
                if (tabId === 'completed') {
                    if (!window.afterSalesService) {
                        window.afterSalesService = new AfterSalesService();
                    }
                    if (!window.afterSalesInitialized) {
                        window.afterSalesInitialized = true;
                        window.afterSalesService.init('completedTableBody');
                    } else {
                        // Reload orders if already initialized
                        window.afterSalesService.reloadOrders();
                    }
                }
                
                // Initialize returns service when returns tab is clicked
                if (tabId === 'returns') {
                    if (!window.returnsService) {
                        window.returnsService = new ReturnsService();
                    }
                    if (!window.returnsInitialized) {
                        window.returnsInitialized = true;
                        window.returnsService.init('returnsContainer', 'add-return-modal', 'add-return-form');
                    } else {
                        // Reload returns if already initialized
                        window.returnsService.reloadReturns();
                    }
                }
                
                // Initialize in-house order form when inperson-order tab is clicked
                if (tabId === 'inperson-order') {
                    if (!window.inhouseFormInitialized) {
                        window.inhouseFormInitialized = true;
                        initializeInhouseOrderForm();
                    }
                }
                
                    // Close mobile sidebar after navigation
                    if (window.innerWidth <= 768) {
                        closeMobileSidebar();
                    }
                }
            });
        }

        // Load profile data
        async function loadProfileData() {
            try {
                const currentUser = authService.getCurrentUser();
                if (!currentUser) return;

                const supabase = getSupabaseClient();
                if (!supabase) return;

                // Fetch user data from database
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) {
                    console.error('Error loading profile:', error);
                    // Use current user data from auth service as fallback
                    updateProfileDisplay(currentUser);
                    return;
                }

                // Update profile display with database data
                updateProfileDisplay(userData || currentUser);

                // Load performance stats
                await loadProfileStats(currentUser.id);
            } catch (error) {
                console.error('Error in loadProfileData:', error);
                // Fallback to current user data
                const currentUser = authService.getCurrentUser();
                if (currentUser) {
                    updateProfileDisplay(currentUser);
                }
            }
        }

        // Update profile display
        function updateProfileDisplay(user) {
            // Avatar initials
            const avatarEl = document.getElementById('profile-avatar-initials');
            if (avatarEl && user.name) {
                const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) || '-';
                avatarEl.textContent = initials;
            }

            // Name
            const nameEl = document.getElementById('profile-name');
            if (nameEl) nameEl.textContent = user.name || '-';

            // Email
            const emailEl = document.getElementById('profile-email');
            if (emailEl) emailEl.textContent = user.email || '-';

            // Phone
            const phoneEl = document.getElementById('profile-phone');
            if (phoneEl) phoneEl.textContent = user.phone || '-';

            // Role
            const roleEl = document.getElementById('profile-role');
            if (roleEl) {
                const roleDisplay = user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : '-';
                roleEl.textContent = roleDisplay;
            }

            // Join Date
            const joinDateEl = document.getElementById('profile-join-date');
            if (joinDateEl) {
                if (user.created_at) {
                    const date = new Date(user.created_at);
                    joinDateEl.textContent = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                } else {
                    joinDateEl.textContent = '-';
                }
            }

            // Status
            const statusEl = document.getElementById('profile-status');
            if (statusEl) {
                const statusDisplay = user.status ? user.status.charAt(0).toUpperCase() + user.status.slice(1) : '-';
                statusEl.textContent = statusDisplay;
            }
        }

        // Load profile performance stats
        async function loadProfileStats(userId) {
            try {
                const supabase = getSupabaseClient();
                if (!supabase) return;

                // Get current month start
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const monthStartStr = monthStart.toISOString().split('T')[0];

                // Count orders completed by this user
                const { count: totalOrders } = await supabase
                    .from('orders')
                    .select('*', { count: 'exact', head: true })
                    .eq('assigned_to', userId)
                    .eq('status', 'completed');

                // Count orders this month
                const { count: monthOrders } = await supabase
                    .from('orders')
                    .select('*', { count: 'exact', head: true })
                    .eq('assigned_to', userId)
                    .eq('status', 'completed')
                    .gte('completed_at', monthStartStr);

                // Update display
                const ordersEl = document.getElementById('profile-orders-completed');
                if (ordersEl) ordersEl.textContent = totalOrders || 0;

                const monthEl = document.getElementById('profile-this-month');
                if (monthEl) monthEl.textContent = monthOrders || 0;

                // Get user's avg response time from users table
                const { data: userData } = await supabase
                    .from('users')
                    .select('avg_response_time')
                    .eq('id', userId)
                    .single();

                const responseEl = document.getElementById('profile-avg-response');
                if (responseEl) {
                    if (userData?.avg_response_time) {
                        const minutes = userData.avg_response_time;
                        responseEl.textContent = minutes < 60 ? `${minutes} min` : `${Math.round(minutes / 60)} hours`;
                    } else {
                        responseEl.textContent = '-';
                    }
                }

                const statusEl = document.getElementById('profile-performance-status');
                if (statusEl) {
                    const { data: userStatus } = await supabase
                        .from('users')
                        .select('status')
                        .eq('id', userId)
                        .single();
                    
                    if (userStatus?.status) {
                        statusEl.textContent = userStatus.status.charAt(0).toUpperCase() + userStatus.status.slice(1);
                    } else {
                        statusEl.textContent = '-';
                    }
                }
            } catch (error) {
                console.error('Error loading profile stats:', error);
            }
        }

        // Profile button from home page
        const profileBtnHome = document.getElementById('profile-btn-home');
        if (profileBtnHome) {
            const handleProfileClick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                // Show profile tab
                const profileTab = document.getElementById('profile');
                if (profileTab) {
                    profileTab.classList.add('active');
                    // Load profile data when tab is shown
                    loadProfileData();
                }
                // Update nav (create a temporary nav item for profile)
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            };
            profileBtnHome.addEventListener('click', handleProfileClick, { passive: false });
            profileBtnHome.addEventListener('touchstart', (e) => {
                e.stopPropagation();
            }, { passive: true });
            profileBtnHome.addEventListener('touchend', handleProfileClick, { passive: false });
        }

        // Back to home button from profile
        const backToHomeBtn = document.getElementById('back-to-home-btn');
        if (backToHomeBtn) {
            backToHomeBtn.addEventListener('click', () => {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                // Show home tab
                document.getElementById('home').classList.add('active');
                // Update nav - set home as active
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                const homeNavItem = document.querySelector('[data-tab="home"]');
                if (homeNavItem) {
                    homeNavItem.classList.add('active');
                }
            });
        }

        // Format delivery option for display
        function formatDeliveryOption(option) {
            const options = {
                'uber': 'Uber',
                'pickup-mtaani': 'Pick Up Mtaani',
                'courier': 'Courier',
                'in-store-pickup': 'In Store Pick Up'
            };
            return options[option] || option;
        }

        // Format payment option for display
        function formatPaymentOption(option) {
            const options = {
                'mpesa': 'Mpesa',
                'stk-push': 'STK Push',
                'card': 'Card',
                'paypal': 'Paypal',
                'apple-pay': 'Apple Pay'
            };
            return options[option] || option;
        }

        // Render order bubble
        function createOrderBubble(order, type) {
            const bubble = document.createElement('div');
            bubble.className = 'order-bubble';
            bubble.innerHTML = `
                <div class="order-header">
                    <img src="${order.productImage}" alt="${order.productName}" class="order-image">
                    <div class="order-info">
                        <div class="customer-name">${order.customerName}</div>
                        <div class="product-name">${order.productName}</div>
                        <span class="product-color">Colour: ${order.color}</span>
                    </div>
                </div>
                <div class="order-details" id="details-${order.id}">
                    <div class="detail-row">
                        <div class="detail-label">Phone:</div>
                        <div class="detail-value">${order.phone}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Price:</div>
                        <div class="detail-value">KES ${order.price.toLocaleString()}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Measurements:</div>
                        <div class="detail-value">
                            ${(() => {
                                const parts = [];
                                if (order.measurements.size && order.measurements.size !== 'N/A' && order.measurements.size !== '') {
                                    parts.push(`Size: ${order.measurements.size}`);
                                }
                                if (order.measurements.bust && order.measurements.bust !== 'N/A' && order.measurements.bust !== '') {
                                    parts.push(`Bust: ${order.measurements.bust}"`);
                                }
                                if (order.measurements.waist && order.measurements.waist !== 'N/A' && order.measurements.waist !== '') {
                                    parts.push(`Waist: ${order.measurements.waist}"`);
                                }
                                if (order.measurements.hips && order.measurements.hips !== 'N/A' && order.measurements.hips !== '') {
                                    parts.push(`Hips: ${order.measurements.hips}"`);
                                }
                                // Length is not collected in the order form, so we don't display it
                                return parts.length > 0 ? parts.join(', ') : 'No measurements provided';
                            })()}
                        </div>
                    </div>
                    ${order.comments ? `
                        <div class="detail-row">
                            <div class="detail-label">Comments:</div>
                            <div class="detail-value">${order.comments}</div>
                        </div>
                    ` : ''}
                    ${order.deliveryOption ? `
                        <div class="detail-row">
                            <div class="detail-label">Preferred Choice of Delivery:</div>
                            <div class="detail-value">${formatDeliveryOption(order.deliveryOption)}</div>
                        </div>
                    ` : ''}
                    ${order.paymentOption ? `
                        <div class="detail-row">
                            <div class="detail-label">Payment Option:</div>
                            <div class="detail-value">${order.paymentOption === 'mpesa' && order.paymentReference && order.paymentReference.startsWith('INHOUSE-')
                                ? `inhouse; mpesa code: ${order.paymentReference.replace('INHOUSE-', '')}` 
                                : order.paymentOption === 'mpesa' && order.paymentReference
                                ? `${formatPaymentOption(order.paymentOption)} (Code: ${order.paymentReference})`
                                : formatPaymentOption(order.paymentOption)}</div>
                        </div>
                    ` : ''}
                    <div class="detail-row">
                        <div class="detail-label">Order Date:</div>
                        <div class="detail-value">${order.date}</div>
                    </div>
                </div>
                <div class="order-actions">
                    ${type === 'new' ? `
                        <button class="btn btn-accept" onclick="acceptOrder(${order.id})">Accept</button>
                    ` : ''}
                    ${type === 'progress' ? `
                        <button class="btn btn-done" onclick="markAsDone(${order.id})">Mark as Done</button>
                    ` : ''}
                    ${type === 'deliver' ? `
                        <button class="btn btn-delivered" onclick="markAsDelivered(${order.id})">Delivered</button>
                    ` : ''}
                </div>
            `;

            bubble.addEventListener('click', (e) => {
                // Check if click is on or inside a button
                if (!e.target.closest('.btn')) {
                    bubble.classList.toggle('expanded');
                }
            });

            return bubble;
        }

        // Order actions (Sales, Production, and Logistics now handled by their services)

        // After Sales now handled by afterSalesService

        // Simple charts using canvas
        function drawChart(canvasId, type, data) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            if (type === 'bar') {
                const maxValue = Math.max(...data.values);
                const barWidth = (width - 100) / data.labels.length;
                const padding = 60;

                data.values.forEach((value, i) => {
                    const barHeight = (value / maxValue) * (height - padding - 40);
                    const x = padding + i * barWidth;
                    const y = height - padding - barHeight;

                    const gradient = ctx.createLinearGradient(0, y, 0, height - padding);
                    gradient.addColorStop(0, '#41463F');
                    gradient.addColorStop(1, '#353C35');

                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, y, barWidth - 20, barHeight);

                    ctx.fillStyle = '#2D332D';
                    ctx.font = 'bold 13px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(data.labels[i], x + (barWidth - 20) / 2, height - 40);
                    ctx.fillText(value, x + (barWidth - 20) / 2, y - 5);
                });
            } else if (type === 'doughnut') {
                const centerX = width / 2;
                const centerY = height / 2;
                const radius = Math.min(width, height) / 3;
                let currentAngle = -Math.PI / 2;
                const total = data.values.reduce((a, b) => a + b, 0);

                const colors = ['#41463F', '#4A5249', '#50584F', '#353C35'];

                data.values.forEach((value, i) => {
                    const sliceAngle = (value / total) * 2 * Math.PI;
                    
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                    ctx.arc(centerX, centerY, radius * 0.6, currentAngle + sliceAngle, currentAngle, true);
                    ctx.closePath();
                    ctx.fillStyle = colors[i];
                    ctx.fill();

                    const labelAngle = currentAngle + sliceAngle / 2;
                    // Perfect positioning: 40px from outer edge - optimal distance (not too close, not too far)
                    const outerRadius = radius;
                    const innerRadius = radius * 0.6; // Inner edge of donut hole
                    const labelDistance = outerRadius + 40;
                    
                    // Minimum distances to enforce
                    const minDistanceFromCenter = innerRadius + 30; // Increased buffer to keep outside donut hole
                    const minDistanceFromOuter = outerRadius + 40; // Increased buffer to keep away from edge
                    
                    // Position label at the center angle of its segment
                    let labelX = centerX + Math.cos(labelAngle) * labelDistance;
                    let labelY = centerY + Math.sin(labelAngle) * labelDistance;
                    
                    // Calculate distance from center
                    let distanceFromCenter = Math.sqrt(Math.pow(labelX - centerX, 2) + Math.pow(labelY - centerY, 2));
                    
                    // Check if label is too close to center (inside donut hole) and push it outward (fixes After Sales)
                    if (distanceFromCenter < minDistanceFromCenter) {
                        // Push label outward to ensure it's outside the donut hole
                        labelX = centerX + Math.cos(labelAngle) * minDistanceFromCenter;
                        labelY = centerY + Math.sin(labelAngle) * minDistanceFromCenter;
                        distanceFromCenter = minDistanceFromCenter;
                    }
                    
                    // Check if label is too close to outer edge and push it further out (fixes Production)
                    if (distanceFromCenter < minDistanceFromOuter) {
                        // Ensure minimum distance from outer edge
                        labelX = centerX + Math.cos(labelAngle) * minDistanceFromOuter;
                        labelY = centerY + Math.sin(labelAngle) * minDistanceFromOuter;
                        distanceFromCenter = minDistanceFromOuter;
                    }
                    
                    // Keep labels within canvas bounds while maintaining minimum distances
                    const edgePadding = 10;
                    
                    // Simple boundary clamping that maintains radial distance
                    const maxCanvasDistance = Math.min(width, height) / 2 - edgePadding;
                    if (distanceFromCenter > maxCanvasDistance) {
                        // If too far, bring it back but maintain minimums
                        const safeDistance = Math.max(minDistanceFromOuter, maxCanvasDistance);
                        labelX = centerX + Math.cos(labelAngle) * safeDistance;
                        labelY = centerY + Math.sin(labelAngle) * safeDistance;
                    }
                    
                    // Final boundary check - clamp to edges if needed
                    labelX = Math.max(edgePadding, Math.min(width - edgePadding, labelX));
                    labelY = Math.max(edgePadding, Math.min(height - edgePadding, labelY));
                    
                    // Re-check minimum distances after clamping
                    const finalDistance = Math.sqrt(Math.pow(labelX - centerX, 2) + Math.pow(labelY - centerY, 2));
                    if (finalDistance < minDistanceFromCenter) {
                        const angle = Math.atan2(labelY - centerY, labelX - centerX);
                        labelX = centerX + Math.cos(angle) * minDistanceFromCenter;
                        labelY = centerY + Math.sin(angle) * minDistanceFromCenter;
                    } else if (finalDistance < minDistanceFromOuter) {
                        const angle = Math.atan2(labelY - centerY, labelX - centerX);
                        labelX = centerX + Math.cos(angle) * minDistanceFromOuter;
                        labelY = centerY + Math.sin(angle) * minDistanceFromOuter;
                    }

                    // Draw label with maximum visibility - dark color, bold font
                    ctx.fillStyle = '#2D332D';
                    ctx.font = 'bold 14px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    // Display label clearly beside its segment
                    ctx.fillText(`${data.labels[i]}: ${value}`, labelX, labelY);

                    currentAngle += sliceAngle;
                });
            }
        }

        // Returns now handled by returnsService

        // Charts will be rendered by homeService when data is loaded
        // Initial empty charts (will be updated by homeService)
        if (homeService) {
            homeService.renderCharts({
                weekly: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], values: [0, 0, 0, 0, 0, 0, 0] },
                status: { labels: ['Sales', 'Production', 'Logistics', 'After Sales'], values: [0, 0, 0, 0] }
            });
        }

        // Admin Dashboard Navigation
        async function showAdminPage(pageId) {
            // Hide all admin content pages
            const contentPages = document.querySelectorAll('#admin-dashboard-page .content-page');
            contentPages.forEach(page => {
                page.classList.add('hidden');
            });

            // Show selected page
            const selectedPage = document.getElementById('admin-' + pageId + '-content');
            if (selectedPage) {
                selectedPage.classList.remove('hidden');
                
                // Load page-specific data
                if (pageId === 'overview') {
                    // Initialize overview service when overview page is shown
                    if (overviewService) {
                        overviewService.init();
                    }
                } else if (pageId === 'revenue') {
                    // Initialize revenue service when revenue page is shown
                    if (revenueService) {
                        revenueService.init();
                    }
                    // Initialize costs service
                    if (costsService && !costsService.supabase) {
                        costsService.init();
                    }
                    // Load costs table
                    if (typeof loadCostsTable === 'function') {
                        loadCostsTable();
                    }
                } else if (pageId === 'analytics') {
                    // Initialize analytics service when analytics page is shown
                    if (analyticsService) {
                        analyticsService.init();
                    }
                } else if (pageId === 'kanban') {
                    // Initialize kanban service when kanban page is shown
                    if (kanbanService) {
                        if (!kanbanService.supabase) {
                            await kanbanService.init();
                        } else {
                            // Reload tasks if already initialized
                            await kanbanService.loadTasks();
                        }
                    } else {
                        console.error('KanbanService not found. Make sure kanbanService.js is loaded.');
                    }
                } else if (pageId === 'staff') {
                    populateAdminStaffCards();
                    setupAddStaffForm();
                } else if (pageId === 'trash') {
                    // Initialize deleted orders service when trash page is shown
                    if (deletedOrdersService) {
                        deletedOrdersService.init('admin-deleted-orders-container');
                    }
                }
            }

            // Update navigation links
            const navLinks = document.querySelectorAll('#admin-dashboard-page .nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active', 'bg-white/20', 'text-white');
                link.classList.add('text-white/80');
            });

            const activeLink = document.querySelector(`#admin-dashboard-page [data-page="${pageId}"]`);
            if (activeLink) {
                activeLink.classList.add('active', 'bg-white/20', 'text-white');
                activeLink.classList.remove('text-white/80');
            }
        }

        // Function to populate admin staff cards from database
        async function populateAdminStaffCards() {
            const staffContainer = document.getElementById('admin-staff-list-container');
            if (!staffContainer) return;

            // Show loading
            staffContainer.innerHTML = '<div class="glass-card p-6 text-center text-white/60"><p>Loading staff members...</p></div>';

            try {
                // Fetch staff from database
                const staff = await staffManagementService.fetchAllStaff();

                if (staff.length === 0) {
                    staffContainer.innerHTML = '<div class="glass-card p-6 text-center text-white/60"><p>No staff members yet. Add your first staff member!</p></div>';
                return;
            }

                staffContainer.innerHTML = '';
                staff.forEach(member => {
                    const card = createAdminStaffCard(member);
                    staffContainer.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading staff:', error);
                staffContainer.innerHTML = '<div class="glass-card p-6 text-center text-white/60"><p>Error loading staff members. Please refresh.</p></div>';
            }
        }

        // Create admin staff card element
        function createAdminStaffCard(staff) {
            const card = document.createElement('div');
            card.className = 'glass-card hover:bg-white/15 transition-all duration-300';
            
            const initials = staff.name.split(' ').map(n => n[0]).join('').toUpperCase();
            const bgColor = staff.role === 'sales' ? 'bg-accent' : 
                           staff.role === 'production' ? 'bg-primary' : 
                           staff.role === 'instore' ? 'bg-secondary' : 
                           staff.role === 'admin' ? 'bg-secondary' : 'bg-muted-foreground';
            
            const avgResponseTime = staff.avg_response_time 
                ? (staff.avg_response_time < 60 ? `${staff.avg_response_time} min` : `${Math.round(staff.avg_response_time / 60)} hours`)
                : 'N/A';
            
            card.innerHTML = `
                <div class="p-6">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 ${bgColor} rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-lg">${initials}</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-white font-semibold">${staff.name}</h3>
                            <p class="text-white/70 text-sm capitalize">${staff.role}</p>
                            <p class="text-white/50 text-xs mt-1">${staff.email}</p>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-white/60">Orders Completed:</span>
                            <span class="text-white">${staff.orders_completed || 0}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-white/60">Avg Response Time:</span>
                            <span class="text-white">${avgResponseTime}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-white/60">Status:</span>
                            <span class="text-accent capitalize">${staff.status || 'active'}</span>
                        </div>
                        ${staff.phone ? `<div class="flex justify-between"><span class="text-white/60">Phone:</span><span class="text-white">${staff.phone}</span></div>` : ''}
                    </div>
                    <div class="mt-4 pt-4 border-t" style="border-color: rgba(224, 216, 201, 0.2) !important;">
                        <button class="delete-staff-btn w-full py-2 px-4 rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2" data-staff-id="${staff.id}" data-staff-name="${staff.name}" style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444;">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Delete Staff
                        </button>
                    </div>
                </div>
            `;
            
            // Add delete button event listener
            const deleteBtn = card.querySelector('.delete-staff-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    handleDeleteStaff(staff.id, staff.name);
                });
            }
            
            return card;
        }

        // Handle delete staff member
        async function handleDeleteStaff(staffId, staffName) {
            // Confirm deletion
            const confirmed = confirm(`Are you sure you want to delete ${staffName}? This action cannot be undone.`);
            if (!confirmed) return;

            try {
                const result = await staffManagementService.deleteStaffMember(staffId);
                
                if (result.success) {
                    showStaffMessage(`Staff member ${staffName} deleted successfully`, 'success');
                    // Refresh staff list
                    await populateAdminStaffCards();
                } else {
                    showStaffMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting staff:', error);
                showStaffMessage('An error occurred while deleting staff member', 'error');
            }
        }

        // Add Staff Form Handling
        function setupAddStaffForm() {
            const addStaffBtn = document.getElementById('add-staff-btn');
            const cancelBtn = document.getElementById('cancel-add-staff-btn');
            const form = document.getElementById('add-staff-form');
            const formContainer = document.getElementById('add-staff-form-container');

            // Show form
            if (addStaffBtn) {
                addStaffBtn.addEventListener('click', () => {
                    formContainer.classList.remove('hidden');
                    form.reset();
                    const messageDiv = document.getElementById('add-staff-message');
                    if (messageDiv) messageDiv.classList.add('hidden');
                });
            }

            // Hide form
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    formContainer.classList.add('hidden');
                    form.reset();
                    const messageDiv = document.getElementById('add-staff-message');
                    if (messageDiv) messageDiv.classList.add('hidden');
                });
            }

            // Handle form submission
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const submitBtn = document.getElementById('submit-staff-btn');
                    const messageDiv = document.getElementById('add-staff-message');
                    
                    // Get current admin user
                    const currentUser = authService.getCurrentUser();
                    if (!currentUser || currentUser.role !== 'admin') {
                        showStaffMessage('Only admins can add staff members', 'error');
                        return;
                    }

                    // Get form data
                    const staffData = {
                        name: document.getElementById('staff-name').value.trim(),
                        email: document.getElementById('staff-email').value.trim(),
                        role: document.getElementById('staff-role').value,
                        phone: document.getElementById('staff-phone').value.trim() || null
                    };

                    // Disable button
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Adding...';

                    try {
                        // Add staff member
                        const result = await staffManagementService.addStaffMember(staffData, currentUser.id);

                        if (result.success) {
                            showStaffMessage(result.message, 'success');
                            form.reset();
                            formContainer.classList.add('hidden');
                            
                            // Refresh staff list
                            await populateAdminStaffCards();
                        } else {
                            showStaffMessage(result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Error adding staff:', error);
                        showStaffMessage('An error occurred. Please try again.', 'error');
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Add Staff Member';
                    }
                });
            }
        }

        // Show message in add staff form
        function showStaffMessage(message, type) {
            const messageDiv = document.getElementById('add-staff-message');
            if (!messageDiv) return;
            
            messageDiv.className = type === 'success' 
                ? 'p-3 rounded-lg bg-green-500/20 border border-green-500/30 text-green-400 text-sm'
                : 'p-3 rounded-lg bg-red-500/20 border border-red-500/30 text-red-400 text-sm';
            messageDiv.textContent = message;
            messageDiv.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.classList.add('hidden');
                }, 5000);
            }
        }

        // Admin mobile menu functionality
        function initAdminMobileMenu() {
            const adminMobileMenuBtn = document.getElementById('admin-mobile-menu-btn');
            const adminSidebar = document.getElementById('admin-sidebar');
            const adminMobileOverlay = document.getElementById('admin-mobile-overlay');
            
            if (window.innerWidth <= 768) {
                if (adminMobileMenuBtn) adminMobileMenuBtn.style.display = 'flex';
            } else {
                if (adminMobileMenuBtn) adminMobileMenuBtn.style.display = 'none';
                if (adminSidebar) adminSidebar.classList.remove('mobile-open');
                if (adminMobileOverlay) adminMobileOverlay.classList.add('hidden');
            }
        }

        function toggleAdminMobileSidebar() {
            const adminSidebar = document.getElementById('admin-sidebar');
            const adminMobileOverlay = document.getElementById('admin-mobile-overlay');
            const adminMenuIcon = document.getElementById('admin-menu-icon');
            const adminCloseIcon = document.getElementById('admin-close-icon');
            
            // Close search popup when sidebar opens
            const searchResults = document.getElementById('inhouse-dash-searchResults');
            const searchBackdrop = document.getElementById('inhouse-dash-searchBackdrop');
            if (searchResults) {
                searchResults.classList.remove('active');
                searchResults.style.display = 'none';
            }
            if (searchBackdrop) {
                searchBackdrop.classList.remove('active');
                searchBackdrop.style.display = 'none';
            }
            
            if (adminSidebar && adminMobileOverlay) {
                const isOpen = adminSidebar.classList.contains('mobile-open');
                if (isOpen) {
                    adminSidebar.classList.remove('mobile-open');
                    adminMobileOverlay.classList.add('hidden');
                    if (adminMenuIcon) adminMenuIcon.classList.remove('hidden');
                    if (adminCloseIcon) adminCloseIcon.classList.add('hidden');
                } else {
                    adminSidebar.classList.add('mobile-open');
                    adminMobileOverlay.classList.remove('hidden');
                    if (adminMenuIcon) adminMenuIcon.classList.add('hidden');
                    if (adminCloseIcon) adminCloseIcon.classList.remove('hidden');
                }
            }
        }

        function closeAdminMobileSidebar() {
            const adminSidebar = document.getElementById('admin-sidebar');
            const adminMobileOverlay = document.getElementById('admin-mobile-overlay');
            const adminMenuIcon = document.getElementById('admin-menu-icon');
            const adminCloseIcon = document.getElementById('admin-close-icon');
            
            if (adminSidebar && adminMobileOverlay) {
                adminSidebar.classList.remove('mobile-open');
                adminMobileOverlay.classList.add('hidden');
                if (adminMenuIcon) adminMenuIcon.classList.remove('hidden');
                if (adminCloseIcon) adminCloseIcon.classList.add('hidden');
            }
        }

        // Initialize admin mobile menu
        initAdminMobileMenu();
        window.addEventListener('resize', () => {
            initMobileMenu();
            initAdminMobileMenu();
        });

        // Admin mobile menu button click
        const adminMobileMenuBtn = document.getElementById('admin-mobile-menu-btn');
        if (adminMobileMenuBtn) {
            adminMobileMenuBtn.addEventListener('click', toggleAdminMobileSidebar);
        }

        // Close admin sidebar when clicking overlay
        const adminMobileOverlay = document.getElementById('admin-mobile-overlay');
        if (adminMobileOverlay) {
            adminMobileOverlay.addEventListener('click', closeAdminMobileSidebar);
        }

        // Add event listeners for admin navigation - use event delegation
        const adminSidebar = document.getElementById('admin-sidebar');
        if (adminSidebar) {
            adminSidebar.addEventListener('click', (e) => {
                const navLink = e.target.closest('.nav-link');
                if (navLink) {
                    e.stopPropagation();
                    e.preventDefault();
                    const pageId = navLink.getAttribute('data-page');
                    if (pageId) {
                        showAdminPage(pageId);
                        
                        // Close mobile sidebar after navigation
                        if (window.innerWidth <= 768) {
                            closeAdminMobileSidebar();
                        }
                    }
                }
            });
        }
        
        // Also keep the original event listeners as backup
        document.addEventListener('DOMContentLoaded', () => {
            const adminNavLinks = document.querySelectorAll('#admin-dashboard-page .nav-link');
            adminNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page');
                    if (pageId) {
                        showAdminPage(pageId);
                        
                        // Close mobile sidebar after navigation
                        if (window.innerWidth <= 768) {
                            closeAdminMobileSidebar();
                        }
                    }
                });
            });
        });

        // Kanban Board Functions
        let currentEditingCardId = null;

        function openAddKanbanCardModal(status) {
            const modal = document.getElementById('kanban-card-modal');
            const form = document.getElementById('kanban-card-form');
            const title = document.getElementById('kanban-modal-title');
            const statusSelect = document.getElementById('kanban-card-status');
            
            title.textContent = 'Add New Card';
            form.reset();
            document.getElementById('kanban-card-id').value = '';
            currentEditingCardId = null;
            statusSelect.value = status || 'todo';
            document.getElementById('kanban-card-message').classList.add('hidden');
            
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        async function editKanbanCard(cardId, currentStatus) {
            if (!kanbanService) {
                alert('Kanban service not available. Please refresh the page.');
                return;
            }

            // Initialize if not already initialized
            if (!kanbanService.supabase) {
                await kanbanService.init();
                if (!kanbanService.supabase) {
                    alert('Failed to initialize kanban service. Please check your connection.');
                    return;
                }
            }

            // Find task in kanbanService
            const task = kanbanService.tasks.find(t => t.id === cardId);
            if (!task) {
                alert('Card not found');
                return;
            }
            
            const modal = document.getElementById('kanban-card-modal');
            const form = document.getElementById('kanban-card-form');
            const modalTitle = document.getElementById('kanban-modal-title');
            
            modalTitle.textContent = 'Edit Card';
            document.getElementById('kanban-card-title').value = task.title;
            document.getElementById('kanban-card-description').value = task.description || '';
            document.getElementById('kanban-card-priority').value = task.priority || 'medium';
            document.getElementById('kanban-card-status').value = task.status || currentStatus;
            document.getElementById('kanban-card-id').value = cardId;
            currentEditingCardId = cardId;
            document.getElementById('kanban-card-message').classList.add('hidden');
            
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        async function deleteKanbanCard(cardId) {
            if (!confirm('Mark this card as done and remove it?')) return;
            
            if (!kanbanService) {
                alert('Kanban service not available. Please refresh the page.');
                return;
            }

            // Initialize if not already initialized
            if (!kanbanService.supabase) {
                await kanbanService.init();
                if (!kanbanService.supabase) {
                    alert('Failed to initialize kanban service. Please check your connection.');
                    return;
                }
            }

            const result = await kanbanService.deleteTask(cardId);
            if (result.success) {
                // Task will be removed by kanbanService.renderTasks()
            } else {
                alert(result.message || 'Failed to delete card');
            }
        }

        // updateKanbanCounts is now handled by kanbanService

        // Setup kanban card hover effects
        document.addEventListener('DOMContentLoaded', function() {
            // Add hover effects to show edit/done buttons
            document.querySelectorAll('.kanban-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.querySelectorAll('.edit-kanban-btn, .done-kanban-btn').forEach(btn => {
                        btn.style.opacity = '1';
                    });
                });
                card.addEventListener('mouseleave', function() {
                    this.querySelectorAll('.edit-kanban-btn, .done-kanban-btn').forEach(btn => {
                        btn.style.opacity = '0';
                    });
                });
            });

            // Kanban card form submission
            const kanbanForm = document.getElementById('kanban-card-form');
            if (kanbanForm) {
                kanbanForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const title = document.getElementById('kanban-card-title').value.trim();
                    const description = document.getElementById('kanban-card-description').value.trim();
                    const priority = document.getElementById('kanban-card-priority').value;
                    const status = document.getElementById('kanban-card-status').value;
                    const cardId = document.getElementById('kanban-card-id').value;
                    
                    if (!title) {
                        alert('Please enter a title');
                        return;
                    }

                    if (!kanbanService) {
                        alert('Kanban service not available. Please refresh the page.');
                        return;
                    }

                    // Initialize if not already initialized
                    if (!kanbanService.supabase) {
                        await kanbanService.init();
                        if (!kanbanService.supabase) {
                            alert('Failed to initialize kanban service. Please check your connection.');
                            return;
                        }
                    }

                    const messageEl = document.getElementById('kanban-card-message');
                    messageEl.classList.add('hidden');

                    let result;
                    if (currentEditingCardId || cardId) {
                        // Update existing task
                        result = await kanbanService.updateTask(cardId || currentEditingCardId, {
                            title,
                            description,
                            status,
                            priority
                        });
                    } else {
                        // Create new task
                        result = await kanbanService.addTask({
                            title,
                            description,
                            status,
                            priority
                        });
                    }

                    if (result.success) {
                        // Close modal
                        const modal = document.getElementById('kanban-card-modal');
                        modal.classList.add('hidden');
                        modal.style.display = 'none';
                        kanbanForm.reset();
                        currentEditingCardId = null;
                        document.getElementById('kanban-card-id').value = '';
                        // Tasks will be rendered by kanbanService
                    } else {
                        messageEl.textContent = result.message || 'Failed to save card';
                        messageEl.className = 'text-red-500 text-sm mt-2';
                        messageEl.classList.remove('hidden');
                    }
                });
            }

            // Close modal handlers
            const cancelBtn = document.getElementById('cancel-kanban-card-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeKanbanCardModal);
            }

            const modal = document.getElementById('kanban-card-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeKanbanCardModal();
                    }
                });
            }
        });

        function closeKanbanCardModal() {
            const modal = document.getElementById('kanban-card-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
            currentEditingCardId = null;
        }

        // Costs Management Functions
        async function loadCostsTable() {
            const tableBody = document.getElementById('costs-table-body');
            if (!tableBody) return;

            try {
                // Get filter values
                const search = document.getElementById('cost-search')?.value || '';
                const dateFilter = document.getElementById('cost-date-filter')?.value || null;
                const amountFilter = document.getElementById('cost-amount-filter')?.value || null;
                const sortValue = document.getElementById('cost-sort')?.value || 'created_at-desc';
                const [sortBy, sortOrder] = sortValue.split('-');

                // Fetch costs
                const costs = await costsService.fetchCostsForTable({
                    search,
                    sortBy,
                    sortOrder,
                    dateFilter,
                    amountFilter,
                    limit: 10
                });

                // Render table
                if (costs.length === 0) {
                    tableBody.innerHTML = '<tr style="background: rgba(224, 216, 201, 0.1);"><td colspan="4" style="padding: 20px; text-align: center; color: #41463F;">No costs found for this month</td></tr>';
                    return;
                }

                tableBody.innerHTML = costs.map(cost => {
                    const date = new Date(cost.cost_date);
                    const formattedDate = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    const formattedAmount = `KES ${parseFloat(cost.amount).toLocaleString()}`;
                    
                    return `
                        <tr style="background: rgba(224, 216, 201, 0.1); border-bottom: 1px solid rgba(224, 216, 201, 0.2) !important;">
                            <td style="padding: 12px; color: #000000;">${cost.name}</td>
                            <td style="padding: 12px; color: #000000;">${formattedDate}</td>
                            <td style="padding: 12px; color: #000000; font-weight: 600;">${formattedAmount}</td>
                            <td style="padding: 12px;">
                                <button class="delete-cost-btn" data-cost-id="${cost.id}" style="padding: 4px 8px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Add delete event listeners
                tableBody.querySelectorAll('.delete-cost-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const costId = btn.getAttribute('data-cost-id');
                        if (confirm('Are you sure you want to delete this cost?')) {
                            const result = await costsService.deleteCost(costId);
                            if (result.success) {
                                loadCostsTable();
                                // Reload revenue to update gross income
                                if (revenueService) {
                                    revenueService.loadRevenueData();
                                }
                            } else {
                                alert(result.message);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading costs table:', error);
                tableBody.innerHTML = '<tr style="background: rgba(255, 255, 255, 0.2);"><td colspan="4" style="padding: 20px; text-align: center; color: #000000;">Error loading costs</td></tr>';
            }
        }

        // Add Cost Modal Functions
        function showAddCostModal() {
            const modal = document.getElementById('add-cost-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                const dateInput = document.getElementById('cost-date');
                if (dateInput) {
                    dateInput.value = today;
                }
            }
        }

        function hideAddCostModal() {
            const modal = document.getElementById('add-cost-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
                const form = document.getElementById('add-cost-form');
                if (form) {
                    form.reset();
                }
                const messageDiv = document.getElementById('add-cost-message');
                if (messageDiv) {
                    messageDiv.classList.add('hidden');
                    messageDiv.textContent = '';
                }
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('add-cost-modal');
            if (modal && !modal.classList.contains('hidden') && e.target === modal) {
                hideAddCostModal();
            }
        });

        // Initialize costs functionality when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Add cost button
            const addCostBtn = document.getElementById('add-cost-btn');
            if (addCostBtn) {
                addCostBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    showAddCostModal();
                });
            }

            // Cancel cost button
            const cancelCostBtn = document.getElementById('cancel-cost-btn');
            if (cancelCostBtn) {
                cancelCostBtn.addEventListener('click', hideAddCostModal);
            }

            // Add cost form submission
            const addCostForm = document.getElementById('add-cost-form');
            if (addCostForm) {
                addCostForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('cost-name').value.trim();
                    const cost_date = document.getElementById('cost-date').value;
                    const amount = document.getElementById('cost-amount').value;
                    const messageDiv = document.getElementById('add-cost-message');
                    const submitBtn = addCostForm.querySelector('button[type="submit"]');

                    if (!name || !cost_date || !amount) {
                        if (messageDiv) {
                            messageDiv.className = 'error-message';
                            messageDiv.textContent = 'Please fill in all fields';
                            messageDiv.classList.remove('hidden');
                        }
                        return;
                    }

                    // Disable button
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Adding...';

                    try {
                        // Initialize costs service if needed
                        if (costsService && !costsService.supabase) {
                            await costsService.init();
                        }

                        const result = await costsService.addCost({
                            name,
                            cost_date,
                            amount: parseFloat(amount)
                        });

                        if (result.success) {
                            if (messageDiv) {
                                messageDiv.className = 'error-message';
                                messageDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                                messageDiv.style.borderColor = 'rgba(239, 68, 68, 0.4)';
                                messageDiv.style.color = '#ef4444';
                                messageDiv.textContent = result.message;
                                messageDiv.classList.remove('hidden');
                            }
                            
                            // Reset form
                            addCostForm.reset();
                            
                            // Hide modal after short delay
                            setTimeout(() => {
                                hideAddCostModal();
                                // Reload costs table if on revenue page
                                if (document.getElementById('admin-revenue-content') && !document.getElementById('admin-revenue-content').classList.contains('hidden')) {
                                    loadCostsTable();
                                }
                                // Reload revenue to update gross income
                                if (revenueService) {
                                    revenueService.loadRevenueData();
                                }
                            }, 1500);
                        } else {
                            if (messageDiv) {
                                messageDiv.className = 'error-message';
                                messageDiv.textContent = result.message;
                                messageDiv.classList.remove('hidden');
                            }
                        }
                    } catch (error) {
                        console.error('Error adding cost:', error);
                        if (messageDiv) {
                            messageDiv.className = 'error-message';
                            messageDiv.textContent = 'An error occurred. Please try again.';
                            messageDiv.classList.remove('hidden');
                        }
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Add Cost';
                    }
                });
            }

            // Costs table filters
            const costSearch = document.getElementById('cost-search');
            const costDateFilter = document.getElementById('cost-date-filter');
            const costAmountFilter = document.getElementById('cost-amount-filter');
            const costSort = document.getElementById('cost-sort');

            if (costSearch) {
                costSearch.addEventListener('input', () => {
                    loadCostsTable();
                });
            }

            if (costDateFilter) {
                costDateFilter.addEventListener('change', () => {
                    loadCostsTable();
                });
            }

            if (costAmountFilter) {
                costAmountFilter.addEventListener('input', () => {
                    loadCostsTable();
                });
            }

            if (costSort) {
                costSort.addEventListener('change', () => {
                    loadCostsTable();
                });
            }
        });

    </script>
    
    <!-- Service Worker Registration for PWA with Auto-Updates -->
    <script>
        if ('serviceWorker' in navigator) {
            let updateCheckInterval = null;
            let isReloading = false;
            let userActivityTimeout = null;
            let lastUserActivity = Date.now();

            // Track user activity to avoid interrupting active users
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            activityEvents.forEach(event => {
                document.addEventListener(event, () => {
                    lastUserActivity = Date.now();
                }, { passive: true });
            });

            // Check if user is idle (no activity for 30 seconds)
            const isUserIdle = () => {
                return Date.now() - lastUserActivity > 30000; // 30 seconds
            };

            // Seamless reload function - only reload when safe
            const seamlessReload = () => {
                if (isReloading) return;
                
                // Only reload if:
                // 1. Tab is hidden (user switched tabs/apps), OR
                // 2. User is idle (no activity for 30 seconds)
                if (document.hidden || isUserIdle()) {
                    isReloading = true;
                    console.log(' Service Worker updated. Reloading seamlessly...');
                    window.location.reload();
                } else {
                    // User is active, wait for next check
                    console.log(' Update available but user is active. Will reload when idle or tab hidden.');
                }
            };

            // IMMEDIATE VERSION CHECK - Runs before anything else
            (async function immediateVersionCheck() {
                try {
                    // Check service worker version on server immediately
                    const swResponse = await fetch('/service-worker.js?t=' + Date.now(), {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (swResponse.ok) {
                        const swText = await swResponse.text();
                        const versionMatch = swText.match(/const CACHE_VERSION = ['"]([^'"]+)['"]/);
                        
                        if (versionMatch) {
                            const serverVersion = versionMatch[1];
                            const storedVersion = localStorage.getItem('sw_version');
                            
                            // If version changed, immediately clear everything
                            if (storedVersion && storedVersion !== serverVersion) {
                                console.log(' Version mismatch detected! Server:', serverVersion, 'Local:', storedVersion);
                                console.log(' Clearing all caches and service workers...');
                                
                                // Unregister all service workers
                                const regs = await navigator.serviceWorker.getRegistrations();
                                for (const reg of regs) {
                                    await reg.unregister();
                                }
                                
                                // Delete all caches
                                const cacheNames = await caches.keys();
                                for (const name of cacheNames) {
                                    await caches.delete(name);
                                }
                                
                                // Update stored version
                                localStorage.setItem('sw_version', serverVersion);
                                
                                // Force reload
                                console.log(' Reloading to get fresh version...');
                                window.location.reload(true);
                                return; // Stop execution
                            }
                            
                            // Store version if not stored
                            if (!storedVersion) {
                                localStorage.setItem('sw_version', serverVersion);
                            }
                        }
                    }
                } catch (error) {
                    console.warn(' Immediate version check failed:', error);
                }
            })();

            window.addEventListener('load', () => {
                // Register service worker (query params don't work for SW registration, but we'll force update)
                navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
                    .then((registration) => {
                        console.log(' Service Worker registered successfully:', registration.scope);
                        
                        // Force immediate update check with cache bypass
                        registration.update();
                        
                        // Unregister and re-register if service worker is too old (nuclear option)
                        checkAndForceUpdate(registration);
                        
                        // Check for updates every 1 minute
                        updateCheckInterval = setInterval(() => {
                            // Force update with cache bypass
                            registration.update().catch(err => {
                                console.warn(' Update check failed:', err);
                            });
                            
                            // Also check if we need to force unregister
                            checkAndForceUpdate(registration);
                        }, 60 * 1000); // Every 1 minute

                        // Listen for new service worker installation
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            if (!newWorker) return;

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        // New service worker is ready
                                        console.log(' New service worker installed. Activating...');
                                        // The new worker will call skipWaiting() automatically
                                        // We'll reload when controller changes
                                    } else {
                                        // First time installation
                                        console.log(' Service Worker installed for the first time');
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.error(' Service Worker registration failed:', error);
                    });
                
                // Listen for service worker controller change (new SW activated)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    // Small delay to ensure new SW is fully active
                    setTimeout(() => {
                        seamlessReload();
                    }, 100);
                });

                // Also check when tab becomes visible (user returns to app)
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && navigator.serviceWorker.controller) {
                        // Tab is visible, check for updates
                        navigator.serviceWorker.getRegistration().then(reg => {
                            if (reg) reg.update();
                        });
                    }
                });
            });

            // Function to check service worker version and force update if needed
            async function checkAndForceUpdate(registration) {
                try {
                    // Fetch service worker file with cache bypass to check version
                    // Use timestamp to bypass cache
                    const swResponse = await fetch('/service-worker.js?t=' + Date.now(), {
                        cache: 'no-store',
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (swResponse.ok) {
                        const swText = await swResponse.text();
                        // Extract cache version from service worker file
                        const versionMatch = swText.match(/const CACHE_VERSION = ['"]([^'"]+)['"]/);
                        
                        if (versionMatch) {
                            const serverVersion = versionMatch[1];
                            const storedVersion = localStorage.getItem('sw_version');
                            
                            // If version changed or not stored, force update
                            if (storedVersion !== serverVersion) {
                                console.log(' Service Worker version changed:', storedVersion, '', serverVersion);
                                localStorage.setItem('sw_version', serverVersion);
                                
                                // Force unregister and re-register
                                await forceServiceWorkerUpdate();
                            }
                        }
                    }
                } catch (error) {
                    console.warn(' Version check failed:', error);
                }
            }
            
            // Nuclear option: Force unregister and re-register service worker
            async function forceServiceWorkerUpdate() {
                try {
                    console.log(' Forcing service worker update...');
                    
                    // Get all registrations
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    
                    // Unregister all
                    for (let registration of registrations) {
                        await registration.unregister();
                        console.log(' Unregistered old service worker');
                    }
                    
                    // Clear all caches
                    const cacheNames = await caches.keys();
                    for (let cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        console.log(' Deleted cache:', cacheName);
                    }
                    
                    // Wait a bit then re-register
                    setTimeout(() => {
                        navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
                            .then((registration) => {
                                console.log(' Service Worker re-registered after force update');
                                // Force immediate update
                                registration.update();
                                // Reload after a short delay to ensure new SW is active
                                setTimeout(() => {
                                    window.location.reload(true); // Force reload from server
                                }, 1000);
                            })
                            .catch(err => {
                                console.error(' Re-registration failed:', err);
                            });
                    }, 500);
                } catch (error) {
                    console.error(' Force update failed:', error);
                }
            }
            
            // Add manual update button (for testing/debugging)
            // Users can call this from console: window.forcePWAUpdate()
            window.forcePWAUpdate = forceServiceWorkerUpdate;
            
            // Clean up interval on page unload
            window.addEventListener('beforeunload', () => {
                if (updateCheckInterval) {
                    clearInterval(updateCheckInterval);
                }
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        const pwaInstallPrompt = document.getElementById('pwa-install-prompt');
        const pwaInstallBtn = document.getElementById('pwa-install-btn');
        const pwaDismissBtn = document.getElementById('pwa-dismiss-btn');

        // Check if user has already dismissed the prompt
        const pwaPromptDismissed = localStorage.getItem('pwa-prompt-dismissed');
        const pwaPromptDismissedTime = localStorage.getItem('pwa-prompt-dismissed-time');
        const DISMISS_DURATION = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds

        // Check if prompt was dismissed recently (within 7 days)
        function shouldShowPrompt() {
            if (!pwaPromptDismissed) return true;
            if (!pwaPromptDismissedTime) return true;
            
            const dismissedTime = parseInt(pwaPromptDismissedTime, 10);
            const now = Date.now();
            const timeSinceDismissal = now - dismissedTime;
            
            // Show again if more than 7 days have passed
            return timeSinceDismissal > DISMISS_DURATION;
        }

        // Check and show install prompt on login page
        function checkAndShowInstallPrompt() {
            if (!pwaInstallPrompt) return;
            
            // Check if app is already installed
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                hideInstallPrompt();
                return;
            }
            
            // Check if user dismissed it
            if (!shouldShowPrompt()) {
                hideInstallPrompt();
                return;
            }
            
            // Check if we're on login page
            const loginPage = document.getElementById('login-page');
            const dashboardPage = document.getElementById('dashboard-page');
            const adminDashboardPage = document.getElementById('admin-dashboard-page');
            
            const isLoginPageVisible = loginPage && !loginPage.classList.contains('hidden');
            const isDashboardVisible = dashboardPage && !dashboardPage.classList.contains('hidden');
            const isAdminDashboardVisible = adminDashboardPage && !adminDashboardPage.classList.contains('hidden');
            
            // Show on login page, hide on dashboard
            if (isLoginPageVisible && !isDashboardVisible && !isAdminDashboardVisible) {
                pwaInstallPrompt.classList.remove('hidden');
            } else {
                hideInstallPrompt();
            }
        }

        // Show install prompt immediately (for desktop popup)
        function showInstallPromptImmediately() {
            if (!pwaInstallPrompt) return;
            
            // Check if app is already installed
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                hideInstallPrompt();
                return;
            }
            
            // Check if user dismissed it
            if (!shouldShowPrompt()) {
                hideInstallPrompt();
                return;
            }
            
            // Check if we're on login page
            const loginPage = document.getElementById('login-page');
            const dashboardPage = document.getElementById('dashboard-page');
            const adminDashboardPage = document.getElementById('admin-dashboard-page');
            
            const isLoginPageVisible = loginPage && !loginPage.classList.contains('hidden');
            const isDashboardVisible = dashboardPage && !dashboardPage.classList.contains('hidden');
            const isAdminDashboardVisible = adminDashboardPage && !adminDashboardPage.classList.contains('hidden');
            
            // Show on login page
            if (isLoginPageVisible && !isDashboardVisible && !isAdminDashboardVisible) {
                // Check if desktop (show as popup) or mobile (show inline)
                const isDesktop = window.innerWidth >= 641;
                if (isDesktop) {
                    // Desktop: show as popup immediately
                    pwaInstallPrompt.classList.remove('hidden');
                } else {
                    // Mobile: use existing inline behavior
                    pwaInstallPrompt.classList.remove('hidden');
                }
            } else {
                hideInstallPrompt();
            }
        }

        // Hide install prompt
        function hideInstallPrompt() {
            if (pwaInstallPrompt) {
                pwaInstallPrompt.classList.add('hidden');
            }
        }

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log(' beforeinstallprompt event fired');
            // Prevent the default browser install prompt
            e.preventDefault();
            // Store the event for later use
            deferredPrompt = e;
            
            // Show immediately (no delay)
            showInstallPromptImmediately();
        });
        
        // Check on page load immediately
        function initializeInstallPrompt() {
            checkAndShowInstallPrompt();
        }
        
        // Initialize immediately when DOM is ready (no delay)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', showInstallPromptImmediately);
        } else {
            showInstallPromptImmediately();
        }
        
        // Also check on page load (immediately)
        window.addEventListener('load', showInstallPromptImmediately);

        // Handle install button click
        if (pwaInstallBtn) {
            pwaInstallBtn.addEventListener('click', async () => {
                if (!deferredPrompt) {
                    // Fallback: Show instructions for manual installation
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                    const isAndroid = /Android/.test(navigator.userAgent);
                    
                    let instructions = '';
                    if (isIOS) {
                        instructions = 'To install:\n1. Tap the Share button (square with arrow)\n2. Select "Add to Home Screen"\n3. Tap "Add"';
                    } else if (isAndroid) {
                        instructions = 'To install:\n1. Tap the menu (3 dots)\n2. Select "Install app" or "Add to Home screen"';
                    } else {
                        instructions = 'To install:\n1. Look for the install icon in your browser\'s address bar\n2. Or use your browser\'s menu to install this app';
                    }
                    
                    alert(instructions);
                    hideInstallPrompt();
                    return;
                }

                try {
                    // Show the browser's install prompt
                    deferredPrompt.prompt();
                    
                    // Wait for user response
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    console.log(` User response to install prompt: ${outcome}`);
                    
                    // Clear the deferred prompt
                    deferredPrompt = null;
                    
                    // Hide our prompt
                    hideInstallPrompt();
                    
                    // Mark as installed or dismissed
                    if (outcome === 'accepted') {
                        localStorage.setItem('pwa-installed', 'true');
                        console.log(' PWA installation accepted');
                    }
                } catch (error) {
                    console.error(' Error showing install prompt:', error);
                    hideInstallPrompt();
                }
            });
        }

        // Handle dismiss button click
        if (pwaDismissBtn) {
            pwaDismissBtn.addEventListener('click', () => {
                hideInstallPrompt();
                // Store dismissal with timestamp
                localStorage.setItem('pwa-prompt-dismissed', 'true');
                localStorage.setItem('pwa-prompt-dismissed-time', Date.now().toString());
            });
        }

        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log(' PWA was installed');
            hideInstallPrompt();
            localStorage.setItem('pwa-installed', 'true');
            deferredPrompt = null;
        });

        // Check on page load if app is already installed
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                            window.navigator.standalone === true ||
                            (window.matchMedia('(display-mode: fullscreen)').matches) ||
                            (window.matchMedia('(display-mode: minimal-ui)').matches);
        
        if (isStandalone) {
            // App is running in standalone mode (installed)
            console.log(' App is running in standalone mode');
            hideInstallPrompt();
            localStorage.setItem('pwa-installed', 'true');
        } else {
            // Not in standalone mode, show prompt immediately
            showInstallPromptImmediately();
        }

        // Hide prompt when user logs in (switches to dashboard)
        const originalLoginUser = window.loginUser;
        if (typeof originalLoginUser === 'function') {
            // If loginUser is already defined, we'll hook into it
            // Otherwise, we'll add a listener for dashboard visibility
        }

        // Monitor for dashboard visibility changes to show/hide prompt
        // Initialize In-House Order Form
        async function initializeInhouseOrderForm() {
            const container = document.getElementById('inhouse-order-form-container');
            if (!container) return;

            // Load Leaflet.js if not already loaded
            if (typeof L === 'undefined') {
                const leafletCSS = document.createElement('link');
                leafletCSS.rel = 'stylesheet';
                leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                leafletCSS.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
                leafletCSS.crossOrigin = '';
                document.head.appendChild(leafletCSS);

                const leafletJS = document.createElement('script');
                leafletJS.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                leafletJS.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
                leafletJS.crossOrigin = '';
                await new Promise((resolve) => {
                    leafletJS.onload = resolve;
                    document.head.appendChild(leafletJS);
                });
            }

            const supabase = getSupabaseClient();
            if (!supabase) {
                console.error('Supabase client not available');
                return;
            }

            // State variables
            let inhouseProducts = [];
            let inhouseSelectedProduct = null;
            let inhouseSelectedColor = null;
            let inhouseMap = null;
            let inhouseMarker = null;
            let inhouseSelectedLocation = { lat: null, lng: null, displayName: null };
            let inhouseProductsChannel = null;
            
            // Cart for multiple items
            let inhouseOrderCart = [];
            let inhouseCurrentProduct = null;
            let inhouseCurrentColor = null;

            // Get form elements
            const form = document.getElementById('inhouse-dash-orderForm');
            const productSearch = document.getElementById('inhouse-dash-productSearch');
            const searchResults = document.getElementById('inhouse-dash-searchResults');
            const selectedProductDiv = document.getElementById('inhouse-dash-selectedProduct');
            const colorOptionsDiv = document.getElementById('inhouse-dash-colorOptions');
            const colorGrid = document.getElementById('inhouse-dash-colorGrid');
            const selectedColorDisplay = document.getElementById('inhouse-dash-selectedColorDisplay');
            const clearProductBtn = document.getElementById('inhouse-dash-clearProductBtn');
            const addToCartBtn = document.getElementById('inhouse-dash-addToCartBtn');
            const orderCart = document.getElementById('inhouse-dash-orderCart');
            const cartItems = document.getElementById('inhouse-dash-cartItems');
            const cartCount = document.getElementById('inhouse-dash-cartCount');
            const cartTotal = document.getElementById('inhouse-dash-cartTotal');
            const totalAmount = document.getElementById('inhouse-dash-totalAmount');
            const bodyMeasurements = document.getElementById('inhouse-dash-bodyMeasurements');
            const customSizeInput = document.getElementById('inhouse-dash-customSizeInput');
            const deliveryOption = document.getElementById('inhouse-dash-deliveryOption');
            const deliveryLocationInput = document.getElementById('inhouse-dash-deliveryLocationInput');
            const storeLocationMessage = document.getElementById('inhouse-dash-storeLocationMessage');
            const mapContainer = document.getElementById('inhouse-dash-mapContainer');
            const mapElement = document.getElementById('inhouse-dash-map');

            // Load products
            async function loadInhouseProducts() {
                try {
                    const { data, error } = await supabase
                        .from('products')
                        .select('*')
                        .order('name', { ascending: true });

                    if (error) throw error;

                    inhouseProducts = (data || []).map(p => ({
                        id: String(p.id),
                        name: p.name || 'Unknown',
                        price: p.price || 0,
                        image: p.image_url || 'https://via.placeholder.com/400',
                        colors: (() => {
                            if (Array.isArray(p.colors)) return p.colors;
                            if (typeof p.colors === 'string') {
                                try { return JSON.parse(p.colors); } catch { return p.colors.split(',').map(c => c.trim()); }
                            }
                            return ['Black', 'White', 'Red', 'Blue'];
                        })()
                    }));
                } catch (error) {
                    console.error('Error loading products:', error);
                    inhouseProducts = [];
                }
            }

            // Setup realtime
            function setupInhouseProductsRealtime() {
                if (inhouseProductsChannel) supabase.removeChannel(inhouseProductsChannel);
                inhouseProductsChannel = supabase
                    .channel('products-changes-inhouse-dash')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, () => {
                        loadInhouseProducts();
                    })
                    .subscribe();
            }

            // Product search
            const searchBackdrop = document.getElementById('inhouse-dash-searchBackdrop');
            productSearch.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                if (!query) {
                    searchResults.classList.remove('active');
                    // Reset positioning styles
                    searchResults.style.position = '';
                    searchResults.style.top = '';
                    searchResults.style.left = '';
                    searchResults.style.right = '';
                    searchResults.style.width = '';
                    searchResults.classList.remove('positioned');
                    if (searchBackdrop) {
                        searchBackdrop.classList.remove('active');
                    }
                    return;
                }
                const filtered = inhouseProducts.filter(p => p.name.toLowerCase().includes(query));
                if (filtered.length === 0) {
                    searchResults.innerHTML = '<div class="no-results" style="padding: 16px; text-align: center; color: #718096;">No items found</div>';
                    searchResults.classList.add('active');
                    
                    // On mobile, position the popup relative to the search input using fixed positioning
                    if (window.innerWidth <= 640) {
                        const searchInput = productSearch;
                        const inputRect = searchInput.getBoundingClientRect();
                        searchResults.style.position = 'fixed';
                        searchResults.style.top = (inputRect.bottom + 6) + 'px';
                        searchResults.style.left = '20px';
                        searchResults.style.right = '20px';
                        searchResults.style.width = 'calc(100vw - 40px)';
                        searchResults.classList.add('positioned');
                    } else {
                        // On desktop, use absolute positioning
                        searchResults.style.position = '';
                        searchResults.style.top = '';
                        searchResults.style.left = '';
                        searchResults.style.right = '';
                        searchResults.style.width = '';
                        searchResults.classList.remove('positioned');
                    }
                    
                    // Show backdrop on mobile
                    if (searchBackdrop && window.innerWidth <= 640) {
                        searchBackdrop.classList.add('active');
                    } else if (searchBackdrop) {
                        searchBackdrop.classList.remove('active');
                    }
                    return;
                }
                searchResults.innerHTML = filtered.map(product => {
                    // Ensure image URL is valid and add loading/error handling - matching customer form exactly
                    const imageUrl = product.image || 'https://via.placeholder.com/400';
                    const placeholderUrl = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\'%3E%3Crect fill=\'%23f0f0f0\' width=\'60\' height=\'60\'/%3E%3Ctext fill=\'%23999\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' font-size=\'10\'%3ENo Image%3C/text%3E%3C/svg%3E';
                    
                    return `
                    <div class="inhouse-search-result-item" data-id="${product.id}">
                        <img src="${imageUrl}" 
                             alt="${product.name}" 
                             class="inhouse-result-image" 
                             loading="lazy"
                             decoding="async"
                             onerror="this.onerror=null; this.src='${placeholderUrl}';"
                             onload="this.style.opacity='1';"
                             style="opacity: 0; transition: opacity 0.3s ease;">
                        <div class="inhouse-result-info">
                            <div class="inhouse-result-name">${product.name}</div>
                            <div class="inhouse-result-price">KES ${product.price.toLocaleString()}</div>
                        </div>
                    </div>
                `;
                }).join('');
                
                // Show the popup
                searchResults.classList.add('active');
                
                // On mobile, position the popup relative to the search input using fixed positioning
                if (window.innerWidth <= 640) {
                    const searchInput = productSearch;
                    const inputRect = searchInput.getBoundingClientRect();
                    searchResults.style.position = 'fixed';
                    searchResults.style.top = (inputRect.bottom + 6) + 'px';
                    searchResults.style.left = '20px';
                    searchResults.style.right = '20px';
                    searchResults.style.width = 'calc(100vw - 40px)';
                    searchResults.classList.add('positioned');
                } else {
                    // On desktop, use absolute positioning (reset any fixed positioning)
                    searchResults.style.position = '';
                    searchResults.style.top = '';
                    searchResults.style.left = '';
                    searchResults.style.right = '';
                    searchResults.style.width = '';
                    searchResults.classList.remove('positioned');
                }
                
                // Show backdrop on mobile (matching customer form behavior)
                if (searchBackdrop && window.innerWidth <= 640) {
                    searchBackdrop.classList.add('active');
                } else if (searchBackdrop) {
                    // Ensure backdrop is hidden on desktop
                    searchBackdrop.classList.remove('active');
                }
                
                // Debug log
                console.log(' Search results shown:', {
                    resultsCount: filtered.length,
                    hasActiveClass: searchResults.classList.contains('active'),
                    display: window.getComputedStyle(searchResults).display,
                    visibility: window.getComputedStyle(searchResults).visibility,
                    zIndex: window.getComputedStyle(searchResults).zIndex,
                    position: window.getComputedStyle(searchResults).position,
                    top: window.getComputedStyle(searchResults).top
                });
            });

            // Product selection
            searchResults.addEventListener('click', (e) => {
                const item = e.target.closest('.inhouse-search-result-item');
                if (item) {
                    const productId = String(item.dataset.id);
                    const product = inhouseProducts.find(p => String(p.id) === productId);
                    if (product) {
                        inhouseCurrentProduct = product;
                        inhouseCurrentColor = null;
                        productSearch.value = product.name;
                        searchResults.classList.remove('active');
                        // Reset positioning styles
                        searchResults.style.position = '';
                        searchResults.style.top = '';
                        searchResults.style.left = '';
                        searchResults.style.right = '';
                        searchResults.style.width = '';
                        searchResults.classList.remove('positioned');
                        if (searchBackdrop) {
                            searchBackdrop.classList.remove('active');
                        }
                        document.getElementById('inhouse-dash-selectedImage').src = product.image;
                        document.getElementById('inhouse-dash-selectedName').textContent = product.name;
                        document.getElementById('inhouse-dash-selectedPrice').textContent = `KES ${product.price.toLocaleString()}`;
                        selectedProductDiv.classList.add('active');
                        displayInhouseColors();
                        if (addToCartBtn) {
                            addToCartBtn.style.display = 'none';
                        }
                    }
                }
            });

            // Helper function to check if click/touch is outside search area
            const isOutsideSearchArea = function(target) {
                const isSearchInput = productSearch && (productSearch === target || productSearch.contains(target));
                const isSearchResults = searchResults && (searchResults === target || searchResults.contains(target));
                const isSearchResultItem = target && target.closest && target.closest('.inhouse-search-result-item');
                const isSearchContainer = target && target.closest && target.closest('.inhouse-search-container');
                
                return !isSearchInput && !isSearchResults && !isSearchResultItem && !isSearchContainer;
            };

            // Close search results when clicking outside (desktop)
            document.addEventListener('click', (e) => {
                const backdrop = document.getElementById('inhouse-dash-searchBackdrop');
                if (isOutsideSearchArea(e.target) && !e.target.closest('.inhouse-search-backdrop')) {
                    searchResults.classList.remove('active');
                    // Reset positioning styles
                    searchResults.style.position = '';
                    searchResults.style.top = '';
                    searchResults.style.left = '';
                    searchResults.style.right = '';
                    searchResults.style.width = '';
                    searchResults.classList.remove('positioned');
                    if (backdrop) {
                        backdrop.classList.remove('active');
                    }
                }
            });
            
            // Close search results when touching outside (mobile)
            document.addEventListener('touchend', (e) => {
                const backdrop = document.getElementById('inhouse-dash-searchBackdrop');
                if (isOutsideSearchArea(e.target) && !e.target.closest('.inhouse-search-backdrop')) {
                    searchResults.classList.remove('active');
                    // Reset positioning styles
                    searchResults.style.position = '';
                    searchResults.style.top = '';
                    searchResults.style.left = '';
                    searchResults.style.right = '';
                    searchResults.style.width = '';
                    searchResults.classList.remove('positioned');
                    if (backdrop) {
                        backdrop.classList.remove('active');
                    }
                }
            }, { passive: true });
            
            // Close search results when clicking backdrop
            if (searchBackdrop) {
                searchBackdrop.addEventListener('click', () => {
                    searchResults.classList.remove('active');
                    // Reset positioning styles
                    searchResults.style.position = '';
                    searchResults.style.top = '';
                    searchResults.style.left = '';
                    searchResults.style.right = '';
                    searchResults.style.width = '';
                    searchResults.classList.remove('positioned');
                    searchBackdrop.classList.remove('active');
                });
                searchBackdrop.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    searchResults.classList.remove('active');
                    // Reset positioning styles
                    searchResults.style.position = '';
                    searchResults.style.top = '';
                    searchResults.style.left = '';
                    searchResults.style.right = '';
                    searchResults.style.width = '';
                    searchResults.classList.remove('positioned');
                    searchBackdrop.classList.remove('active');
                }, { passive: false });
            }

            // Clear product
            if (clearProductBtn) {
                clearProductBtn.addEventListener('click', () => {
                    inhouseCurrentProduct = null;
                    inhouseCurrentColor = null;
                    productSearch.value = '';
                    selectedProductDiv.classList.remove('active');
                    colorOptionsDiv.style.display = 'none';
                    selectedColorDisplay.textContent = '';
                    if (addToCartBtn) {
                        addToCartBtn.style.display = 'none';
                    }
                    searchResults.classList.remove('active');
                    // Reset positioning styles
                    searchResults.style.position = '';
                    searchResults.style.top = '';
                    searchResults.style.left = '';
                    searchResults.style.right = '';
                    searchResults.style.width = '';
                    searchResults.classList.remove('positioned');
                    if (searchBackdrop) {
                        searchBackdrop.classList.remove('active');
                    }
                });
            }

            // Color selection
            const colorMap = {
                'Red': '#DC2626', 'Bright orange': '#FF8C00', 'Burnt orange': '#CC5500',
                'Emerald green': '#50C878', 'Lilac': '#C8A2C8', 'Black': '#000000',
                'White': '#FFFFFF', 'Fuschia': '#FF1493', 'Sage green': '#87AE73',
                'Maroon': '#800000', 'Burgundy': '#800020', 'Hot pink': '#FF69B4',
                'Baby pink': '#FFB6C1', 'Chocolate brown': '#7B3F00', 'Beige': '#F5F5DC',
                'Mustard yellow': '#FFDB58', 'Royal blue': '#4169E1', 'Navy blue': '#000080',
                'Blackcurrant': '#2E1837', 'Royal purple': '#7851A9', 'Teal Blue': '#008080',
                'Jungle green': '#29AB87', 'Olive green': '#6B8E23', 'Lime green': '#32CD32',
                'Off white': '#FAF9F6', 'Cream': '#FFFDD0', 'Light brown': '#CD853F',
                'Peach': '#FFCBA4', 'Champagne': '#F7E7CE', 'Rose pink': '#FFC0CB'
            };

            function displayInhouseColors() {
                if (!inhouseCurrentProduct) return;
                colorGrid.innerHTML = Object.keys(colorMap).map(colorName => {
                    const hex = colorMap[colorName];
                    const lightColors = ['White', 'Off white', 'Cream', 'Champagne'];
                    const borderStyle = lightColors.includes(colorName) ? 'border: 2px solid rgba(0,0,0,0.2);' : '';
                    return `<div class="inhouse-color-option" data-color="${colorName}" style="background-color: ${hex}; ${borderStyle}" title="${colorName}"></div>`;
                }).join('');
                colorOptionsDiv.style.display = 'block';
                colorGrid.querySelectorAll('.inhouse-color-option').forEach(opt => {
                    opt.addEventListener('click', () => {
                        colorGrid.querySelectorAll('.inhouse-color-option').forEach(o => o.classList.remove('selected'));
                        opt.classList.add('selected');
                        inhouseCurrentColor = opt.dataset.color;
                        selectedColorDisplay.textContent = `Selected: ${inhouseCurrentColor}`;
                        if (addToCartBtn) {
                            addToCartBtn.style.display = 'block';
                        }
                    });
                });
            }

            // Add to cart functionality
            function addItemToCart() {
                if (!inhouseCurrentProduct || !inhouseCurrentColor) {
                    alert('Please select a product and color');
                    return;
                }

                const cartItem = {
                    id: Date.now() + Math.random(), // Unique ID for cart item
                    product: inhouseCurrentProduct,
                    color: inhouseCurrentColor,
                    measurements: null // Will be set on submit
                };

                inhouseOrderCart.push(cartItem);
                updateCartDisplay();
                
                // Reset current selection
                inhouseCurrentProduct = null;
                inhouseCurrentColor = null;
                productSearch.value = '';
                selectedProductDiv.classList.remove('active');
                colorOptionsDiv.style.display = 'none';
                selectedColorDisplay.textContent = '';
                if (addToCartBtn) {
                    addToCartBtn.style.display = 'none';
                }
            }

            function removeItemFromCart(itemId) {
                inhouseOrderCart = inhouseOrderCart.filter(item => item.id !== itemId);
                updateCartDisplay();
            }

            function updateCartDisplay() {
                if (!cartItems || !cartCount || !cartTotal || !totalAmount) return;

                if (inhouseOrderCart.length === 0) {
                    cartItems.innerHTML = '<div style="text-align: center; color: #718096; padding: 20px;">No items added yet. Select a product and color, then click "Add to Order".</div>';
                    orderCart.style.display = 'none';
                    cartTotal.style.display = 'none';
                    return;
                }

                orderCart.style.display = 'block';
                cartCount.textContent = `(${inhouseOrderCart.length} ${inhouseOrderCart.length === 1 ? 'item' : 'items'})`;
                
                let total = 0;
                cartItems.innerHTML = inhouseOrderCart.map(item => {
                    total += item.product.price;
                    return `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border: 1px solid rgba(27, 77, 62, 0.1);">
                            <img src="${item.product.image}" alt="${item.product.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; flex-shrink: 0;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">${item.product.name}</div>
                                <div style="font-size: 13px; color: #718096;">Color: ${item.color}</div>
                                <div style="font-size: 14px; font-weight: 600; color: #1B4D3E; margin-top: 4px;">KES ${item.product.price.toLocaleString()}</div>
                            </div>
                            <button type="button" onclick="removeInhouseCartItem(${item.id})" style="background: rgba(239, 68, 68, 0.1); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; color: #ef4444; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" title="Remove item"></button>
                        </div>
                    `;
                }).join('');

                totalAmount.textContent = total.toLocaleString();
                cartTotal.style.display = 'block';
            }

            // Make remove function globally accessible
            window.removeInhouseCartItem = removeItemFromCart;

            // Add to cart button handler
            if (addToCartBtn) {
                addToCartBtn.addEventListener('click', addItemToCart);
            }

            // Body measurements
            bodyMeasurements.addEventListener('change', function() {
                customSizeInput.style.display = this.value === 'custom' ? 'block' : 'none';
            });

            // Delivery option
            deliveryOption.addEventListener('change', function() {
                if (this.value === 'uber' || this.value === 'pickup-mtaani' || this.value === 'courier') {
                    deliveryLocationInput.style.display = 'block';
                    storeLocationMessage.style.display = 'none';
                    if (typeof L !== 'undefined' && !inhouseMap) {
                        setTimeout(() => initializeInhouseMap(), 100);
                    }
                } else if (this.value === 'in-store-pickup') {
                    deliveryLocationInput.style.display = 'none';
                    storeLocationMessage.style.display = 'block';
                } else {
                    deliveryLocationInput.style.display = 'none';
                    storeLocationMessage.style.display = 'none';
                }
            });

            // Initialize map
            function initializeInhouseMap() {
                if (!mapElement || typeof L === 'undefined') return;
                try {
                    const kenyaBounds = L.latLngBounds([-4.7, 33.9], [5.5, 41.9]);
                    inhouseMap = L.map('inhouse-dash-map', {
                        zoomControl: true,
                        maxBounds: kenyaBounds,
                        maxBoundsViscosity: 1.0
                    }).setView([-1.2921, 36.8219], 6);

                    const mapboxToken = window.MAPBOX_ACCESS_TOKEN || '';
                    if (mapboxToken) {
                        L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/streets-v12/tiles/{z}/{x}/{y}?access_token=${mapboxToken}`, {
                            attribution: ' Mapbox  OpenStreetMap',
                            maxZoom: 22,
                            tileSize: 512,
                            zoomOffset: -1
                        }).addTo(inhouseMap);
                    } else {
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                            attribution: ' OpenStreetMap  CARTO',
                            maxZoom: 19
                        }).addTo(inhouseMap);
                    }

                    inhouseMap.on('click', (e) => {
                        const lat = e.latlng.lat;
                        const lng = e.latlng.lng;
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                            .then(r => r.json())
                            .then(data => {
                                const displayName = data.display_name || `${lat}, ${lng}`;
                                setInhouseLocation(lat, lng, displayName);
                            })
                            .catch(() => setInhouseLocation(lat, lng, `${lat}, ${lng}`));
                    });
                } catch (error) {
                    console.error('Error initializing map:', error);
                }
            }

            function setInhouseLocation(lat, lng, displayName) {
                if (inhouseMarker) inhouseMap.removeLayer(inhouseMarker);
                inhouseMarker = L.marker([lat, lng]).addTo(inhouseMap);
                inhouseMarker.bindPopup(displayName).openPopup();
                inhouseSelectedLocation = { lat, lng, displayName };
                document.getElementById('inhouse-dash-deliveryLatitude').value = lat;
                document.getElementById('inhouse-dash-deliveryLongitude').value = lng;
                document.getElementById('inhouse-dash-deliveryDisplayName').value = displayName;
                inhouseMap.setView([lat, lng], 15);
                
                // Show selected location info
                const selectedLocationInfo = document.getElementById('inhouse-dash-selectedLocationInfo');
                const selectedLocationText = document.getElementById('inhouse-dash-selectedLocationText');
                if (selectedLocationInfo && selectedLocationText) {
                    selectedLocationText.textContent = displayName;
                    selectedLocationInfo.style.display = 'block';
                }
            }
            
            // Location search functionality
            const locationSearch = document.getElementById('inhouse-dash-locationSearch');
            const clearLocationSearch = document.getElementById('inhouse-dash-clearLocationSearch');
            const locationSuggestions = document.getElementById('inhouse-dash-locationSuggestions');
            
            if (locationSearch) {
                locationSearch.addEventListener('input', function(e) {
                    const query = e.target.value.trim();
                    if (query.length > 0) {
                        if (clearLocationSearch) clearLocationSearch.style.display = 'flex';
                        searchInhouseLocation(query);
                    } else {
                        if (clearLocationSearch) clearLocationSearch.style.display = 'none';
                        if (locationSuggestions) locationSuggestions.style.display = 'none';
                    }
                });
                
                locationSearch.addEventListener('focus', function() {
                    if (this.value.length > 0 && clearLocationSearch) {
                        clearLocationSearch.style.display = 'flex';
                    }
                });
            }
            
            if (clearLocationSearch) {
                clearLocationSearch.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (locationSearch) {
                        locationSearch.value = '';
                        locationSearch.focus();
                    }
                    this.style.display = 'none';
                    if (locationSuggestions) locationSuggestions.style.display = 'none';
                    
                    // Clear selected location
                    if (inhouseMarker && inhouseMap) {
                        inhouseMap.removeLayer(inhouseMarker);
                        inhouseMarker = null;
                    }
                    inhouseSelectedLocation = { lat: null, lng: null, displayName: null };
                    document.getElementById('inhouse-dash-deliveryLatitude').value = '';
                    document.getElementById('inhouse-dash-deliveryLongitude').value = '';
                    document.getElementById('inhouse-dash-deliveryDisplayName').value = '';
                    const selectedLocationInfo = document.getElementById('inhouse-dash-selectedLocationInfo');
                    if (selectedLocationInfo) selectedLocationInfo.style.display = 'none';
                });
            }
            
            // Manual entry handlers
            const toggleManualEntry = document.getElementById('inhouse-dash-toggleManualEntry');
            const manualEntryFields = document.getElementById('inhouse-dash-manualEntryFields');
            const saveManualLocation = document.getElementById('inhouse-dash-saveManualLocation');
            const cancelManualEntry = document.getElementById('inhouse-dash-cancelManualEntry');
            
            if (toggleManualEntry) {
                toggleManualEntry.addEventListener('click', function() {
                    const isVisible = manualEntryFields.style.display !== 'none';
                    if (!isVisible) {
                        manualEntryFields.style.display = 'block';
                    }
                });
            }
            
            if (cancelManualEntry) {
                cancelManualEntry.addEventListener('click', function() {
                    manualEntryFields.style.display = 'none';
                    const manualAddress = document.getElementById('inhouse-dash-manualAddress');
                    if (manualAddress) manualAddress.value = '';
                });
            }
            
            if (saveManualLocation) {
                saveManualLocation.addEventListener('click', function() {
                    const manualAddress = document.getElementById('inhouse-dash-manualAddress');
                    if (!manualAddress) return;
                    
                    const address = manualAddress.value.trim();
                    if (!address) {
                        alert('Please enter an address or description');
                        return;
                    }
                    
                    // Try to geocode first
                    searchInhouseLocation(address);
                    
                    // Wait a bit for geocoding, then save manually if no coordinates found
                    setTimeout(() => {
                        if (!inhouseSelectedLocation.lat || !inhouseSelectedLocation.lng) {
                            // No coordinates found, save as manual entry
                            inhouseSelectedLocation = { lat: null, lng: null, displayName: address };
                            document.getElementById('inhouse-dash-deliveryDisplayName').value = address;
                            document.getElementById('inhouse-dash-deliveryLatitude').value = '';
                            document.getElementById('inhouse-dash-deliveryLongitude').value = '';
                            
                            // Show in search bar (primary location)
                            if (locationSearch) {
                                locationSearch.value = address;
                            }
                            if (clearLocationSearch) {
                                clearLocationSearch.style.display = 'flex';
                            }
                            
                            // Show selected location info
                            const selectedLocationInfo = document.getElementById('inhouse-dash-selectedLocationInfo');
                            const selectedLocationText = document.getElementById('inhouse-dash-selectedLocationText');
                            if (selectedLocationInfo && selectedLocationText) {
                                selectedLocationText.textContent = address;
                                selectedLocationInfo.style.display = 'block';
                            }
                        } else {
                            // Coordinates found, show in search bar
                            if (locationSearch) {
                                locationSearch.value = inhouseSelectedLocation.displayName.split(',')[0];
                            }
                            if (clearLocationSearch) {
                                clearLocationSearch.style.display = 'flex';
                            }
                        }
                        
                        // Hide manual entry fields
                        manualEntryFields.style.display = 'none';
                        manualAddress.value = '';
                    }, 2000);
                });
            }
            
            // Simple location search function
            function searchInhouseLocation(query) {
                if (!query || query.length < 2) return;
                
                const encodedQuery = encodeURIComponent(query + ' Kenya');
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedQuery}&countrycodes=ke&limit=8&addressdetails=1`)
                    .then(r => r.json())
                    .then(data => {
                        if (!locationSuggestions) return;
                        
                        if (data.length === 0) {
                            locationSuggestions.innerHTML = '<div style="padding: 12px; color: #718096; font-size: 13px;">No locations found. Try searching for a street name, landmark, or area.</div>';
                            locationSuggestions.style.display = 'block';
                            return;
                        }
                        
                        locationSuggestions.innerHTML = data.map(result => {
                            const displayName = result.display_name;
                            return `
                                <div class="location-suggestion" 
                                     data-lat="${result.lat}" 
                                     data-lng="${result.lon}" 
                                     data-name="${displayName.replace(/"/g, '&quot;')}"
                                     style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid rgba(0, 0, 0, 0.05); transition: background 0.2s;"
                                     onmouseover="this.style.background='rgba(246, 211, 101, 0.1)'"
                                     onmouseout="this.style.background='white'">
                                    <div style="font-size: 14px; font-weight: 600; color: #2d3748; margin-bottom: 4px;">${result.name || displayName.split(',')[0]}</div>
                                    <div style="font-size: 12px; color: #718096; line-height: 1.4;">${displayName}</div>
                                </div>
                            `;
                        }).join('');
                        
                        // Add click handlers
                        locationSuggestions.querySelectorAll('.location-suggestion').forEach(item => {
                            item.addEventListener('click', function() {
                                const lat = parseFloat(this.dataset.lat);
                                const lng = parseFloat(this.dataset.lng);
                                const name = this.dataset.name;
                                setInhouseLocation(lat, lng, name);
                                if (locationSearch) {
                                    locationSearch.value = name.split(',')[0];
                                }
                                if (clearLocationSearch) clearLocationSearch.style.display = 'flex';
                                locationSuggestions.style.display = 'none';
                            });
                        });
                        
                        locationSuggestions.style.display = 'block';
                    })
                    .catch(err => {
                        console.error('Location search error:', err);
                        if (locationSuggestions) {
                            locationSuggestions.innerHTML = '<div style="padding: 12px; color: #718096; font-size: 13px;">Unable to search locations. Please use manual entry or click on the map.</div>';
                            locationSuggestions.style.display = 'block';
                        }
                    });
            }
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('#inhouse-dash-locationSearch') && 
                    !e.target.closest('#inhouse-dash-locationSuggestions') && 
                    !e.target.closest('#inhouse-dash-clearLocationSearch')) {
                    if (locationSuggestions) locationSuggestions.style.display = 'none';
                }
            });

            // Form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (inhouseOrderCart.length === 0) {
                    alert('Please add at least one item to the order');
                    return;
                }

                const bodyMeasurementsValue = bodyMeasurements.value;
                if (!bodyMeasurementsValue) {
                    alert('Please select body measurements');
                    return;
                }

                let measurements = {};
                if (bodyMeasurementsValue === 'custom') {
                    const height = document.getElementById('inhouse-dash-customHeight').value;
                    const bust = document.getElementById('inhouse-dash-customBust').value;
                    const waist = document.getElementById('inhouse-dash-customWaist').value;
                    const hips = document.getElementById('inhouse-dash-customHips').value;
                    if (!height || !bust || !waist || !hips) {
                        alert('Please fill all custom measurement fields');
                        return;
                    }
                    measurements = { height, bust, high_waist: waist, hips };
                } else {
                    const sizeChart = {
                        'SS': { height: 'N/A', bust: '32', high_waist: '25', hips: '36' },
                        'S': { height: 'N/A', bust: '34', high_waist: '27', hips: '39' },
                        'SM': { height: 'N/A', bust: '36', high_waist: '30', hips: '41' },
                        'M': { height: 'N/A', bust: '38', high_waist: '32', hips: '43' },
                        'SL': { height: 'N/A', bust: '40', high_waist: '34', hips: '45' },
                        'L': { height: 'N/A', bust: '44', high_waist: '36', hips: '48' }
                    };
                    measurements = sizeChart[bodyMeasurementsValue] || {};
                }

                const deliveryOptionValue = deliveryOption.value;
                if ((deliveryOptionValue === 'uber' || deliveryOptionValue === 'pickup-mtaani' || deliveryOptionValue === 'courier')) {
                    const deliveryDisplayName = document.getElementById('inhouse-dash-deliveryDisplayName').value;
                    const deliveryLatitude = document.getElementById('inhouse-dash-deliveryLatitude').value;
                    const deliveryLongitude = document.getElementById('inhouse-dash-deliveryLongitude').value;
                    
                    // Accept either coordinates OR manual entry (displayName)
                    if (!deliveryDisplayName && (!deliveryLatitude || !deliveryLongitude)) {
                        alert('Please select a delivery location on the map or enter a location manually');
                        return;
                    }
                }

                const mpesaCode = document.getElementById('inhouse-dash-mpesaCode').value.trim();
                if (!mpesaCode || !/^[A-Z0-9]{8,20}$/i.test(mpesaCode)) {
                    alert('Please enter a valid M-Pesa transaction code (8-20 alphanumeric characters)');
                    return;
                }

                const customerName = document.getElementById('inhouse-dash-name').value.trim();
                let countryCode = document.getElementById('inhouse-dash-countryCode').value.replace(/^\+/, '');
                let phoneNumber = document.getElementById('inhouse-dash-phoneNumber').value;
                if (phoneNumber.startsWith('0')) phoneNumber = phoneNumber.substring(1);
                const customerPhone = '+' + countryCode + phoneNumber;
                const comments = document.getElementById('inhouse-dash-comments').value.trim();

                const submitBtn = form.querySelector('.inhouse-submit-btn');
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating Order...';

                // Verify authentication before proceeding using custom authService
                const isLoggedIn = await authService.isLoggedIn();
                const currentUser = authService.getCurrentUser();
                
                if (!isLoggedIn || !currentUser) {
                    console.error(' Authentication error: User not logged in');
                    alert(' You are not authenticated. Please refresh the page and log in again.');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
                
                console.log(' User authenticated:', currentUser.email || currentUser.id);

                try {
                    // Find or create customer
                    let customerId;
                    // Use maybeSingle() to avoid 406 errors when customer doesn't exist
                    const { data: existingCustomer, error: findError } = await supabase
                        .from('customers')
                        .select('id')
                        .eq('phone', customerPhone)
                        .maybeSingle();

                    if (findError) {
                        console.error('Error finding customer:', findError);
                        // Continue to create new customer if lookup fails
                    }

                    if (existingCustomer) {
                        customerId = existingCustomer.id;
                        await supabase.from('customers').update({ name: customerName }).eq('id', customerId);
                    } else {
                        const { data: newCustomer, error: customerError } = await supabase
                            .from('customers')
                            .insert({ name: customerName, phone: customerPhone })
                            .select()
                            .single();
                        if (customerError) throw new Error(`Failed to create customer: ${customerError.message}`);
                        customerId = newCustomer.id;
                    }

                    // Calculate total price from all cart items
                    const totalPrice = inhouseOrderCart.reduce((sum, item) => sum + item.product.price, 0);
                    
                    // Prepare measurements text for comments
                    let finalComments = comments || '';
                    if (Object.keys(measurements).length > 0) {
                        const measurementsText = `Measurements: Height=${measurements.height || 'N/A'}, Bust=${measurements.bust || 'N/A'}, High Waist=${measurements.high_waist || 'N/A'}, Hips=${measurements.hips || 'N/A'}`;
                        finalComments = finalComments ? `${finalComments}\n${measurementsText}` : measurementsText;
                    }

                    // Prepare items array for JSONB storage
                    // Store all cart items with product details in the orders table
                    const itemsArray = inhouseOrderCart.map(item => ({
                        product_id: item.product.id,
                        product_name: item.product.name,
                        product_image: item.product.image_url || item.product.image || 'https://via.placeholder.com/400',
                        color: item.color,
                        price: item.product.price,
                        measurements: measurements || {}
                    }));

                    console.log(` Creating order with ${itemsArray.length} items stored as JSONB:`, itemsArray.map(i => ({ product_name: i.product_name, color: i.color, price: i.price })));

                    // Create order with items stored as JSONB (avoids RLS issues with separate table)
                    const orderData = {
                        customer_id: customerId,
                        customer_phone: customerPhone,
                        product_id: inhouseOrderCart[0].product.id, // First product for backward compatibility
                        status: 'pending',
                        color: inhouseOrderCart[0].color, // First color for backward compatibility
                        price: totalPrice, // Total price of all items
                        items: itemsArray, // Store all items as JSONB array
                        delivery_option: deliveryOptionValue,
                        delivery_location: inhouseSelectedLocation.displayName || null,
                        delivery_latitude: inhouseSelectedLocation.lat ? parseFloat(inhouseSelectedLocation.lat) : null,
                        delivery_longitude: inhouseSelectedLocation.lng ? parseFloat(inhouseSelectedLocation.lng) : null,
                        delivery_display_name: inhouseSelectedLocation.displayName || null,
                        payment_option: 'mpesa',
                        payment_reference: 'INHOUSE-' + mpesaCode.toUpperCase(),
                        payment_status: 'pending',
                        comments: finalComments || null
                    };

                    const { data: newOrder, error: orderError } = await supabase
                        .from('orders')
                        .insert(orderData)
                        .select()
                        .single();

                    if (orderError) {
                        console.error(' Failed to create order:', orderError);
                        throw new Error(`Failed to create order: ${orderError.message}`);
                    }

                    console.log(` Successfully created order ${newOrder.id} with ${itemsArray.length} items stored in JSONB column`);
                    console.log(' Order items:', itemsArray);

                    alert(` Order submitted successfully!\n\nItems: ${inhouseOrderCart.length}\nTotal: KES ${totalPrice.toLocaleString()}\nM-Pesa Code: ${mpesaCode.toUpperCase()}\n\nOrder will be processed after payment verification.`);
                    
                    // Reset form
                    form.reset();
                    inhouseOrderCart = [];
                    inhouseCurrentProduct = null;
                    inhouseCurrentColor = null;
                    updateCartDisplay();
                    selectedProductDiv.classList.remove('active');
                    colorOptionsDiv.style.display = 'none';
                    customSizeInput.style.display = 'none';
                    deliveryLocationInput.style.display = 'none';
                    storeLocationMessage.style.display = 'none';
                    if (inhouseMarker) {
                        inhouseMap.removeLayer(inhouseMarker);
                        inhouseMarker = null;
                    }
                    inhouseSelectedLocation = { lat: null, lng: null, displayName: null };
                } catch (error) {
                    console.error('Error submitting order:', error);
                    alert(` Failed to submit order: ${error.message}`);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });

            // Input validation
            const countryCodeField = document.getElementById('inhouse-dash-countryCode');
            const phoneNumberField = document.getElementById('inhouse-dash-phoneNumber');
            const nameField = document.getElementById('inhouse-dash-name');

            // Country code - auto-add + prefix
            if (countryCodeField) {
                countryCodeField.addEventListener('input', function() {
                    let value = this.value.replace(/[^0-9]/g, '');
                    if (value && !this.value.startsWith('+')) {
                        this.value = '+' + value;
                    } else if (!value) {
                        this.value = '+';
                    } else {
                        this.value = '+' + value;
                    }
                });
                countryCodeField.addEventListener('focus', function() {
                    if (!this.value) this.value = '+';
                });
                if (!countryCodeField.value) countryCodeField.value = '+';
            }

            // Phone number - only digits
            if (phoneNumberField) {
                phoneNumberField.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }

            // Name - only letters, spaces, hyphens, apostrophes
            if (nameField) {
                nameField.addEventListener('input', function() {
                    this.value = this.value.replace(/[^a-zA-Z\s\-'\.]/g, '');
                });
            }

            // Custom size fields - allow numbers and decimals (e.g., 35 or 35.5)
            ['inhouse-dash-customBust', 'inhouse-dash-customWaist', 'inhouse-dash-customHips'].forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    // Track the last valid value to detect when user is typing
                    let lastValidValue = '';
                    
                    field.addEventListener('input', function(e) {
                        // Save cursor position before any changes
                        const cursorPos = this.selectionStart || 0;
                        const oldValue = this.value;
                        
                        // Allow digits and decimal point, ensure only one decimal point
                        let value = this.value.replace(/[^0-9.]/g, '');
                        // Ensure only one decimal point
                        const parts = value.split('.');
                        if (parts.length > 2) {
                            value = parts[0] + '.' + parts.slice(1).join('');
                        }
                        
                        // Calculate cursor position adjustment
                        let newCursorPos = cursorPos;
                        
                        // If value changed, adjust cursor position
                        if (value !== oldValue) {
                            // Count valid characters before cursor in old value
                            const validBeforeOld = oldValue.substring(0, cursorPos).replace(/[^0-9.]/g, '').length;
                            
                            // Find corresponding position in new value
                            let validCount = 0;
                            newCursorPos = 0;
                            for (let i = 0; i < value.length; i++) {
                                if (/[0-9.]/.test(value[i])) {
                                    if (validCount < validBeforeOld) {
                                        validCount++;
                                        newCursorPos = i + 1;
                                    } else {
                                        break;
                                    }
                                }
                            }
                            
                            // If we removed characters, cursor might need to move back
                            if (value.length < oldValue.length) {
                                // Find the position that maintains the same number of valid chars before cursor
                                newCursorPos = Math.min(newCursorPos, value.length);
                            }
                            
                            this.value = value;
                            lastValidValue = value;
                            
                            // Restore cursor position
                            requestAnimationFrame(() => {
                                this.setSelectionRange(newCursorPos, newCursorPos);
                            });
                        } else {
                            // Value didn't change, but cursor might have been reset by browser
                            // Only restore if cursor is at end and it shouldn't be
                            if (cursorPos < oldValue.length && this.selectionStart === value.length) {
                                requestAnimationFrame(() => {
                                    this.setSelectionRange(cursorPos, cursorPos);
                                });
                            }
                            lastValidValue = value;
                        }
                    });
                }
            });
            
            // Height field - allow manual typing of digits and apostrophe
            const heightField = document.getElementById('inhouse-dash-customHeight');
            if (heightField) {
                heightField.addEventListener('input', function(e) {
                    // Only allow digits and apostrophe - remove everything else
                    this.value = this.value.replace(/[^0-9']/g, '');
                });
                
                heightField.addEventListener('keypress', function(e) {
                    // Allow digits, apostrophe, and navigation keys
                    const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'];
                    if (!/[0-9']/.test(e.key) && !allowedKeys.includes(e.key)) {
                        e.preventDefault();
                    }
                });
            }

            // Initialize
            await loadInhouseProducts();
            setupInhouseProductsRealtime();

            // Close search on outside click
            document.addEventListener('click', (e) => {
                if (!productSearch.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.remove('active');
                }
            });
        }

        const observer = new MutationObserver(() => {
            showInstallPromptImmediately();
        });

        // Observe changes to the login and dashboard pages
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const adminDashboardPage = document.getElementById('admin-dashboard-page');
        
        if (loginPage) {
            observer.observe(loginPage, { attributes: true, attributeFilter: ['class'] });
        }
        if (dashboardPage) {
            observer.observe(dashboardPage, { attributes: true, attributeFilter: ['class'] });
        }
        if (adminDashboardPage) {
            observer.observe(adminDashboardPage, { attributes: true, attributeFilter: ['class'] });
        }
    </script>
</body>
</html>